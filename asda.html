<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Time Owner</title>
<link rel="icon" type="image/png" href="pictures/favicon.png">

<meta name="theme-color" content="#0099ff">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://unpkg.com/drag-drop-touch"></script>
<style>
/* --- –û–ë–©–ò–ï –£–õ–£–ß–®–ï–ù–ù–´–ï –°–¢–ò–õ–ò --- */
:root {
    --bg-main: #121212;
    --bg-secondary: #1e1e1e;
    --bg-tertiary: #2a2a2a;
    --bg-hover: #333333;
    --border-color: #383838;
    --text-primary: #e0e0e0;
    --text-secondary: #a0a0a0;
    --accent-color: #007bff;
    --accent-hover: #0056b3;
    --danger-color: #e53935;
    --success-color: #4CAF50;
    --warning-color: #FFC107;
    /* --- –ù–û–í–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï –î–õ–Ø –†–ï–î–ò–ó–ê–ô–ù–ê --- */
    --header-height: 60px;
}
* {
    box-sizing: border-box;
}

/* --- –ö–†–ê–°–ò–í–´–ï –°–¢–ò–õ–ò –ü–†–û–ö–†–£–¢–ö–ò (–°–ö–†–û–õ–õ–ë–ê–†–´) --- */
::-webkit-scrollbar {
    width: 10px; 
    height: 10px; 
}
::-webkit-scrollbar-track {
    background: var(--bg-secondary);
}
::-webkit-scrollbar-thumb {
    background: var(--accent-color); 
    border-radius: 5px;
}
::-webkit-scrollbar-thumb:hover {
    background: var(--accent-hover);
}
* {
  scrollbar-color: var(--accent-color) var(--bg-secondary); 
  scrollbar-width: thin;
}

/* --- –ê–ù–ò–ú–ê–¶–ò–Ø –ü–û–Ø–í–õ–ï–ù–ò–Ø –°–¢–†–ê–ù–ò–¶–´ --- */
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

body {
    margin: 0;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji";
    background: var(--bg-main);
    color: var(--text-primary);
    display: flex;
    flex-direction: column;
    min-height: 100vh;
    overflow-x: hidden; 
    animation: fadeIn 0.5s ease-in-out;
}
.banner{width:100%;display:flex;justify-content:center;overflow:hidden;}
.banner img{width:100%;height:auto;max-height: 400px; object-fit:cover;display:block;}

/* --- –û–°–ù–û–í–ù–ê–Ø –°–¢–†–£–ö–¢–£–†–ê --- */
.main-container{
    display:flex;
    padding: 0 10px;
    overflow-x: hidden; 
    transition: padding 0.3s ease; 
}
.goals{
    width:240px;
    background:var(--bg-secondary);
    /* border-right:1px solid var(--border-color); -- –ò–ó–ú–ï–ù–ï–ù–û –í media-query */
    padding:20px;
    display:flex;
    flex-direction:column;
    gap: 15px; 
    overflow-y: auto; 
    position:relative; 
    flex-shrink: 0;
    position: sticky;
    top: 20px; /* –û—Ç—Å—Ç—É–ø –ø—Ä–∏ –ø—Ä–∏–ª–∏–ø–∞–Ω–∏–∏ */
    max-height: calc(100vh - 40px); /* –ú–∞–∫—Å. –≤—ã—Å–æ—Ç–∞ = –≤—ã—Å–æ—Ç–∞ —ç–∫—Ä–∞–Ω–∞ –º–∏–Ω—É—Å –æ—Ç—Å—Ç—É–ø—ã */
}
.right{
    flex:1;
    display:flex;
    flex-direction:column;
    padding:20px;
    gap:15px;
    overflow: hidden; 
}

/* --- –≠–õ–ï–ú–ï–ù–¢–´ –ò–ù–¢–ï–†–§–ï–ô–°–ê --- */
.btn{
    background:var(--bg-tertiary);border:1px solid var(--border-color);color:var(--text-primary);padding:10px 15px;border-radius:8px;cursor:pointer;font-weight: 600; 
    transition: background-color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
    display: flex; /* –î–ª—è –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è –∏–∫–æ–Ω–∫–∏ –∏ —Ç–µ–∫—Å—Ç–∞ */
    align-items: center;
    justify-content: center;
    gap: 8px;
}
.btn:hover{
    background-color: var(--bg-hover);
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}
.btn:active { transform: scale(0.98) translateY(0); } 
.btn-primary{background:var(--accent-color);border-color: var(--accent-color);color: #fff;}
.btn-primary:hover{background:var(--accent-hover);border-color: var(--accent-hover);}

/* --- –ö–ù–û–ü–ö–ò –£–ü–†–ê–í–õ–ï–ù–ò–Ø (–ë–õ–û–ö –†–ï–î–ò–ó–ê–ô–ù–ê) --- */
.top-controls {
    /* (–ë—ã–ª–æ: position: fixed) */
    position: relative; 
    display: grid; /* --- –ò–ó–ú–ï–ù–ï–ù–û: grid --- */
    grid-template-columns: 240px 1fr auto; /* --- –ò–ó–ú–ï–ù–ï–ù–û: 3 –∫–æ–ª–æ–Ω–∫–∏ (auto –¥–ª—è —Ü–µ–ª–µ–π) --- */
    align-items: center;
    gap: 10px; 
    z-index: 10000;
    /* --- –ù–û–í–´–ï –°–¢–ò–õ–ò –î–õ–Ø –®–ê–ü–ö–ò --- */
    width: 100%;
    padding: 10px 20px;
    background: var(--bg-secondary);
    border-bottom: 1px solid var(--border-color);
    height: auto; /* --- –ò–ó–ú–ï–ù–ï–ù–û: auto –¥–ª—è –∫–æ–ª–æ–Ω–∫–∏ --- */
    min-height: var(--header-height);
}
.top-controls-left {
    display: flex;
    align-items: stretch; /* --- –ò–ó–ú–ï–ù–ï–ù–û: stretch --- */
    gap: 8px; /* --- –ò–ó–ú–ï–ù–ï–ù–û: 8px --- */
    flex-direction: column; /* --- –ò–ó–ú–ï–ù–ï–ù–û: column --- */
}
/* --- –ù–û–í–´–ô –°–¢–ò–õ–¨: –†–∞—Å—Ç—è–≥–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –≤ –ª–µ–≤–æ–π –∫–æ–ª–æ–Ω–∫–µ --- */
.top-controls-left .btn,
.top-controls-left .header-btn,
.top-controls-left .account-control-btn,
.top-controls-left .trash-popover-container {
    width: 100%;
}
.top-controls-right {
    display: flex; /* --- –ò–ó–ú–ï–ù–ï–ù–û: –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∞–≤—ã–π –±–ª–æ–∫ --- */
    padding-right: 10px;
    align-items: center;
}

.top-controls-center {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 1.6em; /* --- –ò–ó–ú–ï–ù–ï–ù–û: –ø–æ–±–æ–ª—å—à–µ --- */
    font-weight: bold;
    color: var(--accent-color);
    justify-self: center; /* --- –ò–ó–ú–ï–ù–ï–ù–û: grid centering --- */
}
.top-controls-center img {
    height: 40px; /* --- –ò–ó–ú–ï–ù–ï–ù–û: –ø–æ–±–æ–ª—å—à–µ --- */
    width: 40px; /* --- –ò–ó–ú–ï–ù–ï–ù–û: –ø–æ–±–æ–ª—å—à–µ --- */
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –≤ —à–∞–ø–∫–µ */
.header-btn, .save-all-btn, .account-control-btn {
    background: var(--bg-tertiary);
    color: var(--text-primary);
    padding: 8px 15px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 600;
    transition: background 0.2s, color 0.2s, transform 0.2s, box-shadow 0.2s ease; 
    border: 1px solid var(--border-color);
    display: flex;
    align-items: center;
    gap: 8px;
    text-decoration: none; /* –î–ª—è —Å—Å—ã–ª–∫–∏-–∫–Ω–æ–ø–∫–∏ */
}
.save-all-btn:hover {
    background: var(--success-color);
    border-color: var(--success-color);
    color: #fff;
    transform: translateY(-2px);
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}
.account-control-btn:hover, .header-btn:hover {
    background: var(--accent-color);
    color: #fff;
    transform: translateY(-2px);
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}
.account-control-btn img, .save-all-btn img, .header-btn img {
    transition: filter 0.2s;
}
.account-control-btn:hover img, .save-all-btn:hover img, .header-btn:hover img {
    filter: invert(10%);
}
.save-all-btn.unsaved {
    border-color: var(--warning-color);
    box-shadow: 0 0 8px rgba(255, 193, 7, 0.5);
    animation: pulse 1.5s infinite;
}
@keyframes pulse {
    0% { box-shadow: 0 0 5px rgba(255, 193, 7, 0.4); }
    50% { box-shadow: 0 0 12px rgba(255, 193, 7, 0.8); }
    100% { box-shadow: 0 0 5px rgba(255, 193, 7, 0.4); }
}

/* --- –¶–ï–õ–ò (Goal Styles) --- */
.goals h2 { margin-top: 0; color: var(--accent-color); border-bottom: 2px solid var(--border-color); padding-bottom: 10px;}
#goalsList {
    /* –°—Ç–∏–ª–∏ –¥–ª—è #goalsList –±—É–¥—É—Ç –≤ media-query */
}
.goal{
    background:var(--bg-tertiary);
    border-radius:8px;
    padding:10px;
    position:relative;
    transition: background-color 0.2s, box-shadow 0.2s, transform 0.2s ease;
    min-height: 40px;
    border-left: 6px solid var(--success-color); 
    font-size: 16px; 
}
.goal:hover{
    background:var(--bg-hover);
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 123, 255, 0.2); 
}
.goal .goal-remove{
    position:absolute;right:8px;top:50%;transform: translateY(-50%);opacity:0;cursor:pointer;color:var(--danger-color);font-size: 20px;
    transition: opacity 0.2s, transform 0.2s; 
}
.goal .goal-remove:hover { transform: translateY(-50%) scale(1.2); }
.goal:hover .goal-remove{opacity:1;}
.goal[contenteditable]:focus{
    outline:2px solid var(--accent-color);
    background: var(--bg-secondary);
    box-shadow: 0 0 8px rgba(0, 123, 255, 0.5);
}
.add-goal-btn{
    position:absolute;
    left:50%;
    transform:translateX(-50%);
    bottom:15px;
    background:#555;
    color:var(--text-primary);
    width:40px;height:40px;
    border-radius:50%;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:24px;
    cursor:pointer;
    display:none; 
    transition: background-color 0.2s, transform 0.2s ease-out; 
}
.goals:hover .add-goal-btn{display:flex}
.add-goal-btn:hover { 
    background-color: var(--accent-color); 
    transform: translateX(-50%) translateY(-5px) scale(1.05); 
}

/* --- –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û: –û–ë–©–ò–ï –°–¢–ò–õ–ò --- */
.modal{
    position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);backdrop-filter: blur(5px);
    /* –ò–ó–ú–ï–ù–ï–ù–û: z-index –ø–æ–≤—ã—à–µ–Ω, —á—Ç–æ–±—ã –±—ã—Ç—å –≤—ã—à–µ —à–∞–ø–∫–∏ (z-index: 10000) */
    z-index:100000; 
    display:none;align-items: center; justify-content: center;
    opacity: 0; 
    transition: opacity 0.3s ease;
}
.modal.visible { opacity: 1; } 
.modal-content {
    background: var(--bg-main);
    width: 95%;
    border-radius: 12px;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    border: 1px solid var(--border-color);
    transform: scale(0.95); 
    transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    max-height: 90vh; /* –î–û–ë–ê–í–õ–ï–ù–û –ò–ó –ö–ê–õ–ï–ù–î–ê–†–Ø */
}
.modal.visible .modal-content { transform: scale(1); } 

.modal-header{
    display:flex;justify-content:space-between;align-items:center;padding:15px 20px;
    background:var(--bg-secondary);border-bottom:1px solid var(--border-color);
    flex-shrink: 0;
}
.modal-header h2 { /* –°–¢–ò–õ–¨ –ò–ó –ö–ê–õ–ï–ù–î–ê–†–Ø */
    margin: 0;
    font-size: 1.2em;
    color: var(--accent-color);
}
.modal-header .actions{display:flex;justify-content:flex-end;align-items:center;gap:15px;position:relative;}
.modal-header span{cursor:pointer;font-size:24px;position:relative; color: var(--text-secondary); transition: color 0.2s;}
.modal-header span:hover { color: var(--accent-color); }

.modal-body{ /* –°–¢–ò–õ–¨ –ò–ó –ö–ê–õ–ï–ù–î–ê–†–Ø */
    padding: 20px;
    overflow-y: auto;
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    gap: 15px;
}
.modal-footer { /* –°–¢–ò–õ–¨ –ò–ó –ö–ê–õ–ï–ù–î–ê–†–Ø */
    padding: 15px 20px; 
    border-top: 1px solid var(--border-color); 
    background: var(--bg-secondary);
    flex-shrink: 0;
}

/* --- –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –õ–ö --- */
.small-modal-content {
    max-width: 450px;
    height: auto;
    max-height: 90vh;
    padding: 20px;
    gap: 15px;
}

/* --- –°–¢–ò–õ–ò –î–õ–Ø –ö–ù–û–ü–ö–ò –í –ù–ò–ñ–ù–ï–ú –õ–ï–í–û–ú –£–ì–õ–£ (AI –°–æ–≤–µ—Ç) --- */
#aiButtonContainer {
    position: fixed;
    bottom: 20px; 
    left: 20px; 
    z-index: 9999; 
}
#aiButtonContainer .btn {
    background: #39556d; 
    border-color: #39556d; 
    color: #fff;
    padding: 12px 20px;
    font-size: 16px;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
}
#aiButtonContainer .btn:hover {
    background: #476a8a;
    border-color: #476a8a;
}
@media (max-width: 768px) {
    #aiButtonContainer {
        bottom: 15px;
        left: 15px;
    }
    #aiButtonContainer .btn {
        padding: 10px 15px;
        font-size: 14px;
    }
}

/* --- –°–¢–ò–õ–ò –î–õ–Ø –¢–†–ï–ö–ï–†–ê –ü–†–ò–í–´–ß–ï–ö --- */
.habit-tracker{background:var(--bg-secondary);padding:25px 20px; margin-bottom: 20px;}
.habit-tracker h2 { margin-top: 0; color: var(--success-color); }
.habit-controls{display:flex;gap:10px;margin-bottom:20px;align-items:center; flex-wrap: wrap;}
.habit-controls input{flex:1;background:var(--bg-tertiary);border:1px solid var(--border-color);color:var(--text-primary);padding:10px 12px;border-radius:8px; min-width: 200px;}
.habit-table-wrapper { overflow-x: auto; }
.habit-table{width:100%;border-collapse:collapse;table-layout:fixed; min-width: 600px;}
.habit-table th, .habit-table td{border:1px solid var(--border-color);padding:10px;text-align:center; transition: background-color 0.2s;}
.habit-table th{background:var(--bg-tertiary);font-weight:600; position: sticky; top: 0;}
.habit-table td:first-child, .habit-table th:first-child { text-align:left;font-weight:bold; width: 100px; position: sticky; left: 0; background: var(--bg-tertiary); }
.habit-table tr:hover td { background-color: var(--bg-hover); }
.habit-table input[type="checkbox"]{width:20px;height:20px;cursor:pointer; accent-color: var(--success-color); transform: scale(1.1); transition: transform 0.1s;} 
.habit-table input[type="checkbox"]:hover { transform: scale(1.2); }
.progress-col { width: 150px; }
.progress-bar-container { width: 100%; height: 22px; background-color: var(--bg-tertiary); border-radius: 5px; position: relative; overflow: hidden; display: flex; align-items: center; justify-content: center; border: 1px solid var(--border-color);}
.progress-bar { position: absolute; left: 0; top: 0; height: 100%; background-color: var(--success-color); border-radius: 5px; transition: width 0.4s cubic-bezier(0.25, 1, 0.5, 1); }
.progress-bar-text { position: relative; z-index: 1; font-size: 12px; font-weight: bold; color: #fff; text-shadow: 1px 1px 1px rgba(0,0,0,0.5); }
.habit-table th { position: relative; }
.habit-header-content { display: flex; justify-content: space-between; align-items: center; gap: 5px; }
.habit-header-content span[contenteditable] { flex-grow: 1; text-align: left; }
.remove-habit {
    color: var(--danger-color); font-size: 18px; font-weight: bold; cursor: pointer; line-height: 1;
    opacity: 0.5; transition: opacity 0.2s, transform 0.2s; flex-shrink: 0;
}
.remove-habit:hover { opacity: 1; transform: rotate(90deg); }
.habit-table-container { overflow: hidden; position: relative; transition: max-height 0.5s ease-out; max-height: 500px; }
.habit-table-container.collapsed { max-height: 250px; }
.toggle-history-btn { width: 100%; text-align: center; background: var(--bg-tertiary); color: var(--accent-color); padding: 10px; border: 1px solid var(--border-color); border-top: none; cursor: pointer; font-weight: 600; transition: background 0.2s; border-radius: 0 0 8px 8px; }
.toggle-history-btn:hover { background: var(--bg-hover); }

/* --- –°–¢–ò–õ–ò –î–õ–Ø –¢–†–ï–ö–ï–†–ê –ù–ê–°–¢–†–û–ï–ù–ò–Ø --- */
.mood-tracker { background: var(--bg-secondary); padding: 25px 20px; }
.mood-tracker h2 { margin-top: 0; color: var(--warning-color); border-bottom: 2px solid var(--border-color); padding-bottom: 10px; margin-bottom: 15px;}
.mood-selection { display: flex; gap: 15px; justify-content: center; align-items: center; margin-bottom: 25px; }
.mood-option { font-size: 40px; cursor: pointer; transition: transform 0.2s, opacity 0.2s, text-shadow 0.2s; opacity: 0.6; }
.mood-option:hover { transform: scale(1.15) rotate(-5deg); opacity: 1; }
.mood-option.selected { opacity: 1; transform: scale(1.25); text-shadow: 0 0 15px var(--warning-color); }
.mood-history-controls { display: flex; justify-content: center; gap: 10px; margin-bottom: 15px; }
.mood-calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; text-align: center; background: var(--bg-tertiary); padding: 10px; border-radius: 8px; }
.mood-calendar-day { padding: 8px 0; font-size: 14px; font-weight: 600; color: var(--text-secondary); }
.mood-calendar-cell { padding: 5px 0; background: var(--bg-secondary); border-radius: 4px; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 40px; cursor: default; transition: transform 0.2s; }
.mood-calendar-cell:hover { transform: scale(1.05); }
.mood-calendar-cell.has-data { cursor: pointer; }
.mood-calendar-cell.empty { background: var(--bg-main); cursor: default; }
.day-number { font-size: 12px; color: var(--text-secondary); }
.day-mood { font-size: 18px; margin-top: 2px; }
.current-month-select { background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-color); padding: 5px 10px; border-radius: 6px; cursor: pointer; }

/* --- –°–¢–ò–õ–ò –î–õ–Ø –õ–ò–ß–ù–û–ì–û –ö–ê–ë–ò–ù–ï–¢–ê --- */
.profile-section { display: flex; flex-direction: column; gap: 15px; padding: 15px; border: 1px solid var(--border-color); border-radius: 8px; }
.profile-section h3 { margin: 0; color: var(--accent-color); font-size: 1.1em; border-bottom: 1px dashed var(--border-color); padding-bottom: 5px; }
.profile-input-group { display: flex; gap: 10px; align-items: center; }
.profile-input-group input { flex: 1; background: var(--bg-tertiary); border: 1px solid var(--border-color); color: var(--text-primary); padding: 8px 12px; border-radius: 6px; }
.btn-save-nick { background: var(--success-color); border-color: var(--success-color); }
.btn-save-nick:hover { background: #3e8e41; }
.btn-logout { background: var(--bg-tertiary); border-color: var(--border-color); }
.btn-logout:hover { background: var(--bg-hover); }
.btn-delete { background: var(--danger-color); border-color: var(--danger-color); }
.btn-delete:hover { background: #c32727; }

/* --- –°–¢–ò–õ–ò –î–õ–Ø –ê–ù–ò–ú–ê–¶–ò–ò –ó–ê–ì–†–£–ó–ö–ò --- */
#loadingOverlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); display: none; 
    flex-direction: column; justify-content: center; align-items: center; color: var(--text-primary); font-size: 1.2em;
    z-index: 100001; opacity: 0; transition: opacity 0.3s ease;
}
.spinner { border: 4px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top: 4px solid var(--accent-color); width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 15px; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

/* --- –ö–û–ù–¢–ï–ô–ù–ï–† –£–í–ï–î–û–ú–õ–ï–ù–ò–ô --- */
#notification-container {
    position: fixed;
    top: 80px; /* –ù–∏–∂–µ —à–∞–ø–∫–∏ */
    right: 20px;
    z-index: 100001; /* –í—ã—à–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω, –Ω–æ –Ω–∏–∂–µ AI */
    display: flex;
    flex-direction: column;
    gap: 10px;
}
.custom-notification {
    background: var(--bg-tertiary);
    color: var(--text-primary);
    border: 1px solid var(--border-color);
    border-left: 5px solid var(--warning-color);
    border-radius: 8px;
    padding: 15px 20px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 15px;
    width: 350px;
    max-width: 90vw;
    opacity: 0;
    transform: translateX(100%);
    transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}
.custom-notification.show {
    opacity: 1;
    transform: translateX(0);
}
.custom-notification.success {
    border-left-color: var(--success-color);
}
.custom-notification.error {
    border-left-color: var(--danger-color);
}
.custom-notification p {
    margin: 0;
    line-height: 1.4;
    word-break: break-word;
}
.custom-notification .close-btn {
    font-size: 24px;
    color: var(--text-secondary);
    cursor: pointer;
    background: none;
    border: none;
    padding: 0 5px;
    line-height: 1;
}
.custom-notification .close-btn:hover {
    color: var(--text-primary);
}


/* --- –ë–û–ö–û–í–û–ï –û–ö–ù–û AI-–°–û–í–ï–¢–ê (DRAWER) --- */
.advice-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.7); 
    display: none;
    z-index: 10000000000;
    opacity: 0;
    transition: opacity 0.3s ease;
}
.advice-modal-overlay.visible {
    display: block;
    opacity: 1;
}
.advice-modal-drawer {
    position: fixed;
    top: 0;
    right: 0; 
    width: 400px; 
    max-width: 90%; 
    height: 100%;
    background-color: var(--bg-secondary);
    box-shadow: -6px 0 15px rgba(0, 0, 0, 0.4);
    z-index: 100100000000;
    display: flex;
    flex-direction: column;
    transform: translateX(100%); 
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}
.advice-modal-overlay.visible .advice-modal-drawer {
    transform: translateX(0);
}
.advice-drawer-header {
    padding: 15px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid var(--border-color);
    background: var(--bg-tertiary);
}
.advice-drawer-header h2 {
    margin: 0;
    color: var(--accent-color);
    font-size: 1.3em;
}
.advice-drawer-close {
    background: none;
    border: none;
    font-size: 30px;
    cursor: pointer;
    color: var(--text-secondary);
    line-height: 1;
    transition: color 0.2s;
}
.advice-drawer-close:hover {
    color: var(--danger-color);
}
.advice-drawer-content {
    padding: 20px;
    flex-grow: 1;
    overflow-y: auto; 
}
.advice-drawer-content p {
    white-space: pre-wrap;
    line-height: 1.7;
    font-size: 15px;
    color: var(--text-primary);
    padding-right: 5px; 
}
.advice-drawer-content h3 {
    font-size: 1.4em;
    font-weight: 700;
    color: var(--accent-color); 
    margin-top: 25px;
    margin-bottom: 10px;
    padding-bottom: 5px;
    border-bottom: 2px solid var(--border-color);
}
.advice-drawer-content ul {
    list-style: none; 
    padding-left: 0;
    margin-top: 0;
}
.advice-drawer-content li {
    margin-bottom: 8px;
    line-height: 1.5;
    padding-left: 18px; 
    position: relative;
}
.advice-drawer-content li::before {
    content: '‚Ä¢';
    color: var(--warning-color); 
    font-weight: bold;
    display: inline-block;
    width: 1em;
    margin-left: -1em;
    position: absolute;
    left: 0;
}
.advice-drawer-content strong {
    color: var(--text-primary);
    font-weight: 600;
}
/* --- –°–¢–ò–õ–ò –î–õ–Ø –ö–ù–û–ü–ö–ò –ë–ê–ó–´ –ó–ù–ê–ù–ò–ô --- */
.knowledge-base-btn {
    color: #fff;
    border: none;
    text-decoration: none; 
    background: linear-gradient(45deg, #007bff, #6f42c1, #d63384);
    background-size: 200% 200%;
    animation: gradient-animation 5s ease infinite;
}
.knowledge-base-btn:hover {
    color: #fff;
    box-shadow: 0 0 15px rgba(111, 66, 193, 0.7);
}
@keyframes gradient-animation {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
}
    /* –û—Å–Ω–æ–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ —Ñ—É—Ç–µ—Ä–∞ */
#main-footer {
    position: relative; 
    width: 100%;
    min-height: 200px; 
    background-color: #333; 
    color: #fff;
    padding: 20px 0;
    overflow: hidden; 
}
#particles-js {
    position: absolute; 
    width: 100%;
    height: 100%;
    top: 0;
    left: 0;
    z-index: 1; 
}
.footer-content {
    position: relative;
    text-align: center;
    padding-top: 50px; 
    z-index: 2; 
}
.footer-content p {
    margin: 0;
    font-size: 14px;
}

/* --- –°–¢–ò–õ–ò –î–õ–Ø –ù–ò–ñ–ù–ï–ô –ú–û–ë–ò–õ–¨–ù–û–ô –ù–ê–í–ò–ì–ê–¶–ò–ò --- */
.mobile-bottom-nav {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    background: var(--bg-secondary);
    border-top: 1px solid var(--border-color);
    display: none; /* –°–∫—Ä—ã—Ç–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
    justify-content: space-around;
    align-items: flex-start; 
    padding: 6px 0 8px 0;
    z-index: 10003; 
    box-shadow: 0 -2px 10px rgba(0,0,0,0.3);
}
.mobile-nav-btn {
    background: none;
    border: none;
    color: var(--text-secondary);
    font-size: 10px;
    font-family: inherit;
    display: flex;
    flex-direction: column;
    align-items: center;
    flex: 1;
    padding: 4px;
    cursor: pointer;
    transition: color 0.2s;
    text-align: center;
}
.mobile-nav-btn .icon {
    font-size: 20px;
    margin-bottom: 3px;
    line-height: 1;
}
.mobile-nav-btn .label {
    line-height: 1.2;
}
.mobile-nav-btn:hover {
    color: var(--text-primary);
}
/* –ù–û–í–´–ô –°–¢–ò–õ–¨: –ê–∫—Ç–∏–≤–Ω–∞—è –∫–Ω–æ–ø–∫–∞-–≤–∫–ª–∞–¥–∫–∞ */
.mobile-nav-btn.active {
    color: var(--accent-color);
    font-weight: 600;
}

.mobile-nav-btn#mobileNavSave.unsaved {
    color: var(--warning-color);
    animation: pulse-mobile 1.5s infinite;
}
.mobile-nav-btn#mobileNavSave.unsaved .icon {
    animation: pulse-icon 1.5s infinite;
}
@keyframes pulse-mobile {
    0% { color: var(--warning-color); }
    50% { color: var(--text-primary); }
    100% { color: var(--warning-color); }
}
@keyframes pulse-icon {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
}


/* ---
--- –ù–û–í–´–ï –°–¢–ò–õ–ò –î–õ–Ø –ö–ê–õ–ï–ù–î–ê–†–Ø ---
--- */

/* --- –ù–û–í–´–ï –°–¢–ò–õ–ò –î–õ–Ø –ö–ê–õ–ï–ù–î–ê–†–Ø ---
--- */

.calendar-wrapper {
¬† ¬† width: 95%; /* –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —à–∏—Ä–∏–Ω–∞ –º–µ–Ω—å—à–µ 100% –¥–ª—è —Ä–∞–±–æ—Ç—ã margin: auto */
¬† ¬† max-width: 1400px;
¬† ¬† margin: 20px auto; /* <--- –ì–õ–ê–í–ù–û–ï –î–õ–Ø –¶–ï–ù–¢–†–ò–†–û–í–ê–ù–ò–Ø */
¬† ¬† padding: 20px;
¬† ¬† background: var(--bg-secondary);
¬† ¬† border-radius: 12px;
¬† ¬† border: 1px solid var(--border-color);
}

.calendar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 1px solid var(--border-color);
}

.calendar-nav {
    display: flex;
    align-items: center;
    gap: 10px;
}
.calendar-nav .nav-btn {
    font-size: 20px;
    padding: 5px 12px;
}
#current-month-display {
    font-size: 1.5em;
    font-weight: 600;
    color: var(--accent-color);
    text-align: center;
    min-width: 200px;
}

.view-toggle {
    display: flex;
    gap: 10px;
}
.view-toggle .btn {
    background: var(--bg-tertiary);
}
.view-toggle .btn.active {
    background: var(--accent-color);
    color: #fff;
    box-shadow: 0 0 8px rgba(0, 123, 255, 0.5);
}

/* --- –°—Ç–∏–ª–∏ –¥–ª—è –≤–∏–¥–∞ "–ú–µ—Å—è—Ü" --- */
#month-view {
    display: block; /* –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é */
}
.calendar-weekdays {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 5px;
    margin-bottom: 10px;
}
.weekday {
    text-align: center;
    font-weight: 600;
    color: var(--text-secondary);
    padding: 10px 0;
    font-size: 0.9em;
}
.calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 8px;
    min-height: 60vh;
}
.calendar-day {
    background: var(--bg-main);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 8px;
    min-height: 120px;
    cursor: pointer;
    transition: background-color 0.2s, border-color 0.2s;
    display: flex;
    flex-direction: column;
    gap: 5px;
}
.calendar-day:hover {
    background: var(--bg-hover);
    border-color: var(--accent-color);
}
.calendar-day.other-month {
    background: transparent;
    opacity: 0.4;
    cursor: default;
}
.calendar-day.other-month:hover {
    background: transparent;
    border-color: var(--border-color);
}
.calendar-day.today {
    border-color: var(--warning-color);
    box-shadow: 0 0 10px rgba(255, 193, 7, 0.3);
}
.day-number {
    font-weight: 600;
    font-size: 0.9em;
}
.tasks-preview {
    display: flex;
    /* –ò–ó–ú–ï–ù–ï–ù–û: –ó–∞–¥–∞—á–∏ —Ç–µ–ø–µ—Ä—å –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –≤ —Å—Ç—Ä–æ–∫—É –∏ –ø–µ—Ä–µ–Ω–æ—Å—è—Ç—Å—è */
    flex-direction: row;
    flex-wrap: wrap;
    gap: 4px;
    overflow: hidden;
}
.task-preview-item {
    font-size: 0.8em;
    padding: 2px 5px;
    background: var(--bg-tertiary);
    border-radius: 4px;
    /* –ò–ó–ú–ï–ù–ï–ù–û: –£–±—Ä–∞–Ω–æ –≤—Å–µ, —á—Ç–æ —Å–≤—è–∑–∞–Ω–æ —Å —Ç–µ–∫—Å—Ç–æ–º */
    display: inline-block;
    line-height: 1.2;
}
.task-preview-item.done {
    opacity: 0.5;
    text-decoration: line-through;
}
.task-preview-time {
    color: var(--accent-color);
    font-weight: 600;
}

/* --- –°—Ç–∏–ª–∏ –¥–ª—è –≤–∏–¥–∞ "–ù–µ–¥–µ–ª—è" --- */
#week-view {
    display: none; /* –°–∫—Ä—ã—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
}
.week-view-container {
    display: flex;
    gap: 10px;
    overflow-x: auto;
    padding-bottom: 15px;
    min-height: 60vh;
}
.week-day-column {
    flex: 1;
    min-width: 280px;
    max-width: 350px;
    background: var(--bg-main);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    display: flex;
    flex-direction: column;
}
.week-day-column.today {
    border-color: var(--warning-color);
    box-shadow: 0 0 10px rgba(255, 193, 7, 0.3);
}
.week-day-header {
    padding: 12px 15px;
    border-bottom: 1px solid var(--border-color);
    background: var(--bg-tertiary);
    border-radius: 8px 8px 0 0;
}
.week-day-header h3 {
    margin: 0;
    font-size: 1.1em;
}
.week-day-header .date-display {
    font-size: 0.9em;
    color: var(--text-secondary);
}
.task-list-week {
    display: flex;
    flex-direction: column;
    gap: 8px;
    padding: 10px;
    overflow-y: auto;
    flex-grow: 1;
}

/* –ò–ó–ú–ï–ù–ï–ù–û: –°—Ç–∏–ª–∏ –¥–ª—è —Ñ–æ—Ä–º—ã –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –Ω–µ–¥–µ–ª–µ */
.add-task-form-week {
    padding: 10px;
    border-top: 1px solid var(--border-color);
    display: flex;
    gap: 8px;
    align-items: flex-end; /* –ö–Ω–æ–ø–∫–∞ –ø—Ä–∏–∂–∏–º–∞–µ—Ç—Å—è –∫ –Ω–∏–∑—É */
}
.form-inputs-week {
    display: flex;
    flex-direction: column;
    gap: 5px;
    flex-grow: 1;
}
.add-task-form-week input {
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    color: var(--text-primary);
    padding: 8px 10px;
    border-radius: 6px;
    font-size: 14px;
    width: 100%; /* –ü–æ–ª—è –∑–∞–Ω–∏–º–∞—é—Ç –≤—Å—é —à–∏—Ä–∏–Ω—É –∫–æ–ª–æ–Ω–∫–∏ */
}
.add-task-form-week input[type="text"] {
    flex-grow: 1;
}
.add-task-form-week button {
    padding: 8px 10px;
    min-width: 40px;
    flex-shrink: 0; /* –ö–Ω–æ–ø–∫–∞ –Ω–µ —Å–∂–∏–º–∞–µ—Ç—Å—è */
}
.send-icon {
    width: 20px;
    height: 20px;
    fill: currentColor;
}

/* --- –°—Ç–∏–ª–∏ –¥–ª—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –∑–∞–¥–∞—á (–≤ –º–æ–¥–∞–ª–∫–µ –∏ –Ω–µ–¥–µ–ª–µ) --- */
#modal-task-list, .task-list-week {
    display: flex;
    flex-direction: column;
    gap: 10px;
}
.task-item {
    display: flex;
    align-items: center;
    gap: 10px;
    background: var(--bg-tertiary);
    padding: 10px;
    border-radius: 6px;
    border-left: 4px solid var(--border-color);
    position: relative; /* –î–û–ë–ê–í–õ–ï–ù–û: –î–ª—è –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –º–µ–Ω—é */
}
.task-item.done {
    border-left-color: var(--success-color);
    opacity: 0.7;
}
.task-item-checkbox {
    width: 18px;
    height: 18px;
    flex-shrink: 0;
    accent-color: var(--success-color);
    cursor: pointer;
}
.task-item-time {
    font-weight: 600;
    color: var(--accent-color);
    font-size: 0.9em;
    width: 50px;
    flex-shrink: 0;
}
.task-item-text {
    flex-grow: 1;
    word-break: break-word;
    font-size: 0.95em;
}
.task-item.done .task-item-text {
    text-decoration: line-through;
}

/* –î–û–ë–ê–í–õ–ï–ù–û: –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–ë–æ–ª—å—à–µ" (—Ç—Ä–∏ —Ç–æ—á–∫–∏) –∏ –º–µ–Ω—é */
.task-item-more {
    background: none;
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    font-size: 20px;
    padding: 0 5px;
    opacity: 0.6;
    transition: opacity 0.2s, color 0.2s;
    line-height: 1;
    font-weight: bold;
    flex-shrink: 0;
}
.task-item-more:hover {
    opacity: 1;
    color: var(--accent-color);
}
.task-item-menu {
    display: none;
    position: absolute;
    top: 30px; /* –ü–æ–¥ –∫–Ω–æ–ø–∫–æ–π */
    right: 5px;
    background: var(--bg-main);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    z-index: 100;
    width: 180px;
    padding: 5px;
    animation: fadeIn 0.1s ease-out;
}
.task-item-menu.visible {
    display: block;
}
.task-menu-item {
    padding: 8px 12px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.9em;
    transition: background-color 0.2s, color 0.2s;
    user-select: none;
}
.task-menu-item:hover {
    background-color: var(--bg-hover);
}
.task-menu-item[data-action="delete"]:hover {
    background-color: var(--danger-color);
    color: #fff;
}
/* ---------------------------------- */

.no-tasks {
    color: var(--text-secondary);
    text-align: center;
    padding: 20px;
}

/* --- –°—Ç–∏–ª–∏ –¥–ª—è —Ñ–æ—Ä–º—ã –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –º–æ–¥–∞–ª–∫–µ --- */
#add-task-form-modal {
    display: flex;
    gap: 10px;
}
#add-task-form-modal input {
    background: var(--bg-tertiary);
    border: 1px solid var(--border-color);
    color: var(--text-primary);
    padding: 10px 12px;
    border-radius: 6px;
    font-size: 15px;
}
#add-task-form-modal input:focus {
    outline: none;
    border-color: var(--accent-color);
    box-shadow: 0 0 8px rgba(0, 123, 255, 0.4);
}
#new-task-time {
    width: 100px;
}
#new-task-text {
    flex-grow: 1;
}
#add-task-btn {
    padding: 10px 12px;
    min-width: 44px;
}


/* –î–û–ë–ê–í–õ–ï–ù–û: –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª–∫–∏ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π */
.form-group {
    margin-bottom: 15px;
}
.form-group label, .recur-options p {
    display: block;
    margin-bottom: 5px;
    font-weight: 600;
    color: var(--text-secondary);
    font-size: 0.9em;
}
.form-control {
    width: 100%;
    background: var(--bg-tertiary);
    border: 1px solid var(--border-color);
    color: var(--text-primary);
    padding: 10px 12px;
    border-radius: 6px;
    font-size: 15px;
}
select.form-control {
    appearance: none;
    -webkit-appearance: none;
    background-image: url('data:image/svg+xml;utf8,<svg fill="%23a0a0a0" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/></svg>');
    background-repeat: no-repeat;
    background-position: right 10px center;
    padding-right: 40px;
}
.weekday-picker {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
}
.weekday-picker label {
    display: flex;
    align-items: center;
    gap: 5px;
    background: var(--bg-tertiary);
    padding: 8px 12px;
    border-radius: 6px;
    cursor: pointer;
    border: 1px solid var(--border-color);
    transition: background-color 0.2s, border-color 0.2s;
    font-size: 0.9em;
}
.weekday-picker input {
    accent-color: var(--accent-color);
}
.weekday-picker label:has(input:checked) {
     background: var(--accent-color);
     border-color: var(--accent-color);
     color: #fff;
}
/* ---------------------------------- */


/* --- 
--- –°–¢–ò–õ–ò –†–ï–î–ò–ó–ê–ô–ù–ê –î–õ–Ø –î–ï–°–ö–¢–û–ü–ê ---
--- */

@media (min-width: 769px) {
    .banner {
        display: none; /* –°–∫—Ä—ã–≤–∞–µ–º —Å—Ç–∞—Ä—ã–π –±–∞–Ω–Ω–µ—Ä */
    }

    /* –ò–ó–ú–ï–ù–ï–ù–û: –í—ã—Ä–∞–≤–Ω–∏–≤–∞–µ–º –∫–æ–ª–æ–Ω–∫–∏ —à–∞–ø–∫–∏ –ø–æ –≤–µ—Ä—Ö—É */
    .top-controls {
        align-items: start;
    }

    .main-container {
        padding: 0; /* –£–±–∏—Ä–∞–µ–º –æ—Ç—Å—Ç—É–ø—ã —É –≥–ª–∞–≤–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ */
    }

    /* --- –ò–ó–ú–ï–ù–ï–ù–û: –°—Ç–∏–ª–∏ –¥–ª—è —Ü–µ–ª–µ–π –≤ —à–∞–ø–∫–µ (—Ç–µ–ø–µ—Ä—å –∫–æ–ª–æ–Ω–∫–∞) --- */
    .goals {
        position: static; /* –£–±–∏—Ä–∞–µ–º sticky */
        width: 100%;
        height: auto;
        max-height: none;
        border: none; /* –£–±–∏—Ä–∞–µ–º —Ä–∞–º–∫–∏ */
        padding: 0;
        display: flex;
        flex-direction: column; /* –ò–ó–ú–ï–ù–ï–ù–û: –≤ –∫–æ–ª–æ–Ω–∫—É */
        align-items: stretch; /* –ò–ó–ú–ï–ù–ï–ù–û: —Ä–∞—Å—Ç—è–≥–∏–≤–∞–µ–º */
        gap: 10px; /* –û—Ç—Å—Ç—É–ø –º–µ–∂–¥—É —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏ */
        overflow: visible;
        background: transparent; /* –§–æ–Ω –Ω–∞—Å–ª–µ–¥—É–µ—Ç—Å—è –æ—Ç —à–∞–ø–∫–∏ */
    }
    .goals h2 {
        display: block; /* –ò–ó–ú–ï–ù–ï–ù–û: –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ */
        margin: 0;
        font-size: 16px;
        color: var(--accent-color);
        border: none;
        padding: 0;
    }
    #goalsList {
        display: flex;
        flex-direction: column; /* –ò–ó–ú–ï–ù–ï–ù–û: –≤ –∫–æ–ª–æ–Ω–∫—É */
        gap: 10px; /* –ò–ó–ú–ï–ù–ï–ù–û: –æ—Ç—Å—Ç—É–ø */
        align-items: stretch;
        flex: 1; /* –ó–∞–Ω–∏–º–∞–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ–µ –º–µ—Å—Ç–æ */
    }
    .goals .goal {
        font-size: 14px; /* –ò–ó–ú–ï–ù–ï–ù–û: —á—É—Ç—å –∫—Ä—É–ø–Ω–µ–µ */
        padding: 8px 10px; /* –ò–ó–ú–ï–ù–ï–ù–û: —á—É—Ç—å –∫—Ä—É–ø–Ω–µ–µ */
        margin: 0;
    }
    .add-goal-btn {
        position: static; /* –£–±–∏—Ä–∞–µ–º absolute */
        transform: none;
        width: 40px; /* –ò–ó–ú–ï–ù–ï–ù–û: –∫—Ä—É–ø–Ω–µ–µ */
        height: 40px; /* –ò–ó–ú–ï–ù–ï–ù–û: –∫—Ä—É–ø–Ω–µ–µ */
        font-size: 24px; /* –ò–ó–ú–ï–ù–ï–ù–û: –∫—Ä—É–ø–Ω–µ–µ */
        flex-shrink: 0;
        display: flex; /* –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–¥–æ–±–∞–≤–∏—Ç—å" –≤—Å–µ–≥–¥–∞ */
        align-self: center; /* –ò–ó–ú–ï–ù–ï–ù–û: —Ü–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É */
    }
    .goals:hover .add-goal-btn {
        display: flex;
        transform: none; /* –£–±–∏—Ä–∞–µ–º hover-—ç—Ñ—Ñ–µ–∫—Ç */
    }
    .add-goal-btn:hover {
        background-color: var(--accent-color); 
        transform: scale(1.05); /* –û—Å—Ç–∞–≤–ª—è–µ–º hover –Ω–∞ —Å–∞–º–æ–π –∫–Ω–æ–ø–∫–µ */
    }
    /* --- –ö–û–ù–ï–¶ –°–¢–ò–õ–ï–ô –î–õ–Ø –¶–ï–õ–ï–ô --- */


    /* .right - —ç—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è "–ö–∞–ª–µ–Ω–¥–∞—Ä—è" */
    .right {
        padding: 10px;
        gap: 10px;
    }

    /* --- –°—Ç–∏–ª–∏ –¥–ª—è .calendar-wrapper –≤–Ω—É—Ç—Ä–∏ .right --- */
    .right .calendar-wrapper {
        width: 100%;
        margin: 0;
        flex-grow: 1; /* –ó–∞–Ω–∏–º–∞–µ—Ç –≤—Å–µ –º–µ—Å—Ç–æ */
    }
}


/* --- –ê–î–ê–ü–¢–ò–í–ù–û–°–¢–¨ –î–õ–Ø –ú–û–ë–ò–õ–¨–ù–´–• –£–°–¢–†–û–ô–°–¢–í --- */
@media (max-width: 768px) {
    body { 
        font-size: 14px; 
        padding-bottom: 80px; 
    }
    .main-container { flex-direction: column; padding: 0; overflow-x: hidden; } 
    
    .mobile-section {
        display: none; 
    }
    .mobile-section.active {
        display: block; 
    }
    .mobile-section.goals.active {
        display: flex;
    }

    /* --- –ò–ó–ú–ï–ù–ï–ù–ò–ï: .goals –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö --- */
    .goals { 
        width: 100%; 
        border-right: none; 
        border-left: none; 
        border-bottom: 1px solid var(--border-color); 
        padding: 15px; 
        height: auto; 
        max-height: none; 
        overflow-y: visible; 
        position: static; /* –°—Ç–∏–ª–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è –º–æ–±–∏–ª—å–Ω–æ–π —Å–µ–∫—Ü–∏–∏ */
    }
    #goalsList {
        /* –°—Ç–∏–ª–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–∫–æ–ª–æ–Ω–∫–∞) */
        display: flex;
        flex-direction: column;
        gap: 15px;
        max-height: none;
        overflow-y: visible;
    }
    /* –ö–Ω–æ–ø–∫–∞ "–î–æ–±–∞–≤–∏—Ç—å" –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
    .add-goal-btn {
        position:absolute;
        left:50%;
        transform:translateX(-50%);
        bottom:15px;
        width:40px;height:40px;
        font-size:24px;
        display:none; /* –°–∫—Ä—ã—Ç–∞, –ø–æ–∫–∞ –Ω–µ –Ω–∞–≤–µ–¥–µ—à—å */
    }
    .goals:hover .add-goal-btn{display:flex}
    /* --- –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–ô .goals --- */


    .right { padding: 0; overflow-y: visible; } /* –£–±—Ä–∞–ª–∏ –æ—Ç—Å—Ç—É–ø—ã –¥–ª—è .right */

    /* --- –ò–ó–ú–ï–ù–ï–ù–ò–Ø –ü–û –ó–ê–ü–†–û–°–£ --- */
    .mobile-bottom-nav {
        display: flex;
    }
    
    /* --- –ò–ó–ú–ï–ù–ï–ù–ò–ï: –®–∞–ø–∫–∞ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö --- */
    .top-controls { 
        display: block; /* WAS: none. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º, —Ç.–∫. .goals —Ç–µ–ø–µ—Ä—å —Ç—É—Ç */
        align-items: start; /* –ò–ó–ú–ï–ù–ï–ù–û */
    }
    .top-controls-left,
    .top-controls-center {
        display: none; /* –°–∫—Ä—ã–≤–∞–µ–º –ª–µ–≤—É—é –∫–æ–ª–æ–Ω–∫—É –∏ –ª–æ–≥–æ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
    }
    .top-controls-right {
        display: block; /* –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∞–≤—É—é –∫–æ–ª–æ–Ω–∫—É (–≥–¥–µ .goals) */
    }
    /* --- –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–ô –®–ê–ü–ö–ò --- */

    #aiButtonContainer {
        display: none; 
    }
    
    .save-all-btn, .account-control-btn { font-size: 12px; padding: 6px 10px; }
    .habit-controls { flex-direction: column; align-items: stretch; }
    
    /* --- –°—Ç–∏–ª–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—è –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö --- */
    .calendar-wrapper { width: 100%; margin: 0; border-radius: 0; border: none; padding: 10px; }
    .calendar-header { flex-direction: column; gap: 15px; }
    #current-month-display { font-size: 1.3em; }
    .calendar-grid { gap: 2px; min-height: 50vh; }
    .calendar-day { min-height: 80px; padding: 5px; gap: 3px; }
    .day-number { font-size: 0.8em; }
    .task-preview-item { font-size: 0.7em; padding: 1px 3px; }
    .weekday { font-size: 0.8em; padding: 5px 0; }
    
    .week-day-column { min-width: 290px; }
    
    .add-task-form-week input { padding: 6px 8px; font-size: 13px; }
    .add-task-form-week button { padding: 6px 8px; min-width: 36px; }
    .send-icon { width: 18px; height: 18px; }
    /* --- –ö–æ–Ω–µ—Ü —Å—Ç–∏–ª–µ–π –∫–∞–ª–µ–Ω–¥–∞—Ä—è --- */
    
    /* --- –°—Ç–∏–ª–∏ –º–æ–¥–∞–ª–æ–∫ --- */
    .modal-content { width: 100%; height: 100%; max-height: 100vh; border-radius: 0; }
    .small-modal-content { max-width: 100%; margin: 0; border-radius: 0; }
    .advice-modal-drawer { width: 100%; max-width: 100%; }

    .mood-calendar { grid-template-columns: repeat(4, 1fr); }
    .mood-option { font-size: 30px; }
}
/* --- –°–¢–ò–õ–ò –î–õ–Ø –ú–û–î–ê–õ–¨–ù–û–ì–û –û–ö–ù–ê –ù–ê–°–¢–†–û–ï–ù–ò–Ø --- */

/* –°—Ç–∏–ª—å –¥–ª—è –∫–Ω–æ–ø–∫–∏ "X" –≤ —à–∞–ø–∫–µ (–∫–∞–∫ —É –¥—Ä—É–≥–∏—Ö –º–æ–¥–∞–ª–æ–∫) */
#close-mood-modal {
    cursor: pointer;
    font-size: 24px;
    color: var(--text-secondary);
    transition: color 0.2s;
}
#close-mood-modal:hover {
    color: var(--accent-color);
}

/* –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É –∏ —ç—Ñ—Ñ–µ–∫—Ç –¥–ª—è —ç–º–æ–¥–∑–∏ */
#mood-modal-emoji {
    /* –¢–∞ –∂–µ –ø–æ–¥—Å–≤–µ—Ç–∫–∞, —á—Ç–æ –∏ —É –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å–º–∞–π–ª–∏–∫–∞ */
    text-shadow: 0 0 15px var(--warning-color);
    transition: transform 0.2s ease;
}
#mood-modal-emoji:hover {
    transform: scale(1.1); /* –ú–∞–ª–µ–Ω—å–∫–∏–π —ç—Ñ—Ñ–µ–∫—Ç –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ */
}

/* –£–ª—É—á—à–∞–µ–º textarea –¥–ª—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è */
#mood-modal-comment {
    font-family: inherit; /* –ß—Ç–æ–±—ã —à—Ä–∏—Ñ—Ç –±—ã–ª –∫–∞–∫ —É –≤—Å–µ–≥–æ —Å–∞–π—Ç–∞ */
    resize: vertical;     /* –†–∞–∑—Ä–µ—à–∞–µ–º –º–µ–Ω—è—Ç—å —Ä–∞–∑–º–µ—Ä –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏ */
    min-height: 120px;    /* –î–µ–ª–∞–µ–º –ø–æ–ª–µ —á—É—Ç—å –ø–æ–±–æ–ª—å—à–µ */
    transition: border-color 0.2s, box-shadow 0.2s;
}

/* –≠—Ñ—Ñ–µ–∫—Ç :focus –¥–ª—è textarea, –∫–∞–∫ —É –¥—Ä—É–≥–∏—Ö –ø–æ–ª–µ–π */
#mood-modal-comment:focus {
    outline: none;
    border-color: var(--accent-color);
    box-shadow: 0 0 8px rgba(0, 123, 255, 0.4);
}

/* –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç—Å—Ç—É–ø –º–µ–∂–¥—É –∫–Ω–æ–ø–∫–∞–º–∏ "–û—Ç–º–µ–Ω–∞" –∏ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å" */
#mood-comment-modal .modal-footer div {
    display: flex;
    gap: 10px;
}

/* –£–ª—É—á—à–∞–µ–º –∫–Ω–æ–ø–∫—É "–£–¥–∞–ª–∏—Ç—å" */
#mood-modal-delete-btn {
    color: #fff; /* –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ —Ç–µ–∫—Å—Ç –±–µ–ª—ã–π */
    transition: background-color 0.2s, transform 0.2s, box-shadow 0.2s;
}
#mood-modal-delete-btn:hover {
    background-color: #c32727; /* –¢–æ—Ç –∂–µ hover, —á—Ç–æ —É .btn-delete */
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(229, 57, 53, 0.3);
}
/* --- –°–¢–ê–¢–ò–°–¢–ò–ö–ê –í –ü–†–û–§–ò–õ–ï --- */
.profile-stats {
    display: flex;
    justify-content: space-around;
    gap: 15px;
    padding: 10px;
    background: var(--bg-tertiary);
    border-radius: 6px;
}
.profile-stats div {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 5px;
}
.profile-stats span {
    font-size: 14px;
    color: var(--text-secondary);
}
.profile-stats strong {
    font-size: 20px;
    font-weight: 600;
    color: var(--accent-color);
}


/* --- –ú–û–ë–ò–õ–¨–ù–ê–Ø –ù–ê–í–ò–ì–ê–¶–ò–Ø (–†–ï–î–ò–ó–ê–ô–ù) --- */
@media (max-width: 768px) {
    .mobile-bottom-nav {
        display: flex;
        justify-content: space-between;
        align-items: flex-end; 
        height: 75px; 
        padding: 0 10px;
        padding-bottom: 8px; 
    }
    .mobile-bottom-nav .mobile-nav-btn {
        flex: 1;
        max-width: 60px; 
        align-items: center;
        justify-content: center;
        padding-top: 6px; 
        height: 60px; 
        align-self: center; 
    }

    .mobile-nav-center-btn-container {
        flex: 0 0 70px; 
        position: relative;
        display: flex;
        justify-content: center;
        height: 100%;
        align-items: flex-start; 
    }

    .mobile-nav-center-btn {
        position: absolute;
        top: -20px; 
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: var(--accent-color);
        border: 4px solid var(--bg-main);
        box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.4);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: transform 0.2s ease, background-color 0.2s;
    }
    .mobile-nav-center-btn:hover {
        transform: scale(1.1);
        background-color: var(--accent-hover);
    }
    .mobile-nav-center-btn:active {
        transform: scale(0.95);
    }

    .hamburger-icon {
        display: flex;
        flex-direction: column;
        gap: 4px;
        width: 22px;
    }
    .hamburger-icon span {
        width: 100%;
        height: 3px;
        background-color: #fff;
        border-radius: 2px;
        transition: transform 0.3s ease, opacity 0.3s ease;
    }

    /* –ê–Ω–∏–º–∞—Ü–∏—è –≥–∞–º–±—É—Ä–≥–µ—Ä–∞ –≤ –∫—Ä–µ—Å—Ç–∏–∫ (–ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –º–µ–Ω—é) */
    .mobile-nav-center-btn.is-open .hamburger-icon span:nth-child(1) {
        transform: translateY(7px) rotate(45deg);
    }
    .mobile-nav-center-btn.is-open .hamburger-icon span:nth-child(2) {
        opacity: 0;
    }
    .mobile-nav-center-btn.is-open .hamburger-icon span:nth-child(3) {
        transform: translateY(-7px) rotate(-45deg);
    }
}

/* --- –í–°–ü–õ–´–í–ê–Æ–©–ï–ï –ú–û–ë–ò–õ–¨–ù–û–ï –ú–ï–ù–Æ (–†–ï–î–ò–ó–ê–ô–ù) --- */
.mobile-menu-overlay {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(5px);
    z-index: 10002;
    display: flex;
    flex-direction: column;
    justify-content: flex-end; 
    align-items: center;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s ease, visibility 0.3s ease;
    padding-bottom: 95px; 
}
.mobile-menu-overlay.visible {
    opacity: 1;
    visibility: visible;
}

.mobile-menu-content {
    display: flex;
    flex-direction: column;
    gap: 10px; 
    
    padding: 15px;
    width: 90%;
    max-width: 320px; 
    
    background: var(--bg-tertiary);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    box-shadow: 0 -4px 15px rgba(0,0,0,0.3);

    transform-origin: bottom center;
    transform: translateY(10px) scale(0.9);
    opacity: 0;
    transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.2s ease-out;
}
.mobile-menu-overlay.visible .mobile-menu-content {
    transform: translateY(0) scale(1);
    opacity: 1;
}

.mobile-menu-btn {
    background: var(--bg-hover); 
    border: 1px solid var(--border-color);
    color: var(--text-primary);
    border-radius: 10px; 
    padding: 12px 15px;
    
    display: flex;
    flex-direction: row; 
    align-items: center;
    justify-content: flex-start; 
    gap: 15px; 
    
    font-size: 16px; 
    font-weight: 500; 
    cursor: pointer;
    transition: transform 0.2s ease, background-color 0.2s ease;
}
.mobile-menu-btn .icon {
    font-size: 24px; 
    flex-shrink: 0;
    width: 30px; 
    text-align: center;
}
.mobile-menu-btn .label {
    font-size: 15px; 
    font-weight: 500;
}
.mobile-menu-btn:hover {
    background-color: var(--accent-color); 
    transform: translateY(-2px);
    color: #fff;
}
.mobile-menu-btn:active {
    transform: scale(0.98);
}

.mobile-menu-close-btn {
    display: none; 
}
</style>
</head>

<body>

<div id="notification-container"></div>

<div class="top-controls">
    <div class="top-controls-left">
        <div id="accountControl" class="account-control-btn">
            <img src="pictures/account.png" width="16" height="16" alt="Profile">
            <span id="usernameDisplay">–ü—Ä–æ—Ñ–∏–ª—å</span>
        </div>
        <button id="saveAllBtn" class="save-all-btn">
            <img src="pictures/save.png" width="16" height="16" alt="Save">
            <span id="saveAllBtnText">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å–µ</span>
        </button>
        <a href="meds.html" class="header-btn">
            <span class="icon">üíäÔ∏è</span>
            <span>–õ–µ–∫–∞—Ä—Å—Ç–≤–∞</span>
        </a>
        
        <a href="knowledge_base.html" class="btn knowledge-base-btn">
            üß† –ü–µ—Ä–µ–π—Ç–∏ –≤ –ë–∞–∑—É –ó–Ω–∞–Ω–∏–π
        </a>
        <a href="lists.html" class="btn knowledge-base-btn">
            üìù –ü–µ—Ä–µ–π—Ç–∏ –≤ –°–ø–∏—Å–∫–∏
        </a>
    </div>

    <div class="top-controls-center">
        <img src="pictures/favicon.png" alt="Logo">
        <span>Time Owner</span>
    </div>
    
    <div class="top-controls-right">
        <aside class="goals mobile-section" id="mobileSectionGoals">
            <h2>–ì–æ–¥–æ–≤—ã–µ —Ü–µ–ª–∏</h2>
            <div id="goalsList"></div>
            <div id="addGoalBtn" class="add-goal-btn">Ôºã</div>
        </aside>
    </div>
</div>

<div class="banner">
  <img id="bannerImg" src="pictures/banner.jpg" alt="–ë–∞–Ω–Ω–µ—Ä">
</div>

<div class="main-container">
  
  <main class="right mobile-section" id="mobileSectionWeeks">
    
    <main class="calendar-wrapper">
        <div class="calendar-header">
            <div class="view-toggle">
                <button class="btn active" id="month-view-btn">–ú–µ—Å—è—Ü</button>
                <button class="btn" id="week-view-btn">–ù–µ–¥–µ–ª—è</button>
            </div>
            
            <div class="calendar-nav">
                <button class="btn nav-btn" id="prev-btn">‚Äπ</button>
                <h2 id="current-month-display"></h2>
                <button class="btn nav-btn" id="next-btn">‚Ä∫</button>
            </div>
            
            <button class="btn" id="today-btn">–°–µ–≥–æ–¥–Ω—è</button>
        </div>

        <div id="month-view" style="display: block;">
            <div class="calendar-weekdays">
                <div class="weekday">–ü–Ω</div>
                <div class="weekday">–í—Ç</div>
                <div class="weekday">–°—Ä</div>
                <div class="weekday">–ß—Ç</div>
                <div class="weekday">–ü—Ç</div>
                <div class="weekday">–°–±</div>
                <div class="weekday">–í—Å</div>
            </div>
            <div class="calendar-grid" id="calendar-grid">
                </div>
        </div>

        <div id="week-view" style="display: none;">
            <div class="week-view-container" id="week-view-container">
                </div>
        </div>
    </main>
    
  </main>
</div> 

<section class="habit-tracker mobile-section" id="mobileSectionHabits">
    <h2>‚úÖ –¢—Ä–µ–∫–µ—Ä –ü—Ä–∏–≤—ã—á–µ–∫</h2>
    <div class="habit-controls">
        <input type="text" id="newHabitInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—É—é –ø—Ä–∏–≤—ã—á–∫—É">
        <button id="addHabitBtn" class="btn">–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–≤—ã—á–∫—É</button>
        <button id="newDayBtn" class="btn create-week">–ù–æ–≤—ã–π –¥–µ–Ω—å</button>
    </div>
    <div class="habit-table-container" id="habitTableContainer">
        <div class="habit-table-wrapper">
            <table class="habit-table">
                <thead>
                    <tr id="habitHeaderRow">
                        <th>–î–∞—Ç–∞</th>
                        <th class="progress-col">–ü—Ä–æ–≥—Ä–µ—Å—Å –¥–Ω—è</th>
                    </tr>
                </thead>
                <tbody id="habitBody">
                </tbody >
            </table>
        </div>
    </div>
    <button class="toggle-history-btn" id="toggleHabitHistoryBtn" style="display:none;">
        –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é
    </button>
</section>

<section class="mood-tracker mobile-section" id="mobileSectionMood">
    <h2>‚ú® –¢—Ä–µ–∫–µ—Ä –ù–∞—Å—Ç—Ä–æ–µ–Ω–∏—è</h2>
    <p style="text-align:center;">–ö–∞–∫ —Ç–≤–æ–π –¥–µ–Ω—å?</p>
    <div class="mood-selection">
        <span class="mood-option" data-mood="bad" title="–ü–ª–æ—Ö–æ">üòî</span>
        <span class="mood-option" data-mood="normal" title="–ù–æ—Ä–º–∞–ª—å–Ω–æ">üòê</span>
        <span class="mood-option" data-mood="great" title="–û—Ç–ª–∏—á–Ω–æ">üòÑ</span>
    </div>
    <div style="padding: 0 20px 15px 20px; display: flex; flex-direction: column; gap: 8px;">
        <label for="moodCommentInput" style="color: var(--text-secondary); font-weight: 600; font-size: 0.9em;">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –¥–Ω—é (—Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–æ–º):</label>
        <textarea id="moodCommentInput" rows="3" placeholder="–•–æ—á–µ—à—å –¥–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ —ç—Ç–æ–º—É –¥–Ω—é?" style="width: 100%; background: var(--bg-tertiary); border: 1px solid var(--border-color); color: var(--text-primary); padding: 10px 12px; border-radius: 6px; font-size: 15px; font-family: inherit; resize: vertical;"></textarea>
    </div>

    <h3>–ò—Å—Ç–æ—Ä–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è</h3>
    <div class="mood-history-controls">
        <select id="moodMonthSelect" class="current-month-select"></select>
    </div>
    <div id="moodCalendar" class="mood-calendar">
        </div>
</section>

<div class="modal" id="profileModal">
    <div class="modal-content small-modal-content">
        <h2>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</h2>

        <div class="profile-section">
            <h3>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–¥–∞—á</h3>
            <div class="profile-stats">
                <div>
                    <span>–í—ã–ø–æ–ª–Ω–µ–Ω–æ:</span>
                    <strong id="completedTasksCount">0</strong>
                </div>
                <div>
                    <span>–û—Å—Ç–∞–ª–æ—Å—å:</span>
                    <strong id="uncompletedTasksCount">0</strong>
                </div>
            </div>
        </div>

        <div class="profile-section">
            <h3>–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–ù–∏–∫)</h3>
            <div class="profile-input-group">
                <input type="text" id="nickInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –Ω–∏–∫">
                <button id="saveNickBtn" class="btn btn-save-nick">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>

        <div class="profile-section">
            <h3>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–æ–º</h3>
            <button id="deleteProfileBtn" class="btn btn-delete">
                <img src="pictures/trash.png" width="16" alt="–£–¥–∞–ª–∏—Ç—å">
                –£–¥–∞–ª–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å –∏ –≤—Å–µ –¥–∞–Ω–Ω—ã–µ
            </button>
            <button id="logoutBtn" class="btn btn-logout">
                <img src="pictures/logout.png" width="16" alt="–í—ã—Ö–æ–¥"> 
                –í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞
            </button>
        </div>

        <button class="btn" onclick="closeProfileModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
</div>
<div class="modal" id="mood-comment-modal">
    <div class="modal-content small-modal-content">
        <div class="modal-header">
            <h2 id="mood-modal-date-display">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –¥–Ω—é</h2>
            <span id="close-mood-modal" class="close-mood-modal">√ó</span>
        </div>
        <div class="modal-body">
            <div style="text-align: center; font-size: 40px; margin-bottom: 15px;" id="mood-modal-emoji"></div>
            <div class="form-group">
                <label for="mood-modal-comment">–í–∞—à –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</label>
                <textarea id="mood-modal-comment" rows="5" class="form-control" placeholder="–ó–¥–µ—Å—å –≤–∞—à –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..."></textarea>
            </div>
        </div>
        <div class="modal-footer" style="display: flex; justify-content: space-between;">
            <button type="button" class="btn" id="mood-modal-delete-btn" style="background: var(--danger-color); border-color: var(--danger-color);">–£–¥–∞–ª–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</button>
            <div>
                <button type="button" class="btn close-mood-modal">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" class="btn btn-primary" id="mood-modal-save-btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>
</div>
<div class="modal" id="day-modal">
    <div class="modal-content" style="max-width: 600px;"> <div class="modal-header">
            <h2 id="modal-date-display"></h2>
            <span id="close-modal">√ó</span>
        </div>
        <div class="modal-body">
            <div id="modal-task-list">
                </div>
        </div>
        <div class="modal-footer">
            <form id="add-task-form-modal" action="javascript:void(0);">
                <input type="time" id="new-task-time" required>
                <input type="text" id="new-task-text" placeholder="–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞..." required>
                <button type="submit" class="btn btn-primary" id="add-task-btn" title="–î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É">
                    <svg class="send-icon" viewBox="0 0 24 24">
                        <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path>
                    </svg>
                </button>
            </form>
        </div>
    </div>
</div>

<div class="modal" id="recur-modal">
    <div class="modal-content" style="max-width: 600px;"> <div class="modal-header">
            <h2>–ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏</h2>
            <span class="close-recur-modal">√ó</span>
        </div>
        <div class="modal-body">
            <form id="recur-form">
                <div class="form-group">
                    <label for="recur-type">–ü–æ–≤—Ç–æ—Ä—è—Ç—å:</label>
                    <select id="recur-type" class="form-control">
                        <option value="weekly">–†–∞–∑ –≤ –Ω–µ–¥–µ–ª—é</option>
                        <option value="monthly">–†–∞–∑ –≤ –º–µ—Å—è—Ü</option>
                        <option value="yearly">–†–∞–∑ –≤ –≥–æ–¥</option>
                        <option value="custom">–°–≤–æ–π –≤–∞—Ä–∏–∞–Ω—Ç (–¥–Ω–∏)</option>
                    </select>
                </div>
                
                <div id="recur-weekly-options" class="recur-options">
                    <p>–í—ã–±–µ—Ä–∏—Ç–µ –¥–Ω–∏ –Ω–µ–¥–µ–ª–∏:</p>
                    <div class="weekday-picker" id="recur-weekly-days">
                        <label><input type="checkbox" value="1"> –ü–Ω</label>
                        <label><input type="checkbox" value="2"> –í—Ç</label>
                        <label><input type="checkbox" value="3"> –°—Ä</label>
                        <label><input type="checkbox" value="4"> –ß—Ç</label>
                        <label><input type="checkbox" value="5"> –ü—Ç</label>
                        <label><input type="checkbox" value="6"> –°–±</label>
                        <label><input type="checkbox" value="0"> –í—Å</label>
                    </div>
                </div>

                <div id="recur-custom-options" class="recur-options" style="display: none;">
                    <label for="recur-custom-days">–ü–æ–≤—Ç–æ—Ä—è—Ç—å –∫–∞–∂–¥—ã–µ (–¥–Ω–µ–π):</label>
                    <input type="number" id="recur-custom-days" class="form-control" value="2" min="1" max="30">
                </div>
                
                <div class="form-group" style="margin-top: 15px;">
                     <label for="recur-end-date">–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):</label>
                     <input type="date" id="recur-end-date" class="form-control">
                </div>

            </form>
        </div>
        <div class="modal-footer">
             <button type="button" class="btn close-recur-modal">–û—Ç–º–µ–Ω–∞</button>
             <button type="button" class="btn btn-primary" id="save-recur-btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
    </div>
</div>
<div id="loadingOverlay">
    <div class="spinner"></div>
    <div>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ...</div>
</div>

<div id="aiAdviceModalOverlay" class="advice-modal-overlay">
    <div id="aiAdviceModal" class="advice-modal-drawer">
        <div class="advice-drawer-header">
            <h2>ü§ñ AI –°–æ–≤–µ—Ç</h2>
            <button class="advice-drawer-close" onclick="closeAiAdviceModal()">&times;</button>
        </div>
        <div class="advice-drawer-content">
            <p id="aiAdviceText"></p>
        </div>
    </div>
</div>

<div id="aiButtonContainer">
    <button id="getAISuggestionBtn" class="btn">
        ü§ñ –ü–æ–ª—É—á–∏—Ç—å AI —Å–æ–≤–µ—Ç
    </button>
</div>

<footer id="main-footer">
    <div id="particles-js"></div> 

    <div class="footer-content">
        <p>Time Owner: –°—Ç–∞–Ω—å—Ç–µ –Ω–∞—Å—Ç–æ—è—â–∏–º –í–ª–∞–¥–µ–ª—å—Ü–µ–º —Å–≤–æ–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏, –∞ –Ω–µ –µ–≥–æ –∑–∞–ª–æ–∂–Ω–∏–∫–æ–º. <br>–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ –¥–ª—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏, –∫–æ–Ω—Ç—Ä–æ–ª—è –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–∞–º—ã–º —Ü–µ–Ω–Ω—ã–º —Ä–µ—Å—É—Ä—Å–æ–º ‚Äî –≤–∞—à–µ–π –∂–∏–∑–Ω—å—é. <br>–î–æ—Å—Ç–∏–≥–∞–π—Ç–µ —Ü–µ–ª–µ–π, —É–ø—Ä–∞–≤–ª—è–π—Ç–µ –∑–∞–¥–∞—á–∞–º–∏ –∏ –º–∞–∫—Å–∏–º–∏–∑–∏—Ä—É–π—Ç–µ –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Å –ø–æ–ª–Ω—ã–º –æ—Å–æ–∑–Ω–∞–Ω–∏–µ–º –∏ –∫–æ–Ω—Ç—Ä–æ–ª–µ–º.</p>
    </div>
</footer>

<nav class="mobile-bottom-nav">
    <button class="mobile-nav-btn" id="mobileNavWeeks">
        <span class="icon">üóìÔ∏è</span>
        <span class="label">–ö–∞–ª–µ–Ω–¥–∞—Ä—å</span> </button>
    <button class="mobile-nav-btn" id="mobileNavHabits">
        <span class="icon">‚úÖ</span>
        <span class="label">–ü—Ä–∏–≤—ã—á–∫–∏</span>
    </button>
    
    <div class="mobile-nav-center-btn-container">
        <button class="mobile-nav-center-btn" id="mobileNavMenuBtn">
            <div class="hamburger-icon">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </button>
    </div>
    
    <button class="mobile-nav-btn" id="mobileNavSave">
        <span class="icon">üíæ</span>
        <span class="label">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</span>
    </button>
    <button class="mobile-nav-btn" id="mobileNavProfile">
        <span class="icon">üë§</span>
        <span class="label">–ü—Ä–æ—Ñ–∏–ª—å</span>
    </button>
</nav>

<div class="mobile-menu-overlay" id="mobileMenuOverlay">
    <div class="mobile-menu-content">
        <button class="mobile-menu-btn" id="mobileMenuGoals">
            <span class="icon">üéØ</span>
            <span class="label">–¶–µ–ª–∏</span>
        </button>
        <button class="mobile-menu-btn" id="mobileMenuMood">
            <span class="icon">‚ú®</span>
            <span class="label">–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ</span>
        </button>
        <button class="mobile-menu-btn" id="mobileMenuKB">
            <span class="icon">üß†</span>
            <span class="label">–ë–∞–∑–∞</span>
        </button>
        <button class="mobile-menu-btn" id="mobileMenuAI">
            <span class="icon">ü§ñ</span>
            <span class="label">AI</span>
        </button>
        <button class="mobile-menu-btn" id="mobileMenuMedics">
            <span class="icon">üíä</span>
            <span class="label">–õ–µ–∫–∞—Ä—Å—Ç–≤–∞</span>
        </button>
        <button class="mobile-menu-btn" id="mobileMenuLists">
            <span class="icon">üìù</span>
            <span class="label">–°–ø–∏—Å–∫–∏</span>
        </button>
        <button class="mobile-menu-btn" id="mobileMenuScanner">
            <span class="icon">üì∏</span>
            <span class="label">–°–∫–∞–Ω–Ω–µ—Ä</span>
        </button>
    </div>
    </div>


<script>
// =================================================================
// 1. –ö–û–ù–°–¢–ê–ù–¢–´ –ò –ü–ï–†–ï–ú–ï–ù–ù–´–ï (–û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –¥–ª—è Supabase)
// =================================================================

// --- –ö–û–ù–°–¢–ê–ù–¢–´ SUPABASE ---
const SUPABASE_URL = 'https://dgkozfxuhauemxrbjvno.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRna296Znh1aGF1ZW14cmJqdm5vIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAzOTgzMTcsImV4cCI6MjA3NTk3NDMxN30.kkRJs8IO1cQBnAZe-yBjQs2rXzR34ZV1emQqTG6UqVs';
let supabase = null; 
let currentUserId = null; // –î–û–ë–ê–í–õ–ï–ù–û –î–õ–Ø –ö–ê–õ–ï–ù–î–ê–†–Ø

// --- –û–ë–©–ò–ï –ö–û–ù–°–¢–ê–ù–¢–´ ---
const STORAGE_KEY_AUTH = 'plannerAuthDataKey'; 
const STORAGE_KEY_USERNAME = 'plannerUsername';
const STORAGE_KEY_LOCAL = 'plannerData_v9_local';
const STORAGE_KEY_UNSAVED = 'plannerUnsavedChanges';
// STORAGE_KEY_CONFIRM_DELETE —É–¥–∞–ª–µ–Ω

const MOOD_EMOJIS = { bad: 'üòî', normal: 'üòê', great: 'üòÑ' };

let notificationTimers = {}; 
let data = null; // –≠—Ç–æ –¥–ª—è Goals, Habits, Mood
let pendingTaskChanges = []; // –û—á–µ—Ä–µ–¥—å –∏–∑–º–µ–Ω–µ–Ω–∏–π –∑–∞–¥–∞—á –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
// dragId, dragTitle, dragOrigin, currentDayDrag —É–¥–∞–ª–µ–Ω—ã
let isUnsavedNotifShowing = false; // –§–ª–∞–≥, —á—Ç–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —É–∂–µ –ø–æ–∫–∞–∑–∞–Ω–æ
let currentUnsavedNotif = null;    // –°—Å—ã–ª–∫–∞ –Ω–∞ DOM-—ç–ª–µ–º–µ–Ω—Ç —ç—Ç–æ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

const saveAllBtn = document.getElementById('saveAllBtn');
const saveAllBtnText = document.getElementById('saveAllBtnText');
const accountControlBtn = document.getElementById('accountControl');
accountControlBtn.onclick = handleAccountControlClick;

const getAISuggestionBtn = document.getElementById('getAISuggestionBtn');
const aiAdviceModalOverlay = document.getElementById('aiAdviceModalOverlay');
const aiAdviceText = document.getElementById('aiAdviceText');

// --- –°—Å—ã–ª–∫–∏ –Ω–∞ –∫–æ—Ä–∑–∏–Ω—É –∏ –º–æ–¥–∞–ª–∫—É –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω—ã ---

const loadingOverlay = document.getElementById('loadingOverlay');
function showLoading() {
    loadingOverlay.style.display = 'flex';
    setTimeout(() => { loadingOverlay.style.opacity = '1'; }, 10);
}
function hideLoading() {
    loadingOverlay.style.opacity = '0';
    setTimeout(() => { loadingOverlay.style.display = 'none'; }, 300);
}

/* --- –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –ö–∞—Å—Ç–æ–º–Ω—ã–µ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è --- */
function showNotification(message, type = 'warning', duration = 5000) {
    const container = document.getElementById('notification-container');
    if (!container) return;

    const notif = document.createElement('div');
    notif.className = `custom-notification ${type}`; // type: 'warning', 'success', 'error'
    
    const messageP = document.createElement('p');
    messageP.textContent = message;
    
    const closeBtn = document.createElement('button');
    closeBtn.className = 'close-btn';
    closeBtn.innerHTML = '&times;';
    
    notif.appendChild(messageP);
    notif.appendChild(closeBtn);
    container.appendChild(notif);

    setTimeout(() => {
        notif.classList.add('show');
    }, 10); 

    let timer = null;

    const removeNotif = () => {
        if (timer) clearTimeout(timer);
        notif.classList.remove('show');
        setTimeout(() => {
            if (notif.parentElement) {
                notif.parentElement.removeChild(notif);
            }
        }, 500); 
    };
    
    closeBtn.onclick = removeNotif;

    if (duration) {
        timer = setTimeout(removeNotif, duration);
    }
}
/* --- –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –ù–µ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –î–∞–Ω–Ω—ã—Ö --- */
function showUnsavedDataNotification(message, type = 'warning') {
    // 1. –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å, –µ—Å–ª–∏ —É–∂–µ –ø–æ–∫–∞–∑–∞–Ω–æ
    if (isUnsavedNotifShowing) return; 
    
    const container = document.getElementById('notification-container');
    if (!container) return;

    isUnsavedNotifShowing = true; // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥

    const notif = document.createElement('div');
    notif.className = `custom-notification ${type}`;
    
    // 2. –§—É–Ω–∫—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∏—è
    const removeNotif = () => {
        notif.classList.remove('show');
        setTimeout(() => {
            if (notif.parentElement) {
                notif.parentElement.removeChild(notif);
            }
            isUnsavedNotifShowing = false; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥
            currentUnsavedNotif = null; // –û—á–∏—â–∞–µ–º —Å—Å—ã–ª–∫—É
        }, 500); 
    };

    // 3. –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç (—Å–æ–æ–±—â–µ–Ω–∏–µ + –∫–Ω–æ–ø–∫–∞ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å")
    const contentWrapper = document.createElement('div');
    // –°—Ç–∏–ª–∏, —á—Ç–æ–±—ã –∫–Ω–æ–ø–∫–∞ –±—ã–ª–∞ –ø–æ–¥ —Ç–µ–∫—Å—Ç–æ–º
    contentWrapper.style.display = 'flex';
    contentWrapper.style.flexDirection = 'column';
    contentWrapper.style.gap = '10px';
    contentWrapper.style.alignItems = 'flex-start';
    contentWrapper.style.marginRight = '15px'; // –û—Ç—Å—Ç—É–ø –æ—Ç –∫—Ä–µ—Å—Ç–∏–∫–∞

    const messageP = document.createElement('p');
    messageP.textContent = message;
    
    const saveBtn = document.createElement('button');
    saveBtn.className = 'btn btn-primary'; // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–≤–æ–∏ —Å—Ç–∏–ª–∏
    saveBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
    saveBtn.style.padding = '5px 10px'; // –î–µ–ª–∞–µ–º –∫–Ω–æ–ø–∫—É —á—É—Ç—å –∫–æ–º–ø–∞–∫—Ç–Ω–µ–µ
    saveBtn.style.fontSize = '14px';

    contentWrapper.appendChild(messageP);
    contentWrapper.appendChild(saveBtn);

    // 4. –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫—É "–ó–∞–∫—Ä—ã—Ç—å" (–∫—Ä–µ—Å—Ç–∏–∫)
    const closeBtn = document.createElement('button');
    closeBtn.className = 'close-btn';
    closeBtn.innerHTML = '&times;';
    
    // 5. –°–æ–±–∏—Ä–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    notif.appendChild(contentWrapper);
    notif.appendChild(closeBtn);
    container.appendChild(notif);

    // 6. –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    currentUnsavedNotif = notif;

    // 7. –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è
    setTimeout(() => {
        notif.classList.add('show');
    }, 10); 

    // 8. –ù–∞–∑–Ω–∞—á–∞–µ–º –¥–µ–π—Å—Ç–≤–∏—è –∫–Ω–æ–ø–∫–∞–º
    closeBtn.onclick = removeNotif; // –ö—Ä–µ—Å—Ç–∏–∫ –ø—Ä–æ—Å—Ç–æ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç

    saveBtn.onclick = async () => {
        saveBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
        saveBtn.disabled = true;
        
        // –í—ã–∑—ã–≤–∞–µ–º —Ç–≤–æ—é –≥–ª–∞–≤–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
        const result = await saveDataToSupabase(); 
        
        // –ï—Å–ª–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ *–Ω–µ* —É–¥–∞–ª–æ—Å—å, –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É.
        // –ï—Å–ª–∏ —É–¥–∞–ª–æ—Å—å, —Ç–æ `saveDataToSupabase` –≤—ã–∑–æ–≤–µ—Ç `setUnsaved(false)`,
        // –∏ —ç—Ç–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∑–∞–∫—Ä–æ–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ (—Å–º. –®–∞–≥ 3).
        if (result.status !== 'success') {
            saveBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
            saveBtn.disabled = false;
        }
    };
    
    // 9. –¢–∞–π–º–µ—Ä –∞–≤—Ç–æ-–∑–∞–∫—Ä—ã—Ç–∏—è (timer) –∑–¥–µ—Å—å –Ω–µ —Å–æ–∑–¥–∞–µ—Ç—Å—è,
    // –ø–æ—ç—Ç–æ–º—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –Ω–µ –∏—Å—á–µ–∑–Ω–µ—Ç —Å–∞–º–æ.
}

/* --- –§–£–ù–ö–¶–ò–ò –£–ü–†–ê–í–õ–ï–ù–ò–Ø –°–û–•–†–ê–ù–ï–ù–ò–ï–ú (Goals, Habits, Mood) --- */
function setUnsaved(isUnsaved) {
    const mobileSaveBtn = document.getElementById('mobileNavSave'); 

    if (isUnsaved) {
        localStorage.setItem(STORAGE_KEY_UNSAVED, 'true');
        saveAllBtn.classList.add('unsaved');
        document.getElementById('saveAllBtnText').textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å–µ (!)'; 
        if (mobileSaveBtn) mobileSaveBtn.classList.add('unsaved');
        
        // --- –î–û–ë–ê–í–õ–ï–ù–û: –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–∞—à–µ –Ω–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ ---
        showUnsavedDataNotification(
            '–£ –≤–∞—Å –µ—Å—Ç—å –Ω–µ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è', 
            'warning'
        );
        
    } else {
        localStorage.removeItem(STORAGE_KEY_UNSAVED);
        saveAllBtn.classList.remove('unsaved');
        document.getElementById('saveAllBtnText').textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å–µ';
        if (mobileSaveBtn) mobileSaveBtn.classList.remove('unsaved');
        
        // --- –î–û–ë–ê–í–õ–ï–ù–û: –ó–∞–∫—Ä—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ, –µ—Å–ª–∏ –æ–Ω–æ –µ—Å—Ç—å ---
        if (isUnsavedNotifShowing && currentUnsavedNotif) {
            currentUnsavedNotif.classList.remove('show');
            setTimeout(() => {
                if (currentUnsavedNotif && currentUnsavedNotif.parentElement) {
                    currentUnsavedNotif.parentElement.removeChild(currentUnsavedNotif);
                }
                isUnsavedNotifShowing = false;
                currentUnsavedNotif = null;
            }, 500);
        }
    }
}
function save() {
    if (!data) return;
    localStorage.setItem(STORAGE_KEY_LOCAL, JSON.stringify(data));
    setUnsaved(true);
}

// =================================================================
// 2. –§–£–ù–ö–¶–ò–ò –í–ó–ê–ò–ú–û–î–ï–ô–°–¢–í–ò–Ø –° SUPABASE (Goals, Habits, Mood)
// =================================================================
async function loadDataFromSupabase() {
    if (!supabase) { console.error("Supabase client not initialized."); return null; }
    const dataKey = localStorage.getItem(STORAGE_KEY_AUTH);
    if (!dataKey) { 
        window.location.href = 'login.html'; 
        return null; 
    }
    
    // --- –ò–ó–ú–ï–ù–ï–ù–û: –î–æ–±–∞–≤–ª–µ–Ω–∞ –æ—á–∏—Å—Ç–∫–∞ pendingTaskChanges –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ ---
    if (localStorage.getItem(STORAGE_KEY_UNSAVED) === 'true') {
        if (!confirm("–£ –≤–∞—Å –µ—Å—Ç—å –Ω–µ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è (–≤–∫–ª—é—á–∞—è –ó–∞–¥–∞—á–∏, –¶–µ–ª–∏, –ü—Ä–∏–≤—ã—á–∫–∏). –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Å —Å–µ—Ä–≤–µ—Ä–∞ –∏ –ø–æ—Ç–µ—Ä—è—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è? (–û—Ç–º–µ–Ω–∞ - –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Ä–∞–±–æ—Ç—É —Å –ª–æ–∫–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏)")) {
            setUnsaved(true);
            try { return JSON.parse(localStorage.getItem(STORAGE_KEY_LOCAL)); } catch (e) { console.error("–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –ª–æ–∫–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö."); }
        } else {
            // –û—á–∏—â–∞–µ–º –æ—á–µ—Ä–µ–¥—å, —Ç–∞–∫ –∫–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–≥–ª–∞—Å–∏–ª—Å—è –ø–æ—Ç–µ—Ä—è—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
            pendingTaskChanges = []; 
        }
    }
    // --- –ö–æ–Ω–µ—Ü –∏–∑–º–µ–Ω–µ–Ω–∏–π ---
    
    showLoading();
    const { data: result, error } = await supabase
        .from('user_data')
        .select('data_json')
        .eq('data_key', dataKey)
        .single(); 
    hideLoading();
    if (error && error.code !== 'PGRST116') { 
        console.error("–û—à–∏–±–∫–∞ Supabase –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ:", error);
        showNotification(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}. –ë—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –ø—É—Å—Ç—ã–µ –¥–∞–Ω–Ω—ã–µ.`, 'error', 8000);
    }

    const loadedData = (result && result.data_json) 
        ? result.data_json 
        : {goals:[],habits:[],habitRecords:[], moodRecords:{}}; 

    if (!loadedData.goals) loadedData.goals = [];
    if (!loadedData.habits) loadedData.habits = [];
    if (!loadedData.habitRecords) loadedData.habitRecords = [];
    if (!loadedData.moodRecords) loadedData.moodRecords = {};

    setUnsaved(false);
    localStorage.setItem(STORAGE_KEY_LOCAL, JSON.stringify(loadedData));
    return loadedData;
}

async function saveDataToSupabase() {
    if (!supabase) { 
        console.error("Supabase client not initialized."); 
        return { status: "error", message: "–ö–ª–∏–µ–Ω—Ç –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω." }; 
    }
    
    const dataKey = localStorage.getItem(STORAGE_KEY_AUTH);
    if (!dataKey) {
        showNotification("–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É —Å–Ω–æ–≤–∞.", 'error');
        window.location.href = 'login.html';
        return { status: "error", message: "–ù–µ—Ç –∫–ª—é—á–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏." };
    }
    
    showLoading();
    
    let goalsHabitsMoodError = null;
    let tasksError = null;
    
    // --- –≠–¢–ê–ü 1: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¶–µ–ª–µ–π, –ü—Ä–∏–≤—ã—á–µ–∫, –ù–∞—Å—Ç—Ä–æ–µ–Ω–∏—è (–æ–±—ä–µ–∫—Ç 'data') ---
    // (–¢–æ–ª—å–∫–æ –µ—Å–ª–∏ 'data' –≤–æ–æ–±—â–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)
    if (data) {
        localStorage.setItem(STORAGE_KEY_LOCAL, JSON.stringify(data));
        
        const payload = {
            data_key: dataKey, 
            data_json: data, 
            created_at: new Date().toISOString() 
        };
        
        const { error } = await supabase
            .from('user_data')
            .upsert(payload, { onConflict: 'data_key' });
        
        goalsHabitsMoodError = error;
    }

    // --- –≠–¢–ê–ü 2: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ó–∞–¥–∞—á (–æ—á–µ—Ä–µ–¥—å 'pendingTaskChanges') ---
    if (!goalsHabitsMoodError && pendingTaskChanges.length > 0) {
        // –ú—ã –±—É–¥–µ–º –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –æ—á–µ—Ä–µ–¥—å –∏ –æ—á–∏—â–∞—Ç—å –µ–µ –ø–æ –º–µ—Ä–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
        // –ö–æ–ø–∏—Ä—É–µ–º –æ—á–µ—Ä–µ–¥—å, —á—Ç–æ–±—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ —Å –Ω–µ–π —Ä–∞–±–æ—Ç–∞—Ç—å
        const changesToProcess = [...pendingTaskChanges];

        try {
            // --- –°–Ω–∞—á–∞–ª–∞ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –î–û–ë–ê–í–õ–ï–ù–ò–Ø ('add') ---
            // —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –Ω–∞—Å—Ç–æ—è—â–∏–µ ID –¥–ª—è 'update'
            const addActions = changesToProcess.filter(c => c.action === 'add');
            if (addActions.length > 0) {
                
                const tasksToAdd = addActions.map(action => action.payload);
                const { data: addedTasks, error: addError } = await supabase
                    .from('daily_tasks')
                    .insert(tasksToAdd)
                    .select(); // –í–∞–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç
                    
                if (addError) {
                    throw new Error(`–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–¥–∞—á: ${addError.message}`);
                }
                
                // --- –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è ID ---
                // –¢–µ–ø–µ—Ä—å –Ω–∞–º –Ω—É–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å –Ω–∞—à –ª–æ–∫–∞–ª—å–Ω—ã–π state.tasks
                // –∏ –æ—á–µ—Ä–µ–¥—å 'changesToProcess' –Ω–æ–≤—ã–º–∏ ID
                addedTasks.forEach((savedTask, index) => {
                    const tempId = addActions[index].tempId;
                    
                    // 1. –û–±–Ω–æ–≤–ª—è–µ–º state.tasks
                    const localTask = state.tasks[savedTask.task_date].find(t => t.id === tempId);
                    if (localTask) {
                        localTask.id = savedTask.id; // <--- –ì–ª–∞–≤–Ω–∞—è –∑–∞–º–µ–Ω–∞ ID
                        // –¢–∞–∫–∂–µ –º–æ–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å –¥—Ä—É–≥–∏–µ –ø–æ–ª—è, –µ—Å–ª–∏ –æ–Ω–∏ –æ—Ç–ª–∏—á–∞—é—Ç—Å—è
                        Object.assign(localTask, savedTask);
                    }
                    
                    // 2. –û–±–Ω–æ–≤–ª—è–µ–º ID –≤ –æ—Å—Ç–∞–≤—à–µ–π—Å—è —á–∞—Å—Ç–∏ –æ—á–µ—Ä–µ–¥–∏ (–¥–ª—è 'update')
                    changesToProcess.forEach(change => {
                        if (change.taskId === tempId) {
                            change.taskId = savedTask.id;
                        }
                    });
                });
            }

            // --- –ó–∞—Ç–µ–º –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –û–ë–ù–û–í–õ–ï–ù–ò–Ø ('update') ---
            const updateActions = changesToProcess.filter(c => c.action === 'update');
            if (updateActions.length > 0) {
                // –ú—ã –¥–æ–ª–∂–Ω—ã –æ—Ç–ø—Ä–∞–≤–∏—Ç—å N –∑–∞–ø—Ä–æ—Å–æ–≤, —Ç.–∫. 'upsert' –º–æ–∂–µ—Ç –±—ã—Ç—å —Å–ª–æ–∂–Ω—ã–º
                for (const action of updateActions) {
                    // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ ID –Ω–µ –≤—Ä–µ–º–µ–Ω–Ω—ã–π (–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π)
                    if (action.taskId.toString().startsWith('temp-')) {
                         console.warn("–ü—Ä–æ–ø—É—Å–∫ 'update', ID –æ—Å—Ç–∞–ª—Å—è –≤—Ä–µ–º–µ–Ω–Ω—ã–º:", action.taskId);
                         continue;
                    }
                    
                    const { error: updateError } = await supabase
                        .from('daily_tasks')
                        .update(action.payload)
                        .eq('id', action.taskId);
                        
                    if (updateError) {
                         throw new Error(`–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞–¥–∞—á–∏ ${action.taskId}: ${updateError.message}`);
                    }
                }
            }
            
            // --- –í –∫–æ–Ω—Ü–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –£–î–ê–õ–ï–ù–ò–Ø ('delete') ---
            const deleteActions = changesToProcess.filter(c => c.action === 'delete');
            if (deleteActions.length > 0) {
                 const idsToDelete = deleteActions.map(action => {
                     // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ ID –Ω–µ –≤—Ä–µ–º–µ–Ω–Ω—ã–π
                     if (!action.taskId.toString().startsWith('temp-')) {
                         return action.taskId;
                     }
                     return null;
                 }).filter(id => id !== null);

                 if(idsToDelete.length > 0) {
                    const { error: deleteError } = await supabase
                        .from('daily_tasks')
                        .delete()
                        .in('id', idsToDelete);
                        
                    if (deleteError) {
                         throw new Error(`–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–¥–∞—á: ${deleteError.message}`);
                    }
                 }
            }
            
            // –ï—Å–ª–∏ –≤—Å–µ –ø—Ä–æ—à–ª–æ —É—Å–ø–µ—à–Ω–æ, –æ—á–∏—â–∞–µ–º –û–†–ò–ì–ò–ù–ê–õ–¨–ù–£–Æ –æ—á–µ—Ä–µ–¥—å
            pendingTaskChanges = [];

        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–∞–∫–µ—Ç–Ω–æ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∑–∞–¥–∞—á:", error);
            tasksError = error;
            // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –º—ã –ù–ï –æ—á–∏—â–∞–µ–º pendingTaskChanges
            // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–º–æ–∂–µ—Ç –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å" –µ—â–µ —Ä–∞–∑
        }
    }

    hideLoading();

    // --- –≠–¢–ê–ü 3: –†–µ–∑—É–ª—å—Ç–∞—Ç ---
    if (goalsHabitsMoodError || tasksError) {
        const ghmErrorMsg = goalsHabitsMoodError ? `–¶–µ–ª–∏/–ü—Ä–∏–≤—ã—á–∫–∏: ${goalsHabitsMoodError.message}. ` : '';
        const taskErrorMsg = tasksError ? `–ó–∞–¥–∞—á–∏: ${tasksError.message}. ` : '';
        
        showNotification(`–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è. ${ghmErrorMsg}${taskErrorMsg}–î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –ª–æ–∫–∞–ª—å–Ω–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.`, 'error', 8000);
        return { status: "error", message: `${ghmErrorMsg}${taskErrorMsg}` };
// ... (–∫–æ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫) ...
    } else {
        setUnsaved(false); // <--- –°–Ω–∏–º–∞–µ–º —Ñ–ª–∞–≥ "–Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ"
        showNotification('–í—Å–µ –¥–∞–Ω–Ω—ã–µ (–ó–∞–¥–∞—á–∏, –¶–µ–ª–∏, –ü—Ä–∏–≤—ã—á–∫–∏) —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä!', 'success', 5000);
        
        // --- –§–ò–ö–° –£–î–ê–õ–ï–ù–ò–Ø/–î–£–ë–õ–ò–†–û–í–ê–ù–ò–Ø ---
        
        // 1. –û–±–Ω–æ–≤–ª—è–µ–º —Ñ–æ–Ω (–∫–∞–ª–µ–Ω–¥–∞—Ä—å)
        render(); 
        
        // 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ—Ç–∫—Ä—ã—Ç–∞ –ª–∏ –º–æ–¥–∞–ª–∫–∞ –¥–Ω—è
        if (dayModal.classList.contains('visible') && state.currentModalDate) {
            // –î–∞, –æ—Ç–∫—Ä—ã—Ç–∞. –ù–∞–º –ù–£–ñ–ù–û –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∞—Ç—å –µ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
            // –Ω–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ (—Å –Ω–∞—Å—Ç–æ—è—â–∏–º–∏ ID)
            const date = state.currentModalDate;
            modalTaskList.innerHTML = ''; // –û—á–∏—â–∞–µ–º
            
            const tasks = state.tasks[date] || [];
            if (tasks.length === 0) {
                modalTaskList.innerHTML = '<p class="no-tasks">–ó–∞–¥–∞—á –Ω–∞ —ç—Ç–æ—Ç –¥–µ–Ω—å –Ω–µ—Ç.</p>';
            } else {
                tasks.forEach(task => {
                    modalTaskList.appendChild(createTaskItemElement(task));
                });
            }
        }
        // --- –ö–û–ù–ï–¶ –§–ò–ö–°–ê ---
        
        return { status: "success" };
    }
}
saveAllBtn.onclick = saveDataToSupabase;

async function changeUsername(newNick) {
    localStorage.setItem(STORAGE_KEY_USERNAME, newNick);
    updateAuthButton();
    showNotification(`–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω–æ –Ω–∞: ${newNick} (—Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ —Ç–æ–ª—å–∫–æ –ª–æ–∫–∞–ª—å–Ω–æ)`, 'success');
    closeProfileModal();
    return { status: "success", newUsername: newNick };
}

async function deleteProfileAndData() {
    if (!supabase || !currentUserId) { 
        console.error("Supabase client or User ID not initialized."); 
        showNotification("–û—à–∏–±–∫–∞: –ö–ª–∏–µ–Ω—Ç –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω.", 'error');
        return; 
    }
    
    const dataKey = localStorage.getItem(STORAGE_KEY_AUTH); // –ö–ª—é—á –¥–ª—è user_data
    const currentUsername = localStorage.getItem(STORAGE_KEY_USERNAME);
    
    if (!dataKey) { 
        alert("–û—à–∏–±–∫–∞: –Ω–µ—Ç –∫–ª—é—á–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏."); 
        return; 
    }
    
    if (!confirm("–í–ù–ò–ú–ê–ù–ò–ï! –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –£–î–ê–õ–ò–¢–¨ –í–°–ï –¥–∞–Ω–Ω—ã–µ –∏ –ø—Ä–æ—Ñ–∏–ª—å? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ!")) { 
        return; 
    }
    
    const confirmText = prompt(`–î–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è –≤–≤–µ–¥–∏—Ç–µ —Å–≤–æ–π –Ω–∏–∫: ${currentUsername}`);
    if (confirmText !== currentUsername) { 
        alert("–í–≤–µ–¥–µ–Ω–Ω—ã–π –Ω–∏–∫ –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç. –£–¥–∞–ª–µ–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ."); 
        return; 
    }

    showLoading();

    // 1. –£–¥–∞–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –æ —Ü–µ–ª—è—Ö/–ø—Ä–∏–≤—ã—á–∫–∞—Ö (–∏–∑ user_data)
    const { error: dataError } = await supabase
        .from('user_data')
        .delete()
        .eq('data_key', dataKey); 

    // 2. –£–¥–∞–ª—è–µ–º –í–°–ï –∑–∞–¥–∞—á–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—è (–∏–∑ daily_tasks)
    const { error: tasksError } = await supabase
        .from('daily_tasks')
        .delete()
        .eq('user_id', currentUserId); // –ò—Å–ø–æ–ª—å–∑—É–µ–º ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

    hideLoading();

    if (dataError || tasksError) {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö:", dataError || tasksError);
        showNotification(`–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö: ${ (dataError || tasksError).message}. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.`, 'error', 8000);
        return; // –ù–µ –≤—ã—Ö–æ–¥–∏–º –∏–∑ —Å–∏—Å—Ç–µ–º—ã, –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –Ω–µ —É–¥–∞–ª–∏–ª–∏—Å—å
    }

    // 3. –í—ã—Ö–æ–¥–∏–º –∏–∑ —Å–∏—Å—Ç–µ–º—ã (–∑–∞–≤–µ—Ä—à–∞–µ–º —Å–µ—Å—Å–∏—é Supabase)
    await supabase.auth.signOut();

    // 4. –û—á–∏—â–∞–µ–º –í–ï–°–¨ localStorage (–≤–∫–ª—é—á–∞—è –ª–µ–∫–∞—Ä—Å—Ç–≤–∞ –∏ —Ç.–¥.)
    localStorage.removeItem(STORAGE_KEY_AUTH);
    localStorage.removeItem(STORAGE_KEY_USERNAME);
    localStorage.removeItem(STORAGE_KEY_LOCAL);
    localStorage.removeItem(STORAGE_KEY_UNSAVED);
    localStorage.removeItem('plannerMeds_v1_local');
    // (–ï—Å–ª–∏ –µ—Å—Ç—å –µ—â–µ –∫–ª—é—á–∏, —Ç–∏–ø–∞ plannerLists, –¥–æ–±–∞–≤—å –∏—Ö —Å—é–¥–∞)

    // 5. –°–æ–æ–±—â–∞–µ–º –∏ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º
    alert("–í–∞—à –ø—Ä–æ—Ñ–∏–ª—å –∏ –≤—Å–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (—Ü–µ–ª–∏, –ø—Ä–∏–≤—ã—á–∫–∏, –∑–∞–¥–∞—á–∏) –±—ã–ª–∏ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω—ã.");
    window.location.href = 'login.html';
}


// =================================================================
// 3. –§–£–ù–ö–¶–ò–ò –õ–ò–ß–ù–û–ì–û –ö–ê–ë–ò–ù–ï–¢–ê
// =================================================================

const usernameDisplay = document.getElementById('usernameDisplay');
const profileModal = document.getElementById('profileModal');
const nickInput = document.getElementById('nickInput');

function calculateTaskStats() {
    let completed = 0;
    let uncompleted = 0;

    // state.tasks - —ç—Ç–æ –≥–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—ä–µ–∫—Ç, –≥–¥–µ –ª–µ–∂–∞—Ç –≤—Å–µ –∑–∞–¥–∞—á–∏
    if (!state || !state.tasks) {
        console.warn("calculateTaskStats: state.tasks –Ω–µ –Ω–∞–π–¥–µ–Ω.");
        return { completed: 0, uncompleted: 0 };
    }

    // –ü–µ—Ä–µ–±–∏—Ä–∞–µ–º –≤—Å–µ –∫–ª—é—á–∏ (–¥–∞—Ç—ã) –≤ –æ–±—ä–µ–∫—Ç–µ state.tasks
    for (const date in state.tasks) {
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ —ç—Ç–æ–º—É –∫–ª—é—á—É –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –º–∞—Å—Å–∏–≤
        if (Array.isArray(state.tasks[date])) {
            
            // –ü–µ—Ä–µ–±–∏—Ä–∞–µ–º –∫–∞–∂–¥—É—é –∑–∞–¥–∞—á—É –≤ –º–∞—Å—Å–∏–≤–µ
            state.tasks[date].forEach(task => {
                if (task.is_done) {
                    completed++;
                } else {
                    uncompleted++;
                }
            });
        }
    }
    
    return { completed, uncompleted };
}

function updateAuthButton() {
    const username = localStorage.getItem(STORAGE_KEY_USERNAME);
    usernameDisplay.textContent = username || '–ü—Ä–æ—Ñ–∏–ª—å';
}
function handleAccountControlClick() { openProfileModal(); }

function openProfileModal() {
    nickInput.value = localStorage.getItem(STORAGE_KEY_USERNAME) || '';
    
    // –°—á–∏—Ç–∞–µ–º –∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É (–ø–æ–∫–∞ –∑–∞–≥–ª—É—à–∫–∞)
    const stats = calculateTaskStats();
    const completedEl = document.getElementById('completedTasksCount');
    const uncompletedEl = document.getElementById('uncompletedTasksCount');
    
    if (completedEl) completedEl.textContent = stats.completed;
    if (uncompletedEl) uncompletedEl.textContent = stats.uncompleted;
    
    profileModal.style.display='flex';
    setTimeout(()=>profileModal.classList.add('visible'), 10);
}

function closeProfileModal() {
    profileModal.classList.remove('visible');
    setTimeout(() => { profileModal.style.display='none'; }, 300);
}

// archiveAllMonths() —É–¥–∞–ª–µ–Ω–∞

document.getElementById('saveNickBtn').onclick = async () => {
    const newNick = nickInput.value.trim();
    if (!newNick) { 
        showNotification("–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º.", 'warning'); 
        return; 
    }
    if (newNick === localStorage.getItem(STORAGE_KEY_USERNAME)) { closeProfileModal(); return; }
    await changeUsername(newNick); 
};
document.getElementById('logoutBtn').onclick = async () => {
    // --- –ò–ó–ú–ï–ù–ï–ù–û: –û–±–Ω–æ–≤–ª–µ–Ω —Ç–µ–∫—Å—Ç confirm ---
    if (localStorage.getItem(STORAGE_KEY_UNSAVED) === 'true') {
        if (!confirm("–£ –≤–∞—Å –µ—Å—Ç—å –Ω–µ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è (–ó–∞–¥–∞—á–∏, –¶–µ–ª–∏, –ü—Ä–∏–≤—ã—á–∫–∏), –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –±—ã–ª–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä. –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏ –∏ –ø–æ—Ç–µ—Ä—è—Ç—å –∏—Ö?")) {
            return; 
        }
    }
    showLoading(); 
    
    if (supabase) {
        const { error } = await supabase.auth.signOut();
        if (error) {
            console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ –∏–∑ Supabase:", error);
            showNotification("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.", 'error');
            hideLoading(); 
            return; 
        }
    }
    
    // --- –î–û–ë–ê–í–õ–ï–ù–û: –û—á–∏—â–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—É—é –æ—á–µ—Ä–µ–¥—å –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ ---
    pendingTaskChanges = []; 
    
    // –û—á–∏—â–∞–µ–º –í–°–ï –ª–æ–∫–∞–ª—å–Ω—ã–µ –∫–ª—é—á–∏
    localStorage.removeItem(STORAGE_KEY_AUTH); 
    localStorage.removeItem(STORAGE_KEY_USERNAME); 
    localStorage.removeItem(STORAGE_KEY_LOCAL); 
    localStorage.removeItem(STORAGE_KEY_UNSAVED); 
    localStorage.removeItem('plannerMeds_v1_local'); 
    
    window.location.href = 'login.html';
};
document.getElementById('deleteProfileBtn').onclick = deleteProfileAndData;


// --- –§—É–Ω–∫—Ü–∏–∏ –∫–æ—Ä–∑–∏–Ω—ã –∏ —Å—Ç–∞—Ä—ã—Ö –Ω–µ–¥–µ–ª—å —É–¥–∞–ª–µ–Ω—ã ---

/* --- –¶–ï–õ–ò (Goal Styles) --- */
const goalsList=document.getElementById('goalsList');
function renderGoals(){
    goalsList.innerHTML='';
    data.goals.forEach((t,i)=>{
        const div=document.createElement('div'); div.className='goal'; div.contentEditable=true; div.innerText=t;
        div.addEventListener('input',()=> { data.goals[i] = div.innerText.replace(/√ó/g, '').trim(); save(); });
        const rm=document.createElement('span'); rm.className='goal-remove'; rm.innerText='√ó';
        rm.onclick=()=>{data.goals.splice(i,1); save(); renderGoals(); };
        div.appendChild(rm);
        goalsList.appendChild(div);
    });
}
document.getElementById('addGoalBtn').onclick=()=>{
    if (data.goals.length >= 3) {
        showNotification('–ú–∞–∫—Å–∏–º—É–º 3 –≥–æ–¥–æ–≤—ã–µ —Ü–µ–ª–∏.', 'warning', 5000);
        return; 
    }
    data.goals.push('–ù–æ–≤–∞—è —Ü–µ–ª—å');
    save();
    renderGoals();
};

// --- –§—É–Ω–∫—Ü–∏–∏ –Ω–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã—Ö, –º–µ—Å—è—Ü–µ–≤, –∞—Ä—Ö–∏–≤–∞, –º–æ–¥–∞–ª–∫–∏ –Ω–µ–¥–µ–ª–∏ –£–î–ê–õ–ï–ù–´ ---


// =================================================================
// 4. –ù–û–í–´–ô –ë–õ–û–ö: –õ–û–ì–ò–ö–ê –ö–ê–õ–ï–ù–î–ê–†–Ø
// =================================================================

// --- –≠–õ–ï–ú–ï–ù–¢–´ DOM –ö–ê–õ–ï–ù–î–ê–†–Ø ---
const currentMonthDisplay = document.getElementById('current-month-display');
const calendarGrid = document.getElementById('calendar-grid');
const weekViewContainer = document.getElementById('week-view-container');
const prevBtn = document.getElementById('prev-btn');
const nextBtn = document.getElementById('next-btn');
const todayBtn = document.getElementById('today-btn');
const monthViewBtn = document.getElementById('month-view-btn');
const weekViewBtn = document.getElementById('week-view-btn');
const monthView = document.getElementById('month-view');
const weekView = document.getElementById('week-view');

const dayModal = document.getElementById('day-modal');
const closeModalBtn = document.getElementById('close-modal');
const modalDateDisplay = document.getElementById('modal-date-display');
const modalTaskList = document.getElementById('modal-task-list');
const addTaskFormModal = document.getElementById('add-task-form-modal');
const newTaskTimeInput = document.getElementById('new-task-time');
const newTaskTextInput = document.getElementById('new-task-text');

// --- –ì–õ–û–ë–ê–õ–¨–ù–û–ï –°–û–°–¢–û–Ø–ù–ò–ï –ö–ê–õ–ï–ù–î–ê–†–Ø ---
let state = {
    tasks: {}, // { 'YYYY-MM-DD': [task1, task2] }
    currentDate: new Date(),
    currentView: 'month', // 'month' or 'week'
    currentModalDate: null, // 'YYYY-MM-DD'
    currentRecurTask: null
};
const monthNames = ['–Ø–Ω–≤–∞—Ä—å', '–§–µ–≤—Ä–∞–ª—å', '–ú–∞—Ä—Ç', '–ê–ø—Ä–µ–ª—å', '–ú–∞–π', '–ò—é–Ω—å', '–ò—é–ª—å', '–ê–≤–≥—É—Å—Ç', '–°–µ–Ω—Ç—è–±—Ä—å', '–û–∫—Ç—è–±—Ä—å', '–ù–æ—è–±—Ä—å', '–î–µ–∫–∞–±—Ä—å'];
const dayNames = ['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–í—Å'];

// --- –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò –ö–ê–õ–ï–ù–î–ê–†–Ø ---

function getISODate(date) {
    const year = date.getFullYear();
    const month = (date.getMonth() + 1).toString().padStart(2, '0');
    const day = date.getDate().toString().padStart(2, '0');
    return `${year}-${month}-${day}`;
}

function getMonthDays(year, month) {
    const days = [];
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    
    let dayOfWeek = firstDay.getDay();
    if (dayOfWeek === 0) dayOfWeek = 7;
    
    const prevMonthLastDay = new Date(year, month, 0).getDate();
    for (let i = dayOfWeek - 1; i > 0; i--) {
        const date = new Date(year, month - 1, prevMonthLastDay - i + 1);
        days.push({ date: date, isCurrentMonth: false });
    }
    
    for (let i = 1; i <= lastDay.getDate(); i++) {
        const date = new Date(year, month, i);
        days.push({ date: date, isCurrentMonth: true });
    }
    
    const nextDays = 42 - days.length;
    for (let i = 1; i <= nextDays; i++) {
        const date = new Date(year, month + 1, i);
        days.push({ date: date, isCurrentMonth: false });
    }
    
    return days;
}

function getWeekDays(date) {
    const days = [];
    let dayOfWeek = date.getDay();
    if (dayOfWeek === 0) dayOfWeek = 7; // –í—Å = 7
    
    const monday = new Date(date);
    monday.setDate(date.getDate() - (dayOfWeek - 1));
    
    for (let i = 0; i < 7; i++) {
        const weekDay = new Date(monday);
        weekDay.setDate(monday.getDate() + i);
        days.push(weekDay);
    }
    return days;
}

// --- –õ–û–ì–ò–ö–ê SUPABASE –ö–ê–õ–ï–ù–î–ê–†–Ø ---

async function fetchTasks() {
    if (!supabase || !currentUserId) return;
    
    showLoading();
    const { data, error } = await supabase
        .from('daily_tasks')
        .select('*')
        .eq('user_id', currentUserId);
        
    hideLoading();
    
    if (error) {
        console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞—á:", error);
        return;
    }
    
    state.tasks = data.reduce((acc, task) => {
        const date = task.task_date;
        if (!acc[date]) {
            acc[date] = [];
        }
        acc[date].push(task);
        return acc;
    }, {});
    
    for (const date in state.tasks) {
        state.tasks[date].sort((a, b) => (a.time || '').localeCompare(b.time || ''));
    }
}
/* --- –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–¥–∞—á–∏ (UI) --- */
async function handleDeleteTask(taskId) {
    // 1. –ü—Ä–æ—Å–∏–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
    if (!confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–¥–∞—á—É?")) {
        return; 
    }
    
    // 2. –ù–∞—Ö–æ–¥–∏–º —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É (–ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ –º–æ–¥–∞–ª–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∞)
    const date = state.currentModalDate; 
    
    // 3. –í—ã–∑—ã–≤–∞–µ–º core —Ñ—É–Ω–∫—Ü–∏—é, –∫–æ—Ç–æ—Ä–∞—è —É–¥–∞–ª—è–µ—Ç –ª–æ–∫–∞–ª—å–Ω–æ –∏ –¥–æ–±–∞–≤–ª—è–µ—Ç –≤ –æ—á–µ—Ä–µ–¥—å
    const success = await deleteTask(taskId);
    
    if (success) {
        // 4. –£–¥–∞–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç –∑–∞–¥–∞—á–∏ –∏–∑ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ (UI)
        const taskItem = document.querySelector(`.task-item[data-id="${taskId}"]`);
        if (taskItem) {
            taskItem.remove();
        }

        // 5. –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ—Å—Ç–∞–ª–∏—Å—å –ª–∏ –∑–∞–¥–∞—á–∏, –∏ –µ—Å–ª–∏ –Ω–µ—Ç, –¥–æ–±–∞–≤–ª—è–µ–º "–ó–∞–¥–∞—á –Ω–µ—Ç"
        if (date && state.tasks[date] && state.tasks[date].length === 0) {
             modalTaskList.innerHTML = '<p class="no-tasks">–ó–∞–¥–∞—á –Ω–∞ —ç—Ç–æ—Ç –¥–µ–Ω—å –Ω–µ—Ç.</p>';
        }
        
        // 6. –û–±–Ω–æ–≤–ª—è–µ–º —Ñ–æ–Ω –∫–∞–ª–µ–Ω–¥–∞—Ä—è (—É–¥–∞–ª—è–µ–º/–æ–±–Ω–æ–≤–ª—è–µ–º —Ü–≤–µ—Ç–Ω—É—é —Ç–æ—á–∫—É)
        render(); 
        
        // 7. –°–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é
        document.querySelectorAll('.task-item-menu.visible').forEach(m => m.classList.remove('visible'));
    } else {
         // –≠—Ç–æ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç, –µ—Å–ª–∏ deleteTask –≤–µ—Ä–Ω—É–ª false
         console.error("–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É:", taskId);
         showNotification("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ª–æ–∫–∞–ª—å–Ω–æ–º —É–¥–∞–ª–µ–Ω–∏–∏ –∑–∞–¥–∞—á–∏.", 'error');
    }
}
async function addTask(date, time, text) {
    if (!currentUserId) return null; // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π

    // 1. –°–æ–∑–¥–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –æ–±—ä–µ–∫—Ç –∑–∞–¥–∞—á–∏
    const tempId = `temp-${Date.now()}-${Math.random()}`;
    const localTask = {
        id: tempId, // –í—Ä–µ–º–µ–Ω–Ω—ã–π ID
        user_id: currentUserId,
        task_date: date,
        time: time,
        text: text,
        is_done: false,
        created_at: new Date().toISOString() // –î–æ–±–∞–≤–ª—è–µ–º, —Ç.–∫. Supabase –±—ã —ç—Ç–æ —Å–¥–µ–ª–∞–ª
    };

    // 2. –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–¥–∞—á—É –≤ –ª–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    if (!state.tasks[date]) {
        state.tasks[date] = [];
    }
    state.tasks[date].push(localTask);
    state.tasks[date].sort((a, b) => (a.time || '').localeCompare(b.time || ''));

    // 3. –î–æ–±–∞–≤–ª—è–µ–º –≤ –æ—á–µ—Ä–µ–¥—å –Ω–∞ "–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ"
    // –ú—ã –ø–µ—Ä–µ–¥–∞–µ–º 'localTask', —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å–µ –ø–æ–ª—è
    pendingTaskChanges.push({ 
        action: 'add', 
        tempId: tempId, // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π ID
        payload: { // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ç–æ, —á—Ç–æ –Ω—É–∂–Ω–æ Supabase
            user_id: currentUserId,
            task_date: date,
            time: time,
            text: text,
            is_done: false
        }
    });

    // 4. –ü–æ–º–µ—á–∞–µ–º, —á—Ç–æ –µ—Å—Ç—å –Ω–µ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
    setUnsaved(true);
    
    // 5. –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—É—é –∑–∞–¥–∞—á—É, —á—Ç–æ–±—ã UI –º–æ–≥ –µ–µ –æ—Ç—Ä–∏—Å–æ–≤–∞—Ç—å
    return localTask;
}

async function updateTaskStatus(taskId, isDone) {
    // 1. –ù–∞—Ö–æ–¥–∏–º –∑–∞–¥–∞—á—É –≤ –ª–æ–∫–∞–ª—å–Ω–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –µ–µ
    let localTask = null;
    for (const date in state.tasks) {
        localTask = state.tasks[date].find(t => t.id === taskId);
        if (localTask) {
            localTask.is_done = isDone;
            break;
        }
    }

    if (!localTask) {
        console.error("–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –∑–∞–¥–∞—á—É –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤ state.tasks:", taskId);
        return;
    }

    // 2. –î–æ–±–∞–≤–ª—è–µ–º –≤ –æ—á–µ—Ä–µ–¥—å –Ω–∞ "–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ"
    
    // –°—Ü–µ–Ω–∞—Ä–∏–π 1: –≠—Ç–æ –ù–û–í–ê–Ø, –µ—â–µ –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–∞—è –∑–∞–¥–∞—á–∞ (ID –≤—Ä–µ–º–µ–Ω–Ω—ã–π)
    if (taskId.toString().startsWith('temp-')) {
        const addAction = pendingTaskChanges.find(c => c.action === 'add' && c.tempId === taskId);
        if (addAction) {
            // –ü—Ä–æ—Å—Ç–æ –æ–±–Ω–æ–≤–ª—è–µ–º 'is_done' –≤ –æ–±—ä–µ–∫—Ç–µ, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω
            addAction.payload.is_done = isDone;
        } else {
            console.error("–ù–µ –Ω–∞–π–¥–µ–Ω–æ 'add' –¥–µ–π—Å—Ç–≤–∏–µ –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω–æ–π –∑–∞–¥–∞—á–∏:", taskId);
        }
    } 
    // –°—Ü–µ–Ω–∞—Ä–∏–π 2: –≠—Ç–æ –°–¢–ê–†–ê–Ø, —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è –∑–∞–¥–∞—á–∞ (ID –Ω–∞—Å—Ç–æ—è—â–∏–π)
    else {
        const existingChange = pendingTaskChanges.find(c => c.action === 'update' && c.taskId === taskId);
        if (existingChange) {
            // –ï—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å 'update' –¥–ª—è —ç—Ç–æ–π –∑–∞–¥–∞—á–∏, –æ–±–Ω–æ–≤–ª—è–µ–º –µ–≥–æ
            existingChange.payload.is_done = isDone;
        } else {
            // –ï—Å–ª–∏ –Ω–µ—Ç, –¥–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ 'update' –¥–µ–π—Å—Ç–≤–∏–µ
            pendingTaskChanges.push({
                action: 'update',
                taskId: taskId,
                payload: { is_done: isDone }
            });
        }
    }

    // 3. –ü–æ–º–µ—á–∞–µ–º, —á—Ç–æ –µ—Å—Ç—å –Ω–µ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
    setUnsaved(true);
}

async function deleteTask(taskId) {
    // 1. –£–¥–∞–ª—è–µ–º –∑–∞–¥–∞—á—É –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
    let taskFoundAndRemoved = false;
    for (const date in state.tasks) {
        const index = state.tasks[date].findIndex(t => t.id === taskId);
        if (index > -1) {
            state.tasks[date].splice(index, 1);
            taskFoundAndRemoved = true;
            break;
        }
    }

    if (!taskFoundAndRemoved) {
        console.error("–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –∑–∞–¥–∞—á—É –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –≤ state.tasks:", taskId);
        return false; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º false, –∫–∞–∫ –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª–µ
    }

    // 2. –î–æ–±–∞–≤–ª—è–µ–º –≤ –æ—á–µ—Ä–µ–¥—å –Ω–∞ "—É–¥–∞–ª–µ–Ω–∏–µ"

    // –°—Ü–µ–Ω–∞—Ä–∏–π 1: –≠—Ç–æ –ù–û–í–ê–Ø, –µ—â–µ –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–∞—è –∑–∞–¥–∞—á–∞ (ID –≤—Ä–µ–º–µ–Ω–Ω—ã–π)
    if (taskId.toString().startsWith('temp-')) {
        // –ù–∞–º –Ω—É–∂–Ω–æ –ø—Ä–æ—Å—Ç–æ —É–¥–∞–ª–∏—Ç—å 'add' –¥–µ–π—Å—Ç–≤–∏–µ –∏–∑ –æ—á–µ—Ä–µ–¥–∏
        const index = pendingTaskChanges.findIndex(c => c.action === 'add' && c.tempId === taskId);
        if (index > -1) {
            pendingTaskChanges.splice(index, 1);
        }
        // –¢–∞–∫–∂–µ —É–¥–∞–ª—è–µ–º –ª—é–±—ã–µ 'update', —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –Ω–µ–π (—Ö–æ—Ç—è –∏—Ö –±—ã—Ç—å –Ω–µ –¥–æ–ª–∂–Ω–æ)
        const updateIndex = pendingTaskChanges.findIndex(c => c.action === 'update' && c.taskId === taskId);
         if (updateIndex > -1) {
            pendingTaskChanges.splice(updateIndex, 1);
        }
    }
    // –°—Ü–µ–Ω–∞—Ä–∏–π 2: –≠—Ç–æ –°–¢–ê–†–ê–Ø, —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è –∑–∞–¥–∞—á–∞ (ID –Ω–∞—Å—Ç–æ—è—â–∏–π)
    else {
        // –î–æ–±–∞–≤–ª—è–µ–º 'delete' –¥–µ–π—Å—Ç–≤–∏–µ
        // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –Ω–µ—Ç –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
        if (!pendingTaskChanges.some(c => c.action === 'delete' && c.taskId === taskId)) {
            pendingTaskChanges.push({
                action: 'delete',
                taskId: taskId
            });
        }
        // –ï—Å–ª–∏ –≤ –æ—á–µ—Ä–µ–¥–∏ –±—ã–ª–∏ 'update' –¥–ª—è —ç—Ç–æ–π –∑–∞–¥–∞—á–∏, –æ–Ω–∏ –±–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–Ω—ã
        pendingTaskChanges = pendingTaskChanges.filter(c => !(c.action === 'update' && c.taskId === taskId));
    }
    
    // 3. –ü–æ–º–µ—á–∞–µ–º, —á—Ç–æ –µ—Å—Ç—å –Ω–µ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
    setUnsaved(true);
    
    // 4. –í–æ–∑–≤—Ä–∞—â–∞–µ–º true, –∫–∞–∫ –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª–µ
    return true;
}

// --- –õ–û–ì–ò–ö–ê –†–ï–ù–î–ï–†–ò–ù–ì–ê –ö–ê–õ–ï–ù–î–ê–†–Ø ---

function render() {
    const year = state.currentDate.getFullYear();
    const month = state.currentDate.getMonth();
    
    currentMonthDisplay.textContent = `${monthNames[month]} ${year}`;
    
    if (state.currentView === 'month') {
        renderMonthView(year, month);
        monthView.style.display = 'block';
        weekView.style.display = 'none';
        monthViewBtn.classList.add('active');
        weekViewBtn.classList.remove('active');
    } else {
        renderWeekView(state.currentDate);
        monthView.style.display = 'none';
        weekView.style.display = 'block';
        monthViewBtn.classList.remove('active');
        weekViewBtn.classList.add('active');
    }
}

function renderMonthView(year, month) {
    calendarGrid.innerHTML = '';
    const days = getMonthDays(year, month);
    const todayISO = getISODate(new Date());
    
    days.forEach(dayObj => {
        const dayEl = document.createElement('div');
        dayEl.className = 'calendar-day';
        const dateISO = getISODate(dayObj.date);
        
        if (!dayObj.isCurrentMonth) {
            dayEl.classList.add('other-month');
        }
        
        if (dateISO === todayISO) {
            dayEl.classList.add('today');
        }
        
        const dayNumber = document.createElement('div');
        dayNumber.className = 'day-number';
        dayNumber.textContent = dayObj.date.getDate();
        dayEl.appendChild(dayNumber);
        
        const tasks = state.tasks[dateISO] || [];
        if (tasks.length > 0) {
            const tasksPreview = document.createElement('div');
            tasksPreview.className = 'tasks-preview';
            
            tasks.slice(0, 5).forEach(task => { 
                const taskPill = document.createElement('div');
                taskPill.className = 'task-preview-item';
                if (task.is_done) {
                    taskPill.classList.add('done');
                }
                
                if (task.time) {
                    taskPill.innerHTML = `<span class="task-preview-time">${task.time.slice(0, 5)}</span>`;
                } else {
                    taskPill.innerHTML = `<span class="task-preview-time">‚Ä¢</span>`;
                }
                tasksPreview.appendChild(taskPill);
            });
            
            if (tasks.length > 5) {
                 const morePill = document.createElement('div');
                 morePill.className = 'task-preview-item';
                 morePill.textContent = `...`;
                 tasksPreview.appendChild(morePill);
            }
            
            dayEl.appendChild(tasksPreview);
        }
        
        if (dayObj.isCurrentMonth) {
            dayEl.onclick = () => openDayModal(dateISO);
        }
        
        calendarGrid.appendChild(dayEl);
    });
}

function renderWeekView(date) {
    weekViewContainer.innerHTML = '';
    const days = getWeekDays(date);
    const todayISO = getISODate(new Date());
    
    days.forEach((day, index) => {
        const dateISO = getISODate(day);
        const dayCol = document.createElement('div');
        dayCol.className = 'week-day-column';
        if (dateISO === todayISO) {
            dayCol.classList.add('today');
        }
        
        const dayHeader = document.createElement('div');
        dayHeader.className = 'week-day-header';
        dayHeader.innerHTML = `
            <h3>${dayNames[index]}</h3>
            <div class="date-display">${day.toLocaleDateString('ru-RU', { day: '2-digit', month: 'long' })}</div>
        `;
        dayCol.appendChild(dayHeader);
        
        const taskList = document.createElement('div');
        taskList.className = 'task-list-week';
        dayCol.appendChild(taskList);
        
        const tasks = state.tasks[dateISO] || [];
        if (tasks.length === 0) {
            taskList.innerHTML = '<p class="no-tasks">–ó–∞–¥–∞—á –Ω–µ—Ç.</p>';
        } else {
            tasks.forEach(task => {
                taskList.appendChild(createTaskItemElement(task));
            });
        }
        
        const addForm = document.createElement('form');
        addForm.className = 'add-task-form-week';
        addForm.action = "javascript:void(0);";
        addForm.innerHTML = `
            <div class="form-inputs-week">
                <input type="text" class="week-task-text" placeholder="–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞..." required>
                <input type="time" class="week-task-time" required>
            </div>
            <button type="submit" class="btn btn-primary" title="–î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É">
                <svg class="send-icon" viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path></svg>
            </button>
        `;
        
        addForm.onsubmit = async (e) => {
            const timeInput = e.target.querySelector('.week-task-time');
            const textInput = e.target.querySelector('.week-task-text');
            
            const newTask = await addTask(dateISO, timeInput.value, textInput.value);
            if (newTask) {
                if (!state.tasks[dateISO]) state.tasks[dateISO] = [];
                state.tasks[dateISO].push(newTask);
                state.tasks[dateISO].sort((a, b) => (a.time || '').localeCompare(b.time || ''));
                
                timeInput.value = '';
                textInput.value = '';
                render(); 
            }
        };
        
        dayCol.appendChild(addForm);
        weekViewContainer.appendChild(dayCol);
    });
}

// --- –õ–û–ì–ò–ö–ê –ú–û–î–ê–õ–¨–ù–û–ì–û –û–ö–ù–ê –ö–ê–õ–ï–ù–î–ê–†–Ø ---

async function handleModalAddTask() {
    const time = newTaskTimeInput.value;
    const text = newTaskTextInput.value.trim();
    const date = state.currentModalDate;
    
    if (!text || !date) return;
    
    // 1. –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–¥–∞—á—É –≤ –ª–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (state.tasks)
    // –û–Ω–∞ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –∏ —Å—Ä–∞–∑—É —Å–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ addTask
    const newTask = await addTask(date, time, text);
    
    if (newTask) {
        // 2. –û—á–∏—â–∞–µ–º –ø–æ–ª—è –≤–≤–æ–¥–∞
        newTaskTimeInput.value = '';
        newTaskTextInput.value = '';
        
        // --- –§–ò–ù–ê–õ–¨–ù–´–ô –§–ò–ö–° –î–£–ë–õ–ò–†–û–í–ê–ù–ò–Ø –ò –°–û–†–¢–ò–†–û–í–ö–ò ---
        
        // 3. –ü–æ–ª–Ω–æ—Å—Ç—å—é –æ—á–∏—â–∞–µ–º DOM-—ç–ª–µ–º–µ–Ω—Ç —Å–ø–∏—Å–∫–∞ –∑–∞–¥–∞—á –≤ –º–æ–¥–∞–ª–∫–µ
        // –≠—Ç–æ —Å–∞–º—ã–π –Ω–∞–¥–µ–∂–Ω—ã–π —Å–ø–æ—Å–æ–± –∏–∑–±–µ–∂–∞—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è
        modalTaskList.innerHTML = ''; 
        
        // 4. –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–π (–∏ –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π) —Å–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á
        const tasks = state.tasks[date] || [];

        if (tasks.length === 0) {
            modalTaskList.innerHTML = '<p class="no-tasks">–ó–∞–¥–∞—á –Ω–∞ —ç—Ç–æ—Ç –¥–µ–Ω—å –Ω–µ—Ç.</p>';
        } else {
            // 5. –ü–µ—Ä–µ—Å–æ–∑–¥–∞–µ–º –∏ –¥–æ–±–∞–≤–ª—è–µ–º –í–°–ï —ç–ª–µ–º–µ–Ω—Ç—ã –∑–∞–Ω–æ–≤–æ
            // –ï—Å–ª–∏ –≤ state.tasks –≤—Å–µ–≥–æ 1 –∑–∞–¥–∞—á–∞, –æ–Ω–∞ —Å–æ–∑–¥–∞—Å—Ç—Å—è —Ç–æ–ª—å–∫–æ 1 —Ä–∞–∑.
            tasks.forEach(task => {
                modalTaskList.appendChild(createTaskItemElement(task));
            });
        }
        
        // 6. –û–±–Ω–æ–≤–ª—è–µ–º —Ñ–æ–Ω (–∫–∞–ª–µ–Ω–¥–∞—Ä—å) - —ç—Ç–æ –Ω—É–∂–Ω–æ —Ç–æ–ª—å–∫–æ –¥–ª—è —Ü–≤–µ—Ç–Ω–æ–π —Ç–æ—á–∫–∏
        render(); 
        
        // --- –ö–û–ù–ï–¶ –§–ò–ö–°–ê ---
    }
}

function handleDownloadTask(task) {
    const content = `–ó–∞–¥–∞—á–∞: ${task.text}\n–î–∞—Ç–∞: ${task.task_date}\n–í—Ä–µ–º—è: ${task.time || '–í–µ—Å—å –¥–µ–Ω—å'}\n–°—Ç–∞—Ç—É—Å: ${task.is_done ? '–í—ã–ø–æ–ª–Ω–µ–Ω–æ' : '–ù–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ'}`;
    const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    const safeFileName = task.text.replace(/[^a-z0-9–∞-—è\s]/gi, '_').substring(0, 30);
    a.download = `–ó–∞–¥–∞—á–∞_${safeFileName}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

function openRecurModal(task) {
    const modal = document.getElementById('recur-modal');
    state.currentRecurTask = task; 
    
    document.getElementById('recur-type').value = 'weekly';
    document.getElementById('recur-weekly-days').querySelectorAll('input').forEach(cb => cb.checked = false);
    document.getElementById('recur-custom-days').value = '2';
    document.getElementById('recur-end-date').value = '';

    document.getElementById('recur-weekly-options').style.display = 'block';
    document.getElementById('recur-custom-options').style.display = 'none';

    modal.style.display = 'flex';
    setTimeout(() => modal.classList.add('visible'), 10);
}


function createTaskItemElement(task) {
    const taskEl = document.createElement('div');
    taskEl.className = 'task-item';
    // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ dataset.taskId - –ü—Ä–∞–≤–∏–ª—å–Ω–æ!
    taskEl.dataset.taskId = task.id; 
    if (task.is_done) {
        taskEl.classList.add('done');
    }
    
    const checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.className = 'task-item-checkbox';
    checkbox.checked = task.is_done;
    checkbox.onchange = async () => {
        const newStatus = checkbox.checked;
        await updateTaskStatus(task.id, newStatus);
        
        task.is_done = newStatus;
        taskEl.classList.toggle('done', newStatus);
        render(); // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ü–∏—é –Ω–∞ —Ñ–æ–Ω–µ
    };
    
    const timeEl = document.createElement('span');
    timeEl.className = 'task-item-time';
    timeEl.textContent = task.time ? task.time.slice(0, 5) : '–í–µ—Å—å –¥–µ–Ω—å';
    
    const textEl = document.createElement('span');
    textEl.className = 'task-item-text';
    textEl.textContent = task.text;
    
    const moreBtn = document.createElement('button');
    moreBtn.className = 'task-item-more';
    moreBtn.innerHTML = '‚ãÆ'; 
    moreBtn.title = '–û–ø—Ü–∏–∏';

    const menu = document.createElement('div');
    menu.className = 'task-item-menu';
    menu.innerHTML = `
        <div class="task-menu-item" data-action="delete">–£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É</div>
        <div class="task-menu-item" data-action="download">–°–∫–∞—á–∞—Ç—å (.txt)</div>
        <div class="task-menu-item" data-action="recur">–°–¥–µ–ª–∞—Ç—å —Ä–µ–≥—É–ª—è—Ä–Ω–æ–π</div>
    `;
    
    moreBtn.onclick = (e) => {
        e.stopPropagation();
        document.querySelectorAll('.task-item-menu.visible').forEach(m => {
            if (m !== menu) m.classList.remove('visible');
        });
        menu.classList.toggle('visible');
    };
    
    menu.onclick = (e) => {
        e.stopPropagation();
        const target = e.target.closest('.task-menu-item');
        if (!target) return;
        
        const action = target.dataset.action;
        
        if (action === 'delete') {
            // --- –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü–µ—Ä–µ–¥–∞–µ–º –¢–û–õ–¨–ö–û ID –∑–∞–¥–∞—á–∏ ---
            handleDeleteTask(task.id); 
        }
        if (action === 'download') {
            handleDownloadTask(task);
        }
        if (action === 'recur') {
            openRecurModal(task);
        }
        
        menu.classList.remove('visible'); 
    };

    taskEl.appendChild(checkbox);
    taskEl.appendChild(timeEl);
    taskEl.appendChild(textEl);
    taskEl.appendChild(moreBtn); 
    taskEl.appendChild(menu); 
    
    return taskEl;
}

function openDayModal(dateISO) {
    state.currentModalDate = dateISO;
    const date = new Date(dateISO + 'T12:00:00'); 
    modalDateDisplay.textContent = date.toLocaleDateString('ru-RU', { day: '2-digit', month: 'long', year: 'numeric' });
    
    modalTaskList.innerHTML = '';
    const tasks = state.tasks[dateISO] || [];
    
    if (tasks.length === 0) {
        modalTaskList.innerHTML = '<p class="no-tasks">–ó–∞–¥–∞—á –Ω–∞ —ç—Ç–æ—Ç –¥–µ–Ω—å –Ω–µ—Ç.</p>';
    } else {
        tasks.forEach(task => {
            modalTaskList.appendChild(createTaskItemElement(task));
        });
    }
    
    dayModal.style.display = 'flex';
    setTimeout(() => dayModal.classList.add('visible'), 10);
}

function closeModal() {
    dayModal.classList.remove('visible');
    setTimeout(() => { dayModal.style.display = 'none'; }, 300);
    state.currentModalDate = null;
    newTaskTimeInput.value = '';
    newTaskTextInput.value = '';
}

async function handleModalAddTask() {
    const time = newTaskTimeInput.value;
    const text = newTaskTextInput.value.trim();
    const date = state.currentModalDate;
    
    if (!text || !date) return;
    
    const newTask = await addTask(date, time, text);
    
    if (newTask) {
        if (!state.tasks[date]) state.tasks[date] = [];
        state.tasks[date].push(newTask);
        state.tasks[date].sort((a, b) => (a.time || '').localeCompare(b.time || ''));
        
        newTaskTimeInput.value = '';
        newTaskTextInput.value = '';
        
        openDayModal(date);
        render();
    }
}
// =================================================================
// –ö–û–ù–ï–¶ –ë–õ–û–ö–ê –ö–ê–õ–ï–ù–î–ê–†–Ø
// =================================================================


/* --- –¢–†–ï–ö–ï–† –ü–†–ò–í–´–ß–ï–ö --- */
const newHabitInput = document.getElementById('newHabitInput');
const habitTableContainer = document.getElementById('habitTableContainer');
const toggleHabitHistoryBtn = document.getElementById('toggleHabitHistoryBtn');
let isHabitHistoryCollapsed = true;
function renderHabitTracker() {
    habitTableContainer.innerHTML = `<div class="habit-table-wrapper"><table class="habit-table"><thead><tr id="habitHeaderRow"><th>–î–∞—Ç–∞</th></tr></thead><tbody id="habitBody"></tbody></table></div>`;
    const headerRow = document.getElementById('habitHeaderRow');
    const body = document.getElementById('habitBody');
    data.habits.forEach((habit, index) => {
        const th = document.createElement('th');
        const contentDiv = document.createElement('div');
        contentDiv.className = 'habit-header-content';
        const textSpan = document.createElement('span');
        textSpan.contentEditable = true;
        textSpan.innerText = habit;
        textSpan.addEventListener('blur', () => { data.habits[index] = textSpan.innerText.trim(); save(); });
        const removeBtn = document.createElement('span');
        removeBtn.innerText = '√ó';
        removeBtn.className = 'remove-habit';
        removeBtn.title = '–£–¥–∞–ª–∏—Ç—å –ø—Ä–∏–≤—ã—á–∫—É';
        removeBtn.onclick = (e) => {
            e.stopPropagation();
            if (confirm(`–£–¥–∞–ª–∏—Ç—å –ø—Ä–∏–≤—ã—á–∫—É "${habit}"? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.`)) {
                data.habits.splice(index, 1);
                data.habitRecords.forEach(record => {
                    if (record.tasks && record.tasks.hasOwnProperty(habit)) {
                        delete record.tasks[habit];
                    }
                });
                save();
                renderHabitTracker();
            }
        };
        contentDiv.appendChild(textSpan);
        contentDiv.appendChild(removeBtn);
        th.appendChild(contentDiv);
        headerRow.appendChild(th);
    });
    const progressTh = document.createElement('th');
    progressTh.className = 'progress-col';
    progressTh.innerText = '–ü—Ä–æ–≥—Ä–µ—Å—Å';
    headerRow.appendChild(progressTh);
    body.innerHTML = '';
    const recordsToShow = isHabitHistoryCollapsed ? data.habitRecords.slice(0, 7) : data.habitRecords;
    recordsToShow.forEach(record => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${new Date(record.date).toLocaleDateString('ru-RU', {day:'2-digit', month:'2-digit'})}</td>`;
        let completed = 0;
        data.habits.forEach(habit => {
            const td = document.createElement('td');
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.checked = !!(record.tasks && record.tasks[habit]);
            if(checkbox.checked) completed++;
            checkbox.onchange = () => {
                if(!record.tasks) record.tasks = {};
                record.tasks[habit] = checkbox.checked;
                save();
                renderHabitTracker();
            };
            td.appendChild(checkbox);
            tr.appendChild(td);
        });
        const percentage = data.habits.length > 0 ? (completed / data.habits.length) * 100 : 0;
        const progressTd = document.createElement('td');
        progressTd.innerHTML = `<div class="progress-bar-container"><div class="progress-bar" style="width: ${percentage}%;"></div><span class="progress-bar-text">${percentage.toFixed(0)}%</span></div>`;
        tr.appendChild(progressTd);
        body.appendChild(tr);
    });
    toggleHabitHistoryBtn.style.display = data.habitRecords.length > 7 ? 'block' : 'none';
    toggleHabitHistoryBtn.textContent = isHabitHistoryCollapsed ? '–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é' : '–°–≤–µ—Ä–Ω—É—Ç—å –∏—Å—Ç–æ—Ä–∏—é';
    habitTableContainer.classList.toggle('collapsed', isHabitHistoryCollapsed && data.habitRecords.length > 7);
}
toggleHabitHistoryBtn.onclick = () => { isHabitHistoryCollapsed = !isHabitHistoryCollapsed; renderHabitTracker(); };
document.getElementById('addHabitBtn').onclick=()=>{
    const text=newHabitInput.value.trim();
    if(text && !data.habits.includes(text)){
        data.habits.push(text);
        newHabitInput.value='';
        save(); renderHabitTracker();
    }
};
document.getElementById('newDayBtn').onclick=()=>{
    const today=new Date().setHours(0,0,0,0);
    if(data.habitRecords.some(r=>new Date(r.date).setHours(0,0,0,0)===today)){
        showNotification('–ó–∞–ø–∏—Å—å –∑–∞ —Å–µ–≥–æ–¥–Ω—è —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.', 'warning'); 
        return;
    }
    const newRecord={ date: new Date().toISOString(), tasks: {} };
    data.habits.forEach(h=>{newRecord.tasks[h]=false;});
    data.habitRecords.unshift(newRecord);
    save(); renderHabitTracker();
};

/* --- –¢–†–ï–ö–ï–† –ù–ê–°–¢–†–û–ï–ù–ò–Ø --- */
const moodMonthSelect = document.getElementById('moodMonthSelect');
const moodCalendar = document.getElementById('moodCalendar');
function getDayKey(date) { return `${date.getFullYear()}-${date.getMonth() + 1}-${date.getDate()}`; }
function updateMoodSelect() {
    const now = new Date();
    moodMonthSelect.innerHTML = '';
    const monthsLocale = ['–Ø–Ω–≤–∞—Ä—å','–§–µ–≤—Ä–∞–ª—å','–ú–∞—Ä—Ç','–ê–ø—Ä–µ–ª—å','–ú–∞–π','–ò—é–Ω—å','–ò—é–ª—å','–ê–≤–≥—É—Å—Ç','–°–µ–Ω—Ç—è–±—Ä—å','–û–∫—Ç—è–±—Ä—å','–ù–æ—è–±—Ä—å','–î–µ–∫–∞–±—Ä—å'];
    for (let i = 0; i < 12; i++) {
        const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
        const option = document.createElement('option');
        option.value = `${date.getFullYear()}-${date.getMonth()}`;
        option.textContent = `${monthsLocale[date.getMonth()]} ${date.getFullYear()}`;
        moodMonthSelect.appendChild(option);
    }
    moodMonthSelect.value = `${now.getFullYear()}-${now.getMonth()}`;
    moodMonthSelect.onchange = renderMoodCalendar;
}
function renderMoodCalendar() {
    moodCalendar.innerHTML = ''; // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å
    
    // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ –¥–Ω–µ–π –Ω–µ–¥–µ–ª–∏
    ['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–í—Å'].forEach(day => { 
        const dayHeader = document.createElement('div');
        dayHeader.className = 'mood-calendar-day';
        dayHeader.textContent = day;
        moodCalendar.appendChild(dayHeader);
    });

    const [year, month] = moodMonthSelect.value.split('-').map(Number);
    const date = new Date(year, month, 1);
    
    // –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Å—Ç—ã–µ —è—á–µ–π–∫–∏ –¥–ª—è –¥–Ω–µ–π –¥–æ –Ω–∞—á–∞–ª–∞ –º–µ—Å—è—Ü–∞
    let firstDay = date.getDay();
    if (firstDay === 0) firstDay = 7; // 0 (–í—Å) -> 7
    for (let i = 1; i < firstDay; i++) { 
        const emptyCell = document.createElement('div');
        emptyCell.className = 'mood-calendar-cell empty';
        moodCalendar.appendChild(emptyCell);
    }

    // –ó–∞–ø–æ–ª–Ω—è–µ–º –¥–Ω–∏ –º–µ—Å—è—Ü–∞
    while (date.getMonth() === month) {
        const dayKey = getDayKey(date);
        const record = data.moodRecords[dayKey];
        
        const cell = document.createElement('div');
        cell.className = 'mood-calendar-cell';
        
        const dayNumber = document.createElement('span');
        dayNumber.className = 'day-number';
        dayNumber.textContent = date.getDate();
        cell.appendChild(dayNumber);
        
        const dayMood = document.createElement('span');
        dayMood.className = 'day-mood';
        
        let moodEmoji = '';
        if (record?.mood) {
            moodEmoji = MOOD_EMOJIS[record.mood] || '';
        }
        if (record?.comment) {
            moodEmoji += ' üí¨'; // –î–æ–±–∞–≤–ª—è–µ–º –∏–∫–æ–Ω–∫—É, –µ—Å–ª–∏ –µ—Å—Ç—å –∫–æ–º–º–µ–Ω—Ç
        }
        dayMood.textContent = moodEmoji;
        cell.appendChild(dayMood);

        // –ï—Å–ª–∏ –¥–ª—è –¥–Ω—è –µ—Å—Ç—å –∑–∞–ø–∏—Å—å (–Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –∏–ª–∏ –∫–æ–º–º–µ–Ω—Ç), –¥–µ–ª–∞–µ–º –µ–≥–æ –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–º
        if (record) {
            cell.classList.add('has-data'); // –î–ª—è CSS (cursor: pointer)
            cell.onclick = () => openMoodCommentModal(dayKey, record);
        }
        
        moodCalendar.appendChild(cell);
        date.setDate(date.getDate() + 1);
    }
}

// --- –ù–û–í–´–ï –§–£–ù–ö–¶–ò–ò –î–õ–Ø –ú–û–î–ê–õ–ö–ò –ù–ê–°–¢–†–û–ï–ù–ò–Ø ---

let currentMoodModalKey = null; // –î–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è, –∫–∞–∫–æ–π –¥–µ–Ω—å –æ—Ç–∫—Ä—ã—Ç

function openMoodCommentModal(dayKey, record) {
    currentMoodModalKey = dayKey; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–ª—é—á –¥–Ω—è
    
    const modal = document.getElementById('mood-comment-modal');
    if (!modal || !record) return;

    // –ù–∞—Ö–æ–¥–∏–º —ç–ª–µ–º–µ–Ω—Ç—ã
    const dateDisplay = document.getElementById('mood-modal-date-display');
    const emojiDisplay = document.getElementById('mood-modal-emoji');
    const commentTextarea = document.getElementById('mood-modal-comment');
    const saveBtn = document.getElementById('mood-modal-save-btn');
    const deleteBtn = document.getElementById('mood-modal-delete-btn');

    // 1. –ó–∞–ø–æ–ª–Ω—è–µ–º –¥–∞–Ω–Ω—ã–º–∏
    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º 'YYYY-MM-DD' –≤ –¥–∞—Ç—É
    const dateParts = dayKey.split('-');
    const date = new Date(dateParts[0], dateParts[1] - 1, dateParts[2]);
    dateDisplay.textContent = date.toLocaleDateString('ru-RU', { day: '2-digit', month: 'long', year: 'numeric' });
    
    emojiDisplay.textContent = record.mood ? MOOD_EMOJIS[record.mood] : 'üòê'; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–º–∞–π–ª–∏–∫ (–∏–ª–∏ –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π)
    commentTextarea.value = record.comment || '';

    // 2. –ù–∞–∑–Ω–∞—á–∞–µ–º –¥–µ–π—Å—Ç–≤–∏—è –∫–Ω–æ–ø–∫–∞–º (—Å–Ω–∞—á–∞–ª–∞ —É–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –¥—É–±–ª–µ–π)
    saveBtn.onclick = null;
    saveBtn.onclick = () => {
        const newComment = commentTextarea.value.trim();
        const currentRecord = data.moodRecords[currentMoodModalKey]; // –ü–æ–ª—É—á–∞–µ–º –∑–∞–ø–∏—Å—å
        
        if (newComment) {
            currentRecord.comment = newComment;
        } else {
            currentRecord.comment = undefined; // –£–¥–∞–ª—è–µ–º –∫–æ–º–º–µ–Ω—Ç, –µ—Å–ª–∏ –ø–æ–ª–µ –ø—É—Å—Ç–æ–µ
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ —É–¥–∞–ª–∏—Ç—å –≤—Å—é –∑–∞–ø–∏—Å—å
        if (!currentRecord.mood && !currentRecord.comment) {
            delete data.moodRecords[currentMoodModalKey];
        }
        
        save();
        renderMoodCalendar();
        closeMoodCommentModal();
    };
    
    deleteBtn.onclick = null;
    deleteBtn.onclick = () => {
        const currentRecord = data.moodRecords[currentMoodModalKey];
        if(currentRecord) { // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∑–∞–ø–∏—Å—å –µ—â–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
            currentRecord.comment = undefined; // –£–¥–∞–ª—è–µ–º —Ç–æ–ª—å–∫–æ –∫–æ–º–º–µ–Ω—Ç
        
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ —É–¥–∞–ª–∏—Ç—å –≤—Å—é –∑–∞–ø–∏—Å—å
            if (!currentRecord.mood) {
                delete data.moodRecords[currentMoodModalKey];
            }
        }

        save();
        renderMoodCalendar();
        closeMoodCommentModal();
    };

    // 3. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É
    modal.style.display = 'flex';
    setTimeout(() => modal.classList.add('visible'), 10);
}

function closeMoodCommentModal() {
    const modal = document.getElementById('mood-comment-modal');
    if (!modal) return;
    
    modal.classList.remove('visible');
    setTimeout(() => { modal.style.display = 'none'; }, 300);
    currentMoodModalKey = null; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∫–ª—é—á
}

// --- –ö–û–ù–ï–¶ –ù–û–í–´–• –§–£–ù–ö–¶–ò–ô ---

function updateMoodSelection() {
    const todayKey = getDayKey(new Date());
    const record = data.moodRecords[todayKey];
    const savedMood = record?.mood;
    const commentInput = document.getElementById('moodCommentInput');

    // 1. –û–±–Ω–æ–≤–ª—è–µ–º —Å–º–∞–π–ª–∏–∫–∏ (–§–∏–∫—Å –±–∞–≥–æ–≤ 1 –∏ 2)
    document.querySelectorAll('.mood-option').forEach(el => {
        // –ß–µ—Ç–∫–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–ª–∞—Å—Å 'selected' —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ data-mood —Å–æ–≤–ø–∞–¥–∞–µ—Ç
        if (savedMood === el.dataset.mood) {
            el.classList.add('selected');
        } else {
            el.classList.remove('selected');
        }

        // –ü–µ—Ä–µ–Ω–∞–∑–Ω–∞—á–∞–µ–º 'onclick', —á—Ç–æ–±—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ω–æ–≤—É—é –ª–æ–≥–∏–∫—É
        el.onclick = () => {
            const clickedMood = el.dataset.mood;
            let currentRecord = data.moodRecords[todayKey] || {};

            // –ï—Å–ª–∏ –∫–ª–∏–∫–Ω—É–ª–∏ –ø–æ —É–∂–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É —Å–º–∞–π–ª–∏–∫—É
            if (currentRecord.mood === clickedMood) {
                currentRecord.mood = undefined; // –°–Ω–∏–º–∞–µ–º –≤—ã–±–æ—Ä
            } else { // –í—ã–±—Ä–∞–ª–∏ –Ω–æ–≤—ã–π —Å–º–∞–π–ª–∏–∫
                currentRecord.mood = clickedMood;
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ—Å—Ç–∞–ª–∏—Å—å –ª–∏ –≤ –∑–∞–ø–∏—Å–∏ –¥–∞–Ω–Ω—ã–µ. –ï—Å–ª–∏ –Ω–µ—Ç - —É–¥–∞–ª—è–µ–º –∑–∞–ø–∏—Å—å.
            if (!currentRecord.mood && !currentRecord.comment) {
                delete data.moodRecords[todayKey];
            } else {
                data.moodRecords[todayKey] = currentRecord;
            }

            save();
            updateMoodSelection(); // –ü–æ–≤—Ç–æ—Ä–Ω–æ –≤—ã–∑—ã–≤–∞–µ–º, —á—Ç–æ–±—ã –æ–±–Ω–æ–≤–∏—Ç—å –∫–ª–∞—Å—Å—ã
            renderMoodCalendar(); // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞–ª–µ–Ω–¥–∞—Ä—å
        };
    });

    // 2. –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
    if (commentInput) {
        commentInput.value = record?.comment || '';
        
        // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –ª–∏—Å—Ç–µ–Ω–µ—Ä, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –¥—É–±–ª–µ–π
        commentInput.oninput = null; 
        
        // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è –ø—Ä–∏ –≤–≤–æ–¥–µ
        commentInput.oninput = () => {
            let currentRecord = data.moodRecords[todayKey] || {};
            let commentText = commentInput.value.trim();
            
            if (commentText) {
                currentRecord.comment = commentText;
            } else {
                currentRecord.comment = undefined;
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ—Å—Ç–∞–ª–∏—Å—å –ª–∏ –≤ –∑–∞–ø–∏—Å–∏ –¥–∞–Ω–Ω—ã–µ.
            if (!currentRecord.mood && !currentRecord.comment) {
                delete data.moodRecords[todayKey];
            } else {
                data.moodRecords[todayKey] = currentRecord;
            }
            
            save(); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–∏ –∫–∞–∂–¥–æ–º –≤–≤–æ–¥–µ
        };
        
        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º –∫–∞–ª–µ–Ω–¥–∞—Ä—å (–¥–ª—è –∏–∫–æ–Ω–∫–∏ üí¨) –ø—Ä–∏ –ø–æ—Ç–µ—Ä–µ —Ñ–æ–∫—É—Å–∞
        commentInput.onblur = () => {
             renderMoodCalendar(); 
        };
    }
}

// =================================================================
// 5. AI –§–£–ù–ö–¶–ò–û–ù–ê–õ
// =================================================================

function closeAiAdviceModal() {
    aiAdviceModalOverlay.classList.remove('visible');
    setTimeout(() => { aiAdviceModalOverlay.style.display = 'none'; }, 300);
}
aiAdviceModalOverlay.addEventListener('click', (e) => {
    if (e.target === aiAdviceModalOverlay) {
        closeAiAdviceModal();
    }
});
function openAiAdviceModal(suggestion) {
    let htmlSuggestion = suggestion;
    // ... (–∫–æ–¥ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è Markdown) ...
    aiAdviceText.innerHTML = htmlSuggestion;
    aiAdviceModalOverlay.style.display = 'block';
    setTimeout(() => { aiAdviceModalOverlay.classList.add('visible'); }, 10);
}
function generateAIPrompt() {
    let prompt = "";
    // ... (–∫–æ–¥ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø—Ä–æ–º–ø—Ç–∞) ...
    return prompt;
}
async function callGeminiAPI(prompt) {
    showNotification("–î–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è AI-—Å–æ–≤–µ—Ç–∞ —Ç—Ä–µ–±—É–µ—Ç—Å—è —Å–µ—Ä–≤–µ—Ä–Ω—ã–π –ø—Ä–æ–∫—Å–∏. –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.", 'warning', 7000);
    return { status: "error", message: "AI —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª —Ç—Ä–µ–±—É–µ—Ç —Å–µ—Ä–≤–µ—Ä–Ω–æ–≥–æ –ø—Ä–æ–∫—Å–∏." };
}
getAISuggestionBtn.onclick = async () => {
    const promptText = generateAIPrompt();
    const result = await callGeminiAPI(promptText);
    if (result.status === 'success' && result.suggestion) {
        openAiAdviceModal(result.suggestion);
    }
};

// =================================================================
// 6. –§–£–ù–ö–¶–ò–ò –£–í–ï–î–û–ú–õ–ï–ù–ò–ô (Notification API)
// =================================================================

// –§—É–Ω–∫—Ü–∏–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –Ω–µ–¥–µ–ª—å —É–¥–∞–ª–µ–Ω—ã

function requestNotificationPermission() {
    if (!("Notification" in window)) {
        console.warn("–≠—Ç–æ—Ç –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç Desktop Notifications.");
        return;
    }
    if (Notification.permission !== "granted" && Notification.permission !== "denied") {
        Notification.requestPermission().then(permission => {
            console.log("–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:", permission);
        });
    }
}

// =================================================================
// 7. –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
// =================================================================

function renderAll(){
    renderGoals();
    // renderUnassigned, renderMonths, renderArchive –£–î–ê–õ–ï–ù–´
    renderHabitTracker();
    updateMoodSelect();
    renderMoodCalendar();
    updateMoodSelection(); 
}

function setupMobileNav() {
    // --- –°–µ–∫—Ü–∏–∏ ---
    const sectionGoals = document.getElementById('mobileSectionGoals');
    const sectionWeeks = document.getElementById('mobileSectionWeeks'); // –¢–µ–ø–µ—Ä—å —ç—Ç–æ –ö–∞–ª–µ–Ω–¥–∞—Ä—å
    const sectionHabits = document.getElementById('mobileSectionHabits');
    const sectionMood = document.getElementById('mobileSectionMood');
    const allSections = [sectionGoals, sectionWeeks, sectionHabits, sectionMood];

    // --- –ö–Ω–æ–ø–∫–∏ –æ—Å–Ω–æ–≤–Ω–æ–π –ø–∞–Ω–µ–ª–∏ ---
    const mobileNavWeeks = document.getElementById('mobileNavWeeks');
    const mobileNavHabits = document.getElementById('mobileNavHabits');
    const mobileNavMenuBtn = document.getElementById('mobileNavMenuBtn');
    const mobileNavSave = document.getElementById('mobileNavSave');
    const mobileNavProfile = document.getElementById('mobileNavProfile');
    
    const allTabButtons = [mobileNavWeeks, mobileNavHabits]; 

    // --- –í—Å–ø–ª—ã–≤–∞—é—â–µ–µ –º–µ–Ω—é ---
    const mobileMenuOverlay = document.getElementById('mobileMenuOverlay');
    const mobileMenuGoals = document.getElementById('mobileMenuGoals');
    const mobileMenuMood = document.getElementById('mobileMenuMood');
    const mobileMenuKB = document.getElementById('mobileMenuKB');
    const mobileMenuAI = document.getElementById('mobileMenuAI');
    const mobileMenuMedics = document.getElementById('mobileMenuMedics'); 

    // --- –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ —Å–µ–∫—Ü–∏–∏ ---
    const showMobileSection = (sectionToShow, buttonToActivate) => {
        allSections.forEach(sec => sec.classList.remove('active'));
        allTabButtons.forEach(btn => {
            if(btn) btn.classList.remove('active');
        });
        if (sectionToShow) sectionToShow.classList.add('active');
        if (buttonToActivate) buttonToActivate.classList.add('active');
    };

    // --- –§—É–Ω–∫—Ü–∏–∏ –≤—Å–ø–ª—ã–≤–∞—é—â–µ–≥–æ –º–µ–Ω—é ---
    const openMobileMenuOverlay = () => {
        if (mobileMenuOverlay) mobileMenuOverlay.classList.add('visible');
        if (mobileNavMenuBtn) mobileNavMenuBtn.classList.add('is-open');
    };
    const closeMobileMenuOverlay = () => {
        if (mobileMenuOverlay) mobileMenuOverlay.classList.remove('visible');
        if (mobileNavMenuBtn) mobileNavMenuBtn.classList.remove('is-open');
    };

    // --- –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –∫–ª–∏–∫–æ–≤ –¥–ª—è –û–°–ù–û–í–ù–û–ô –ü–ê–ù–ï–õ–ò ---
    if (mobileNavWeeks) mobileNavWeeks.onclick = () => showMobileSection(sectionWeeks, mobileNavWeeks);
    if (mobileNavHabits) mobileNavHabits.onclick = () => showMobileSection(sectionHabits, mobileNavHabits);
    
    if (mobileNavSave && saveAllBtn) mobileNavSave.onclick = () => saveAllBtn.click();
    if (mobileNavProfile && accountControlBtn) mobileNavProfile.onclick = () => accountControlBtn.click();

    if (mobileNavMenuBtn) mobileNavMenuBtn.onclick = () => {
        if (mobileMenuOverlay.classList.contains('visible')) {
            closeMobileMenuOverlay();
        } else {
            openMobileMenuOverlay();
        }
    };
    
    if (mobileMenuOverlay) mobileMenuOverlay.onclick = (e) => {
        if (e.target === mobileMenuOverlay) {
            closeMobileMenuOverlay();
        }
    };

    // --- –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –∫–ª–∏–∫–æ–≤ –¥–ª—è –í–°–ü–õ–´–í–ê–Æ–©–ï–ì–û –ú–ï–ù–Æ ---
    if (mobileMenuGoals) mobileMenuGoals.onclick = () => {
        showMobileSection(sectionGoals, null); 
        closeMobileMenuOverlay();
    };
    if (mobileMenuMood) mobileMenuMood.onclick = () => {
        showMobileSection(sectionMood, null); 
        closeMobileMenuOverlay();
    };
    if (mobileMenuKB) mobileMenuKB.onclick = () => {
        window.location.href = 'knowledge_base.html';
        closeMobileMenuOverlay();
    };mobileMenuAI
    if (mobileMenuAI) mobileMenuAI.onclick = () => {
        window.location.href = 'ai-chat.html';
        closeMobileMenuOverlay();
    };
    if (mobileMenuMedics) mobileMenuMedics.onclick = () => {
        window.location.href = 'meds.html';
        closeMobileMenuOverlay();
    };
    if (mobileMenuLists) mobileMenuLists.onclick = () => {
        window.location.href = 'lists.html';
        closeMobileMenuOverlay();
    };
    if (mobileMenuScanner) mobileMenuScanner.onclick = () => {
        window.location.href = 'scanner.html';
        closeMobileMenuOverlay();
    };

    // --- –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–µ–∫—Ü–∏—é –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ ---
    showMobileSection(sectionWeeks, mobileNavWeeks); // –ö–∞–ª–µ–Ω–¥–∞—Ä—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
}

async function init() {
    if (window.supabase) {
        supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    } else {
        console.error("Supabase library not found on window. Did the script load correctly?");
        document.body.innerHTML = '<h2 style="color: red; text-align: center; margin-top: 50px;">–û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫—É Supabase.</h2>';
        return;
    }

    const authKey = localStorage.getItem(STORAGE_KEY_AUTH);
    if (!authKey) { 
        window.location.href = 'login.html'; 
        return; 
    }

    // –û–ë–ù–û–í–õ–ï–ù–û: –ü–æ–ª—É—á–∞–µ–º ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
    const { data: { user }, error: userError } = await supabase.auth.getUser();
    if (userError || !user) {
        console.error("–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∏–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω:", userError);
        window.location.href = 'login.html'; 
        return;
    }
    currentUserId = user.id; // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é

    updateAuthButton();
    
    // 1. –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –¶–µ–ª–µ–π, –ü—Ä–∏–≤—ã—á–µ–∫, –ù–∞—Å—Ç—Ä–æ–µ–Ω–∏—è
    data = await loadDataFromSupabase();  
    if (data) {
        renderAll(); // –†–µ–Ω–¥–µ—Ä–∏–º –¶–µ–ª–∏, –ü—Ä–∏–≤—ã—á–∫–∏, –ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ
        requestNotificationPermission(); 
    } else {
        document.body.innerHTML = '<h2 style="color: red; text-align: center; margin-top: 50px;">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ (–¶–µ–ª–∏/–ü—Ä–∏–≤—ã—á–∫–∏). –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É.</h2>';
        return; // –ù–µ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º, –µ—Å–ª–∏ –æ—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
    }
    
    // 2. –ó–∞–≥—Ä—É–∂–∞–µ–º –∏ —Ä–µ–Ω–¥–µ—Ä–∏–º –ö–∞–ª–µ–Ω–¥–∞—Ä—å
    await fetchTasks(); 
    render(); // –†–µ–Ω–¥–µ—Ä–∏–º –ö–∞–ª–µ–Ω–¥–∞—Ä—å
    
    // 3. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–ª—É—à–∞—Ç–µ–ª–∏ –ö–∞–ª–µ–Ω–¥–∞—Ä—è
    prevBtn.onclick = () => {
        if (state.currentView === 'month') {
            state.currentDate.setMonth(state.currentDate.getMonth() - 1);
        } else {
            state.currentDate.setDate(state.currentDate.getDate() - 7);
        }
        render();
    };
    
    nextBtn.onclick = () => {
        if (state.currentView === 'month') {
            state.currentDate.setMonth(state.currentDate.getMonth() + 1);
        } else {
            state.currentDate.setDate(state.currentDate.getDate() + 7);
        }
        render();
    };
    
    todayBtn.onclick = () => {
        state.currentDate = new Date();
        render();
    };
    
    monthViewBtn.onclick = () => {
        state.currentView = 'month';
        render();
    };
    weekViewBtn.onclick = () => {
        state.currentView = 'week';
        render();
        
        // --- –î–û–ë–ê–í–õ–ï–ù–û: –ü–ª–∞–≤–Ω–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–º—É –¥–Ω—é ---
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É, —á—Ç–æ–±—ã DOM 100% —É—Å–ø–µ–ª –æ—Ç—Ä–∏—Å–æ–≤–∞—Ç—å—Å—è
        setTimeout(() => {
            const todayColumn = document.querySelector('.week-day-column.today');
            if (todayColumn) {
                // –ü–ª–∞–≤–Ω–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞, —á—Ç–æ–±—ã –∫–æ–ª–æ–Ω–∫–∞ –æ–∫–∞–∑–∞–ª–∞—Å—å –ø–æ —Ü–µ–Ω—Ç—Ä—É
                todayColumn.scrollIntoView({ 
                    behavior: 'smooth', 
                    inline: 'center', 
                    block: 'nearest' 
                });
            }
        }, 100); 
    };
    
    closeModalBtn.onclick = closeModal;
    dayModal.onclick = (e) => {
        if (e.target === dayModal) closeModal();
    };
    addTaskFormModal.onsubmit = handleModalAddTask;

    const recurModal = document.getElementById('recur-modal');
    const recurTypeSelect = document.getElementById('recur-type');
    const weeklyOptions = document.getElementById('recur-weekly-options');
    const customOptions = document.getElementById('recur-custom-options');
    
    recurTypeSelect.onchange = () => {
        const type = recurTypeSelect.value;
        weeklyOptions.style.display = (type === 'weekly') ? 'block' : 'none';
        customOptions.style.display = (type === 'custom') ? 'block' : 'none';
    };
    
    document.querySelectorAll('.close-recur-modal').forEach(btn => {
        btn.onclick = () => {
            recurModal.classList.remove('visible');
            setTimeout(() => { recurModal.style.display = 'none'; }, 300);
            state.currentRecurTask = null;
        };
    });
    
    document.getElementById('save-recur-btn').onclick = () => {
        if (!state.currentRecurTask) return;
        alert('–õ–æ–≥–∏–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–≥—É–ª—è—Ä–Ω–æ–π –∑–∞–¥–∞—á–∏ –µ—â–µ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞.\n–í—ã–±—Ä–∞–Ω–Ω–∞—è –∑–∞–¥–∞—á–∞: ' + state.currentRecurTask.text);
        document.querySelector('.close-recur-modal').click();
    };

    document.addEventListener('click', (e) => {
        if (!e.target.closest('.task-item-more') && !e.target.closest('.task-item-menu')) {
             document.querySelectorAll('.task-item-menu.visible').forEach(m => m.classList.remove('visible'));
        }
    });
    // --- –í–°–¢–ê–í–ò–¢–¨ –í–ù–£–¢–†–ò –§–£–ù–ö–¶–ò–ò async function init() {} –Ω–∞ index.html ---

    // -----------------------------------------------------------
    // ‚¨áÔ∏è –ù–ê–ß–ê–õ–û: –ö–æ–¥ –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞ –∑–∞–¥–∞—á –∏–∑ AI-—á–∞—Ç–∞
    // -----------------------------------------------------------
    
    const CALENDAR_DATA_KEY = 'aiCalendarImport';
    const aiTasksToImportRaw = localStorage.getItem(CALENDAR_DATA_KEY);
    
    if (aiTasksToImportRaw) {
        let aiTasks = [];
        try {
            aiTasks = JSON.parse(aiTasksToImportRaw);
        } catch (e) {
            console.error("–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ AI-–∑–∞–¥–∞—á:", e);
            localStorage.removeItem(CALENDAR_DATA_KEY);
        }

        if (Array.isArray(aiTasks) && aiTasks.length > 0) {
            
            if (confirm(`ü§ñ AI-–ß–∞—Ç –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –¥–æ–±–∞–≤–∏—Ç—å ${aiTasks.length} –Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á. \n\n–•–æ—Ç–∏—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å –∏—Ö –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä—å?`)) {
                
                showLoading(); // –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è, —á—Ç–æ —É —Ç–µ–±—è –µ—Å—Ç—å —ç—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è
                let addedCount = 0;
                
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º addTask —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –∫–ª—é—á–∞–º–∏ –∏–∑ JSON
                const addPromises = aiTasks.map(task => {
                    if (task.task_date && task.text) { // –ò—Å–ø–æ–ª—å–∑—É–µ–º task_date
                        addedCount++;
                        // addTask(date, time, text)
                        return addTask(task.task_date, task.time || '', task.text);
                    }
                    return Promise.resolve();
                });

                await Promise.all(addPromises);
                
                hideLoading(); // –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è, —á—Ç–æ —É —Ç–µ–±—è –µ—Å—Ç—å —ç—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è
                
                render(); // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –∫–∞–ª–µ–Ω–¥–∞—Ä—å
                
                showNotification(`–£—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ ${addedCount} –∑–∞–¥–∞—á –æ—Ç AI.`, 'success', 7000); // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                
                setUnsaved(true); // –£–∫–∞–∑—ã–≤–∞–µ–º, —á—Ç–æ –µ—Å—Ç—å –Ω–µ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è (–µ—Å–ª–∏ —Ç–≤–æ—è —Ñ—É–Ω–∫—Ü–∏—è addTask —ç—Ç–æ –Ω–µ –¥–µ–ª–∞–µ—Ç)

            } else {
                showNotification("–ò–º–ø–æ—Ä—Ç –∑–∞–¥–∞—á –æ—Ç AI –æ—Ç–º–µ–Ω–µ–Ω.", 'warning');
            }
            
            // –û—á–∏—â–∞–µ–º –∫–ª—é—á –≤ –ª—é–±–æ–º —Å–ª—É—á–∞–µ
            localStorage.removeItem(CALENDAR_DATA_KEY);
        }
    }
}

document.addEventListener('DOMContentLoaded', () => {
    init();
    // --- –õ–∏—Å—Ç–µ–Ω–µ—Ä—ã –¥–ª—è –ù–û–í–û–ô –º–æ–¥–∞–ª–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è ---
    const moodModal = document.getElementById('mood-comment-modal');
    if (moodModal) {
        // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –Ω–∞ —Ñ–æ–Ω
        moodModal.onclick = (e) => {
            if (e.target === moodModal) {
                closeMoodCommentModal();
            }
        };
        // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–Ω–æ–ø–∫–∞–º "X" –∏ "–û—Ç–º–µ–Ω–∞"
        moodModal.querySelectorAll('.close-mood-modal').forEach(btn => {
            btn.onclick = closeMoodCommentModal;
        });
    }
    setupMobileNav(); // –í—ã–∑—ã–≤–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫—É –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
});
</script>
<script src="js/footer.js"></script>

</body>
</html>
