<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Time Owner</title>
<link rel="icon" type="image/png" href="pictures/favicon.png">

<meta name="theme-color" content="#0099ff">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://unpkg.com/drag-drop-touch"></script>
<style>
/* --- ОБЩИЕ УЛУЧШЕННЫЕ СТИЛИ --- */
:root {
    --bg-main: #121212;
    --bg-secondary: #1e1e1e;
    --bg-tertiary: #2a2a2a;
    --bg-hover: #333333;
    --border-color: #383838;
    --text-primary: #e0e0e0;
    --text-secondary: #a0a0a0;
    --accent-color: #007bff;
    --accent-hover: #0056b3;
    --danger-color: #e53935;
    --success-color: #4CAF50;
    --warning-color: #FFC107;
    /* --- НОВЫЕ ПЕРЕМЕННЫЕ ДЛЯ РЕДИЗАЙНА --- */
    --header-height: 60px;
}
* {
    box-sizing: border-box;
}

/* --- КРАСИВЫЕ СТИЛИ ПРОКРУТКИ (СКРОЛЛБАРЫ) --- */
::-webkit-scrollbar {
    width: 10px; 
    height: 10px; 
}
::-webkit-scrollbar-track {
    background: var(--bg-secondary);
}
::-webkit-scrollbar-thumb {
    background: var(--accent-color); 
    border-radius: 5px;
}
::-webkit-scrollbar-thumb:hover {
    background: var(--accent-hover);
}
* {
  scrollbar-color: var(--accent-color) var(--bg-secondary); 
  scrollbar-width: thin;
}

/* --- АНИМАЦИЯ ПОЯВЛЕНИЯ СТРАНИЦЫ --- */
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

body {
    margin: 0;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji";
    background: var(--bg-main);
    color: var(--text-primary);
    display: flex;
    flex-direction: column;
    min-height: 100vh;
    overflow-x: hidden; 
    animation: fadeIn 0.5s ease-in-out;
}
.banner{width:100%;display:flex;justify-content:center;overflow:hidden;}
.banner img{width:100%;height:auto;max-height: 400px; object-fit:cover;display:block;}

/* --- ОСНОВНАЯ СТРУКТУРА --- */
.main-container{
    display:flex;
    padding: 0 10px;
    overflow-x: hidden; 
    transition: padding 0.3s ease; 
}
.goals{
    width:240px;
    background:var(--bg-secondary);
    /* border-right:1px solid var(--border-color); -- ИЗМЕНЕНО В media-query */
    padding:20px;
    display:flex;
    flex-direction:column;
    gap: 15px; 
    overflow-y: auto; 
    position:relative; 
    flex-shrink: 0;
    position: sticky;
    top: 20px; /* Отступ при прилипании */
    max-height: calc(100vh - 40px); /* Макс. высота = высота экрана минус отступы */
}
.right{
    flex:1;
    display:flex;
    flex-direction:column;
    padding:20px;
    gap:15px;
    overflow: hidden; 
}

/* --- ЭЛЕМЕНТЫ ИНТЕРФЕЙСА --- */
.btn{
    background:var(--bg-tertiary);border:1px solid var(--border-color);color:var(--text-primary);padding:10px 15px;border-radius:8px;cursor:pointer;font-weight: 600; 
    transition: background-color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
    display: flex; /* Для выравнивания иконки и текста */
    align-items: center;
    justify-content: center;
    gap: 8px;
}
.btn:hover{
    background-color: var(--bg-hover);
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}
.btn:active { transform: scale(0.98) translateY(0); } 
.btn-primary{background:var(--accent-color);border-color: var(--accent-color);color: #fff;}
.btn-primary:hover{background:var(--accent-hover);border-color: var(--accent-hover);}

/* --- КНОПКИ УПРАВЛЕНИЯ (БЛОК РЕДИЗАЙНА) --- */
.top-controls {
    /* (Было: position: fixed) */
    position: relative; 
    display: grid; /* --- ИЗМЕНЕНО: grid --- */
    grid-template-columns: 240px 1fr auto; /* --- ИЗМЕНЕНО: 3 колонки (auto для целей) --- */
    align-items: center;
    gap: 10px; 
    z-index: 10000;
    /* --- НОВЫЕ СТИЛИ ДЛЯ ШАПКИ --- */
    width: 100%;
    padding: 10px 20px;
    background: var(--bg-secondary);
    border-bottom: 1px solid var(--border-color);
    height: auto; /* --- ИЗМЕНЕНО: auto для колонки --- */
    min-height: var(--header-height);
}
.top-controls-left {
    display: flex;
    align-items: stretch; /* --- ИЗМЕНЕНО: stretch --- */
    gap: 8px; /* --- ИЗМЕНЕНО: 8px --- */
    flex-direction: column; /* --- ИЗМЕНЕНО: column --- */
}
/* --- НОВЫЙ СТИЛЬ: Растягиваем кнопки в левой колонке --- */
.top-controls-left .btn,
.top-controls-left .header-btn,
.top-controls-left .account-control-btn,
.top-controls-left .trash-popover-container {
    width: 100%;
}
.top-controls-right {
    display: flex; /* --- ИЗМЕНЕНО: Показываем правый блок --- */
    padding-right: 10px;
    align-items: center;
}

.top-controls-center {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 1.6em; /* --- ИЗМЕНЕНО: побольше --- */
    font-weight: bold;
    color: var(--accent-color);
    justify-self: center; /* --- ИЗМЕНЕНО: grid centering --- */
}
.top-controls-center img {
    height: 40px; /* --- ИЗМЕНЕНО: побольше --- */
    width: 40px; /* --- ИЗМЕНЕНО: побольше --- */
}

/* Стили для кнопок в шапке */
.header-btn, .save-all-btn, .account-control-btn {
    background: var(--bg-tertiary);
    color: var(--text-primary);
    padding: 8px 15px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 600;
    transition: background 0.2s, color 0.2s, transform 0.2s, box-shadow 0.2s ease; 
    border: 1px solid var(--border-color);
    display: flex;
    align-items: center;
    gap: 8px;
    text-decoration: none; /* Для ссылки-кнопки */
}
.save-all-btn:hover {
    background: var(--success-color);
    border-color: var(--success-color);
    color: #fff;
    transform: translateY(-2px);
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}
.account-control-btn:hover, .header-btn:hover {
    background: var(--accent-color);
    color: #fff;
    transform: translateY(-2px);
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}
.account-control-btn img, .save-all-btn img, .header-btn img {
    transition: filter 0.2s;
}
.account-control-btn:hover img, .save-all-btn:hover img, .header-btn:hover img {
    filter: invert(10%);
}
.save-all-btn.unsaved {
    border-color: var(--warning-color);
    box-shadow: 0 0 8px rgba(255, 193, 7, 0.5);
    animation: pulse 1.5s infinite;
}
@keyframes pulse {
    0% { box-shadow: 0 0 5px rgba(255, 193, 7, 0.4); }
    50% { box-shadow: 0 0 12px rgba(255, 193, 7, 0.8); }
    100% { box-shadow: 0 0 5px rgba(255, 193, 7, 0.4); }
}

/* --- ЦЕЛИ (Goal Styles) --- */
.goals h2 { margin-top: 0; color: var(--accent-color); border-bottom: 2px solid var(--border-color); padding-bottom: 10px;}
#goalsList {
    /* Стили для #goalsList будут в media-query */
}
.goal{
    background:var(--bg-tertiary);
    border-radius:8px;
    padding:10px;
    position:relative;
    transition: background-color 0.2s, box-shadow 0.2s, transform 0.2s ease;
    min-height: 40px;
    border-left: 6px solid var(--success-color); 
    font-size: 16px; 
}
.goal:hover{
    background:var(--bg-hover);
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 123, 255, 0.2); 
}
.goal .goal-remove{
    position:absolute;right:8px;top:50%;transform: translateY(-50%);opacity:0;cursor:pointer;color:var(--danger-color);font-size: 20px;
    transition: opacity 0.2s, transform 0.2s; 
}
.goal .goal-remove:hover { transform: translateY(-50%) scale(1.2); }
.goal:hover .goal-remove{opacity:1;}
.goal[contenteditable]:focus{
    outline:2px solid var(--accent-color);
    background: var(--bg-secondary);
    box-shadow: 0 0 8px rgba(0, 123, 255, 0.5);
}
.add-goal-btn{
    position:absolute;
    left:50%;
    transform:translateX(-50%);
    bottom:15px;
    background:#555;
    color:var(--text-primary);
    width:40px;height:40px;
    border-radius:50%;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:24px;
    cursor:pointer;
    display:none; 
    transition: background-color 0.2s, transform 0.2s ease-out; 
}
.goals:hover .add-goal-btn{display:flex}
.add-goal-btn:hover { 
    background-color: var(--accent-color); 
    transform: translateX(-50%) translateY(-5px) scale(1.05); 
}

/* --- МОДАЛЬНОЕ ОКНО: ОБЩИЕ СТИЛИ --- */
.modal{
    position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);backdrop-filter: blur(5px);
    /* ИЗМЕНЕНО: z-index повышен, чтобы быть выше шапки (z-index: 10000) */
    z-index:100000; 
    display:none;align-items: center; justify-content: center;
    opacity: 0; 
    transition: opacity 0.3s ease;
}
.modal.visible { opacity: 1; } 
.modal-content {
    background: var(--bg-main);
    width: 95%;
    border-radius: 12px;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    border: 1px solid var(--border-color);
    transform: scale(0.95); 
    transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    max-height: 90vh; /* ДОБАВЛЕНО ИЗ КАЛЕНДАРЯ */
}
.modal.visible .modal-content { transform: scale(1); } 

.modal-header{
    display:flex;justify-content:space-between;align-items:center;padding:15px 20px;
    background:var(--bg-secondary);border-bottom:1px solid var(--border-color);
    flex-shrink: 0;
}
.modal-header h2 { /* СТИЛЬ ИЗ КАЛЕНДАРЯ */
    margin: 0;
    font-size: 1.2em;
    color: var(--accent-color);
}
.modal-header .actions{display:flex;justify-content:flex-end;align-items:center;gap:15px;position:relative;}
.modal-header span{cursor:pointer;font-size:24px;position:relative; color: var(--text-secondary); transition: color 0.2s;}
.modal-header span:hover { color: var(--accent-color); }

.modal-body{ /* СТИЛЬ ИЗ КАЛЕНДАРЯ */
    padding: 20px;
    overflow-y: auto;
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    gap: 15px;
}
.modal-footer { /* СТИЛЬ ИЗ КАЛЕНДАРЯ */
    padding: 15px 20px; 
    border-top: 1px solid var(--border-color); 
    background: var(--bg-secondary);
    flex-shrink: 0;
}

/* --- МОДАЛЬНОЕ ОКНО ЛК --- */
.small-modal-content {
    max-width: 450px;
    height: auto;
    max-height: 90vh;
    padding: 20px;
    gap: 15px;
}

/* --- СТИЛИ ДЛЯ КНОПКИ В НИЖНЕМ ЛЕВОМ УГЛУ (AI Совет) --- */
#aiButtonContainer {
    position: fixed;
    bottom: 20px; 
    left: 20px; 
    z-index: 9999; 
}
#aiButtonContainer .btn {
    background: #39556d; 
    border-color: #39556d; 
    color: #fff;
    padding: 12px 20px;
    font-size: 16px;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
}
#aiButtonContainer .btn:hover {
    background: #476a8a;
    border-color: #476a8a;
}
@media (max-width: 768px) {
    #aiButtonContainer {
        bottom: 15px;
        left: 15px;
    }
    #aiButtonContainer .btn {
        padding: 10px 15px;
        font-size: 14px;
    }
}

/* --- СТИЛИ ДЛЯ ТРЕКЕРА ПРИВЫЧЕК --- */
.habit-tracker{background:var(--bg-secondary);padding:25px 20px; margin-bottom: 20px;}
.habit-tracker h2 { margin-top: 0; color: var(--success-color); }
.habit-controls{display:flex;gap:10px;margin-bottom:20px;align-items:center; flex-wrap: wrap;}
.habit-controls input{flex:1;background:var(--bg-tertiary);border:1px solid var(--border-color);color:var(--text-primary);padding:10px 12px;border-radius:8px; min-width: 200px;}
.habit-table-wrapper { overflow-x: auto; }
.habit-table{width:100%;border-collapse:collapse;table-layout:fixed; min-width: 600px;}
.habit-table th, .habit-table td{border:1px solid var(--border-color);padding:10px;text-align:center; transition: background-color 0.2s;}
.habit-table th{background:var(--bg-tertiary);font-weight:600; position: sticky; top: 0;}
.habit-table td:first-child, .habit-table th:first-child { text-align:left;font-weight:bold; width: 100px; position: sticky; left: 0; background: var(--bg-tertiary); }
.habit-table tr:hover td { background-color: var(--bg-hover); }
.habit-table input[type="checkbox"]{width:20px;height:20px;cursor:pointer; accent-color: var(--success-color); transform: scale(1.1); transition: transform 0.1s;} 
.habit-table input[type="checkbox"]:hover { transform: scale(1.2); }
.progress-col { width: 150px; }
.progress-bar-container { width: 100%; height: 22px; background-color: var(--bg-tertiary); border-radius: 5px; position: relative; overflow: hidden; display: flex; align-items: center; justify-content: center; border: 1px solid var(--border-color);}
.progress-bar { position: absolute; left: 0; top: 0; height: 100%; background-color: var(--success-color); border-radius: 5px; transition: width 0.4s cubic-bezier(0.25, 1, 0.5, 1); }
.progress-bar-text { position: relative; z-index: 1; font-size: 12px; font-weight: bold; color: #fff; text-shadow: 1px 1px 1px rgba(0,0,0,0.5); }
.habit-table th { position: relative; }
.habit-header-content { display: flex; justify-content: space-between; align-items: center; gap: 5px; }
.habit-header-content span[contenteditable] { flex-grow: 1; text-align: left; }
.remove-habit {
    color: var(--danger-color); font-size: 18px; font-weight: bold; cursor: pointer; line-height: 1;
    opacity: 0.5; transition: opacity 0.2s, transform 0.2s; flex-shrink: 0;
}
.remove-habit:hover { opacity: 1; transform: rotate(90deg); }
.habit-table-container { overflow: hidden; position: relative; transition: max-height 0.5s ease-out; max-height: 500px; }
.habit-table-container.collapsed { max-height: 250px; }
.toggle-history-btn { width: 100%; text-align: center; background: var(--bg-tertiary); color: var(--accent-color); padding: 10px; border: 1px solid var(--border-color); border-top: none; cursor: pointer; font-weight: 600; transition: background 0.2s; border-radius: 0 0 8px 8px; }
.toggle-history-btn:hover { background: var(--bg-hover); }

/* --- СТИЛИ ДЛЯ ТРЕКЕРА НАСТРОЕНИЯ --- */
.mood-tracker { background: var(--bg-secondary); padding: 25px 20px; }
.mood-tracker h2 { margin-top: 0; color: var(--warning-color); border-bottom: 2px solid var(--border-color); padding-bottom: 10px; margin-bottom: 15px;}
.mood-selection { display: flex; gap: 15px; justify-content: center; align-items: center; margin-bottom: 25px; }
.mood-option { font-size: 40px; cursor: pointer; transition: transform 0.2s, opacity 0.2s, text-shadow 0.2s; opacity: 0.6; }
.mood-option:hover { transform: scale(1.15) rotate(-5deg); opacity: 1; }
.mood-option.selected { opacity: 1; transform: scale(1.25); text-shadow: 0 0 15px var(--warning-color); }
.mood-history-controls { display: flex; justify-content: center; gap: 10px; margin-bottom: 15px; }
.mood-calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; text-align: center; background: var(--bg-tertiary); padding: 10px; border-radius: 8px; }
.mood-calendar-day { padding: 8px 0; font-size: 14px; font-weight: 600; color: var(--text-secondary); }
.mood-calendar-cell { padding: 5px 0; background: var(--bg-secondary); border-radius: 4px; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 40px; cursor: default; transition: transform 0.2s; }
.mood-calendar-cell:hover { transform: scale(1.05); }
.mood-calendar-cell.has-data { cursor: pointer; }
.mood-calendar-cell.empty { background: var(--bg-main); cursor: default; }
.day-number { font-size: 12px; color: var(--text-secondary); }
.day-mood { font-size: 18px; margin-top: 2px; }
.current-month-select { background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-color); padding: 5px 10px; border-radius: 6px; cursor: pointer; }

/* --- СТИЛИ ДЛЯ ЛИЧНОГО КАБИНЕТА --- */
.profile-section { display: flex; flex-direction: column; gap: 15px; padding: 15px; border: 1px solid var(--border-color); border-radius: 8px; }
.profile-section h3 { margin: 0; color: var(--accent-color); font-size: 1.1em; border-bottom: 1px dashed var(--border-color); padding-bottom: 5px; }
.profile-input-group { display: flex; gap: 10px; align-items: center; }
.profile-input-group input { flex: 1; background: var(--bg-tertiary); border: 1px solid var(--border-color); color: var(--text-primary); padding: 8px 12px; border-radius: 6px; }
.btn-save-nick { background: var(--success-color); border-color: var(--success-color); }
.btn-save-nick:hover { background: #3e8e41; }
.btn-logout { background: var(--bg-tertiary); border-color: var(--border-color); }
.btn-logout:hover { background: var(--bg-hover); }
.btn-delete { background: var(--danger-color); border-color: var(--danger-color); }
.btn-delete:hover { background: #c32727; }
/* --- СТИЛИ ДЛЯ БЛОКА ПОДПИСКИ --- */
.subscription-container {
    display: flex;
    flex-direction: column;
    gap: 12px;
    align-items: center;
    background: var(--bg-main); /* Чуть темнее фона секции */
    padding: 15px;
    border-radius: 8px;
    border: 1px solid var(--border-color);
}

.subscription-badge {
    width: 100%;
    padding: 12px;
    border-radius: 8px;
    text-align: center;
    font-weight: 800;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    font-size: 1.2em;
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 10px;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    user-select: none;
}

/* Стиль по умолчанию (Free) */
.subscription-badge.free {
    background: linear-gradient(135deg, #3a3a3a, #555);
    color: #e0e0e0;
    border: 1px solid #666;
}

/* Стиль для Premium (на будущее) */
.subscription-badge.premium {
    background: linear-gradient(135deg, #FFD700, #FFA500);
    color: #000;
    text-shadow: 0 1px 0 rgba(255, 255, 255, 0.4);
    box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3);
    border: none;
}
/* Стиль для Pro/Max (на будущее) */
.subscription-badge.premium_plus {
    background: linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%);
    color: #fff;
    text-shadow: 0 1px 2px rgba(0,0,0,0.2);
    box-shadow: 0 4px 15px rgba(161, 140, 209, 0.4);
    border: none;
}

.subscription-badge:hover {
    transform: scale(1.02);
}

.btn-tariffs {
    background: transparent;
    border: 2px solid var(--accent-color);
    color: var(--accent-color);
    width: 100%;
    justify-content: center;
    text-decoration: none;
    transition: all 0.3s ease;
}

.btn-tariffs:hover {
    background: var(--accent-color);
    color: #fff;
    box-shadow: 0 0 15px rgba(0, 123, 255, 0.4);
    transform: translateY(-2px);
}

/* --- СТИЛИ ДЛЯ АНИМАЦИИ ЗАГРУЗКИ --- */
#loadingOverlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); display: none; 
    flex-direction: column; justify-content: center; align-items: center; color: var(--text-primary); font-size: 1.2em;
    z-index: 100001; opacity: 0; transition: opacity 0.3s ease;
}
.spinner { border: 4px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top: 4px solid var(--accent-color); width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 15px; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

/* --- КОНТЕЙНЕР УВЕДОМЛЕНИЙ --- */
#notification-container {
    position: fixed;
    top: 80px; /* Ниже шапки */
    right: 20px;
    z-index: 100001; /* Выше модальных окон, но ниже AI */
    display: flex;
    flex-direction: column;
    gap: 10px;
}
.custom-notification {
    background: var(--bg-tertiary);
    color: var(--text-primary);
    border: 1px solid var(--border-color);
    border-left: 5px solid var(--warning-color);
    border-radius: 8px;
    padding: 15px 20px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 15px;
    width: 350px;
    max-width: 90vw;
    opacity: 0;
    transform: translateX(100%);
    transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}
.custom-notification.show {
    opacity: 1;
    transform: translateX(0);
}
.custom-notification.success {
    border-left-color: var(--success-color);
}
.custom-notification.error {
    border-left-color: var(--danger-color);
}
.custom-notification p {
    margin: 0;
    line-height: 1.4;
    word-break: break-word;
}
.custom-notification .close-btn {
    font-size: 24px;
    color: var(--text-secondary);
    cursor: pointer;
    background: none;
    border: none;
    padding: 0 5px;
    line-height: 1;
}
.custom-notification .close-btn:hover {
    color: var(--text-primary);
}


/* --- БОКОВОЕ ОКНО AI-СОВЕТА (DRAWER) --- */
.advice-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.7); 
    display: none;
    z-index: 10000000000;
    opacity: 0;
    transition: opacity 0.3s ease;
}
.advice-modal-overlay.visible {
    display: block;
    opacity: 1;
}
.advice-modal-drawer {
    position: fixed;
    top: 0;
    right: 0; 
    width: 400px; 
    max-width: 90%; 
    height: 100%;
    background-color: var(--bg-secondary);
    box-shadow: -6px 0 15px rgba(0, 0, 0, 0.4);
    z-index: 100100000000;
    display: flex;
    flex-direction: column;
    transform: translateX(100%); 
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}
.advice-modal-overlay.visible .advice-modal-drawer {
    transform: translateX(0);
}
.advice-drawer-header {
    padding: 15px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid var(--border-color);
    background: var(--bg-tertiary);
}
.advice-drawer-header h2 {
    margin: 0;
    color: var(--accent-color);
    font-size: 1.3em;
}
.advice-drawer-close {
    background: none;
    border: none;
    font-size: 30px;
    cursor: pointer;
    color: var(--text-secondary);
    line-height: 1;
    transition: color 0.2s;
}
.advice-drawer-close:hover {
    color: var(--danger-color);
}
.advice-drawer-content {
    padding: 20px;
    flex-grow: 1;
    overflow-y: auto; 
}
.advice-drawer-content p {
    white-space: pre-wrap;
    line-height: 1.7;
    font-size: 15px;
    color: var(--text-primary);
    padding-right: 5px; 
}
.advice-drawer-content h3 {
    font-size: 1.4em;
    font-weight: 700;
    color: var(--accent-color); 
    margin-top: 25px;
    margin-bottom: 10px;
    padding-bottom: 5px;
    border-bottom: 2px solid var(--border-color);
}
.advice-drawer-content ul {
    list-style: none; 
    padding-left: 0;
    margin-top: 0;
}
.advice-drawer-content li {
    margin-bottom: 8px;
    line-height: 1.5;
    padding-left: 18px; 
    position: relative;
}
.advice-drawer-content li::before {
    content: '•';
    color: var(--warning-color); 
    font-weight: bold;
    display: inline-block;
    width: 1em;
    margin-left: -1em;
    position: absolute;
    left: 0;
}
.advice-drawer-content strong {
    color: var(--text-primary);
    font-weight: 600;
}
/* --- СТИЛИ ДЛЯ КНОПКИ БАЗЫ ЗНАНИЙ --- */
.knowledge-base-btn {
    color: #fff;
    border: none;
    text-decoration: none; 
    background: linear-gradient(45deg, #007bff, #6f42c1, #d63384);
    background-size: 200% 200%;
    animation: gradient-animation 5s ease infinite;
}
.knowledge-base-btn:hover {
    color: #fff;
    box-shadow: 0 0 15px rgba(111, 66, 193, 0.7);
}
@keyframes gradient-animation {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
}
    /* Основные стили футера */
#main-footer {
    position: relative; 
    width: 100%;
    min-height: 200px; 
    background-color: #333; 
    color: #fff;
    padding: 20px 0;
    overflow: hidden; 
}
#particles-js {
    position: absolute; 
    width: 100%;
    height: 100%;
    top: 0;
    left: 0;
    z-index: 1; 
}
.footer-content {
    position: relative;
    text-align: center;
    padding-top: 50px; 
    z-index: 2; 
}
.footer-content p {
    margin: 0;
    font-size: 14px;
}

/* --- СТИЛИ ДЛЯ НИЖНЕЙ МОБИЛЬНОЙ НАВИГАЦИИ --- */
.mobile-bottom-nav {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    background: var(--bg-secondary);
    border-top: 1px solid var(--border-color);
    display: none; /* Скрыто по умолчанию */
    justify-content: space-around;
    align-items: flex-start; 
    padding: 6px 0 8px 0;
    z-index: 10003; 
    box-shadow: 0 -2px 10px rgba(0,0,0,0.3);
}
.mobile-nav-btn {
    background: none;
    border: none;
    color: var(--text-secondary);
    font-size: 10px;
    font-family: inherit;
    display: flex;
    flex-direction: column;
    align-items: center;
    flex: 1;
    padding: 4px;
    cursor: pointer;
    transition: color 0.2s;
    text-align: center;
}
.mobile-nav-btn .icon {
    font-size: 20px;
    margin-bottom: 3px;
    line-height: 1;
}
.mobile-nav-btn .label {
    line-height: 1.2;
}
.mobile-nav-btn:hover {
    color: var(--text-primary);
}
/* НОВЫЙ СТИЛЬ: Активная кнопка-вкладка */
.mobile-nav-btn.active {
    color: var(--accent-color);
    font-weight: 600;
}

.mobile-nav-btn#mobileNavSave.unsaved {
    color: var(--warning-color);
    animation: pulse-mobile 1.5s infinite;
}
.mobile-nav-btn#mobileNavSave.unsaved .icon {
    animation: pulse-icon 1.5s infinite;
}
@keyframes pulse-mobile {
    0% { color: var(--warning-color); }
    50% { color: var(--text-primary); }
    100% { color: var(--warning-color); }
}
@keyframes pulse-icon {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
}


/* ---
--- НОВЫЕ СТИЛИ ДЛЯ КАЛЕНДАРЯ ---
--- */

/* --- НОВЫЕ СТИЛИ ДЛЯ КАЛЕНДАРЯ ---
--- */

.calendar-wrapper {
    width: 95%; /* Убедитесь, что ширина меньше 100% для работы margin: auto */
    max-width: 1400px;
    margin: 20px auto; /* <--- ГЛАВНОЕ ДЛЯ ЦЕНТРИРОВАНИЯ */
    padding: 20px;
    background: var(--bg-secondary);
    border-radius: 12px;
    border: 1px solid var(--border-color);
}

.calendar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 1px solid var(--border-color);
}

.calendar-nav {
    display: flex;
    align-items: center;
    gap: 10px;
}
.calendar-nav .nav-btn {
    font-size: 20px;
    padding: 5px 12px;
}
#current-month-display {
    font-size: 1.5em;
    font-weight: 600;
    color: var(--accent-color);
    text-align: center;
    min-width: 200px;
}

.view-toggle {
    display: flex;
    gap: 10px;
}
.view-toggle .btn {
    background: var(--bg-tertiary);
}
.view-toggle .btn.active {
    background: var(--accent-color);
    color: #fff;
    box-shadow: 0 0 8px rgba(0, 123, 255, 0.5);
}

/* --- Стили для вида "Месяц" --- */
#month-view {
    display: block; /* По умолчанию */
}
.calendar-weekdays {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 5px;
    margin-bottom: 10px;
}
.weekday {
    text-align: center;
    font-weight: 600;
    color: var(--text-secondary);
    padding: 10px 0;
    font-size: 0.9em;
}
.calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 8px;
    min-height: 60vh;
}
.calendar-day {
    background: var(--bg-main);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 8px;
    min-height: 120px;
    cursor: pointer;
    transition: background-color 0.2s, border-color 0.2s;
    display: flex;
    flex-direction: column;
    gap: 5px;
}
.calendar-day:hover {
    background: var(--bg-hover);
    border-color: var(--accent-color);
}
.calendar-day.other-month {
    background: transparent;
    opacity: 0.4;
    cursor: default;
}
.calendar-day.other-month:hover {
    background: transparent;
    border-color: var(--border-color);
}
.calendar-day.today {
    border-color: var(--warning-color);
    box-shadow: 0 0 10px rgba(255, 193, 7, 0.3);
}
.day-number {
    font-weight: 600;
    font-size: 0.9em;
}
.tasks-preview {
    display: flex;
    /* ИЗМЕНЕНО: Задачи теперь отображаются в строку и переносятся */
    flex-direction: row;
    flex-wrap: wrap;
    gap: 4px;
    overflow: hidden;
}
.task-preview-item {
    font-size: 0.8em;
    padding: 2px 5px;
    background: var(--bg-tertiary);
    border-radius: 4px;
    /* ИЗМЕНЕНО: Убрано все, что связано с текстом */
    display: inline-block;
    line-height: 1.2;
}
.task-preview-item.done {
    opacity: 0.5;
    text-decoration: line-through;
}
.task-preview-time {
    color: var(--accent-color);
    font-weight: 600;
}

/* --- Стили для вида "Неделя" --- */
#week-view {
    display: none; /* Скрыт по умолчанию */
}
.week-view-container {
    display: flex;
    gap: 10px;
    overflow-x: auto;
    padding-bottom: 15px;
    min-height: 60vh;
}
.week-day-column {
    flex: 1;
    min-width: 280px;
    max-width: 350px;
    background: var(--bg-main);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    display: flex;
    flex-direction: column;
}
.week-day-column.today {
    border-color: var(--warning-color);
    box-shadow: 0 0 10px rgba(255, 193, 7, 0.3);
}
.week-day-header {
    padding: 12px 15px;
    border-bottom: 1px solid var(--border-color);
    background: var(--bg-tertiary);
    border-radius: 8px 8px 0 0;
}
.week-day-header h3 {
    margin: 0;
    font-size: 1.1em;
}
.week-day-header .date-display {
    font-size: 0.9em;
    color: var(--text-secondary);
}
.task-list-week {
    display: flex;
    flex-direction: column;
    gap: 8px;
    padding: 10px;
    overflow-y: auto;
    flex-grow: 1;
}

/* ИЗМЕНЕНО: Стили для формы добавления в неделе */
.add-task-form-week {
    padding: 10px;
    border-top: 1px solid var(--border-color);
    display: flex;
    gap: 8px;
    align-items: flex-end; /* Кнопка прижимается к низу */
}
.form-inputs-week {
    display: flex;
    flex-direction: column;
    gap: 5px;
    flex-grow: 1;
}
.add-task-form-week input {
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    color: var(--text-primary);
    padding: 8px 10px;
    border-radius: 6px;
    font-size: 14px;
    width: 100%; /* Поля занимают всю ширину колонки */
}
.add-task-form-week input[type="text"] {
    flex-grow: 1;
}
.add-task-form-week button {
    padding: 8px 10px;
    min-width: 40px;
    flex-shrink: 0; /* Кнопка не сжимается */
}
.send-icon {
    width: 20px;
    height: 20px;
    fill: currentColor;
}

/* --- Стили для элементов задач (в модалке и неделе) --- */
#modal-task-list, .task-list-week {
    display: flex;
    flex-direction: column;
    gap: 10px;
}
.task-item {
    display: flex;
    align-items: center;
    gap: 10px;
    background: var(--bg-tertiary);
    padding: 10px;
    border-radius: 6px;
    border-left: 4px solid var(--border-color);
    position: relative; /* ДОБАВЛЕНО: Для позиционирования меню */
}
.task-item.done {
    border-left-color: var(--success-color);
    opacity: 0.7;
}
.task-item-checkbox {
    width: 18px;
    height: 18px;
    flex-shrink: 0;
    accent-color: var(--success-color);
    cursor: pointer;
}
.task-item-time {
    font-weight: 600;
    color: var(--accent-color);
    font-size: 0.9em;
    width: 50px;
    flex-shrink: 0;
}
.task-item-text {
    flex-grow: 1;
    word-break: break-word;
    font-size: 0.95em;
}
.task-item.done .task-item-text {
    text-decoration: line-through;
}

/* ДОБАВЛЕНО: Стили для кнопки "Больше" (три точки) и меню */
.task-item-more {
    background: none;
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    font-size: 20px;
    padding: 0 5px;
    opacity: 0.6;
    transition: opacity 0.2s, color 0.2s;
    line-height: 1;
    font-weight: bold;
    flex-shrink: 0;
}
.task-item-more:hover {
    opacity: 1;
    color: var(--accent-color);
}
.task-item-menu {
    display: none;
    position: absolute;
    top: 30px; /* Под кнопкой */
    right: 5px;
    background: var(--bg-main);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    z-index: 100;
    width: 180px;
    padding: 5px;
    animation: fadeIn 0.1s ease-out;
}
.task-item-menu.visible {
    display: block;
}
.task-menu-item {
    padding: 8px 12px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.9em;
    transition: background-color 0.2s, color 0.2s;
    user-select: none;
}
.task-menu-item:hover {
    background-color: var(--bg-hover);
}
.task-menu-item[data-action="delete"]:hover {
    background-color: var(--danger-color);
    color: #fff;
}
/* ---------------------------------- */

.no-tasks {
    color: var(--text-secondary);
    text-align: center;
    padding: 20px;
}

/* --- Стили для формы добавления в модалке --- */
#add-task-form-modal {
    display: flex;
    gap: 10px;
}
#add-task-form-modal input {
    background: var(--bg-tertiary);
    border: 1px solid var(--border-color);
    color: var(--text-primary);
    padding: 10px 12px;
    border-radius: 6px;
    font-size: 15px;
}
#add-task-form-modal input:focus {
    outline: none;
    border-color: var(--accent-color);
    box-shadow: 0 0 8px rgba(0, 123, 255, 0.4);
}
#new-task-time {
    width: 100px;
}
#new-task-text {
    flex-grow: 1;
}
#add-task-btn {
    padding: 10px 12px;
    min-width: 44px;
}


/* ДОБАВЛЕНО: Стили для модалки повторений */
.form-group {
    margin-bottom: 15px;
}
.form-group label, .recur-options p {
    display: block;
    margin-bottom: 5px;
    font-weight: 600;
    color: var(--text-secondary);
    font-size: 0.9em;
}
.form-control {
    width: 100%;
    background: var(--bg-tertiary);
    border: 1px solid var(--border-color);
    color: var(--text-primary);
    padding: 10px 12px;
    border-radius: 6px;
    font-size: 15px;
}
select.form-control {
    appearance: none;
    -webkit-appearance: none;
    background-image: url('data:image/svg+xml;utf8,<svg fill="%23a0a0a0" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/></svg>');
    background-repeat: no-repeat;
    background-position: right 10px center;
    padding-right: 40px;
}
.weekday-picker {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
}
.weekday-picker label {
    display: flex;
    align-items: center;
    gap: 5px;
    background: var(--bg-tertiary);
    padding: 8px 12px;
    border-radius: 6px;
    cursor: pointer;
    border: 1px solid var(--border-color);
    transition: background-color 0.2s, border-color 0.2s;
    font-size: 0.9em;
}
.weekday-picker input {
    accent-color: var(--accent-color);
}
.weekday-picker label:has(input:checked) {
     background: var(--accent-color);
     border-color: var(--accent-color);
     color: #fff;
}
/* ---------------------------------- */


/* --- 
--- СТИЛИ РЕДИЗАЙНА ДЛЯ ДЕСКТОПА ---
--- */

@media (min-width: 769px) {
    .banner {
        display: none; /* Скрываем старый баннер */
    }

    /* ИЗМЕНЕНО: Выравниваем колонки шапки по верху */
    .top-controls {
        align-items: start;
    }

    .main-container {
        padding: 0; /* Убираем отступы у главного контейнера */
    }

    /* --- ИЗМЕНЕНО: Стили для целей в шапке (теперь колонка) --- */
    .goals {
        position: static; /* Убираем sticky */
        width: 100%;
        height: auto;
        max-height: none;
        border: none; /* Убираем рамки */
        padding: 0;
        display: flex;
        flex-direction: column; /* ИЗМЕНЕНО: в колонку */
        align-items: stretch; /* ИЗМЕНЕНО: растягиваем */
        gap: 10px; /* Отступ между элементами */
        overflow: visible;
        background: transparent; /* Фон наследуется от шапки */
    }
    .goals h2 {
        display: block; /* ИЗМЕНЕНО: Показываем заголовок */
        margin: 0;
        font-size: 16px;
        color: var(--accent-color);
        border: none;
        padding: 0;
    }
    #goalsList {
        display: flex;
        flex-direction: column; /* ИЗМЕНЕНО: в колонку */
        gap: 10px; /* ИЗМЕНЕНО: отступ */
        align-items: stretch;
        flex: 1; /* Занимает доступное место */
    }
    .goals .goal {
        font-size: 14px; /* ИЗМЕНЕНО: чуть крупнее */
        padding: 8px 10px; /* ИЗМЕНЕНО: чуть крупнее */
        margin: 0;
    }
    .add-goal-btn {
        position: static; /* Убираем absolute */
        transform: none;
        width: 40px; /* ИЗМЕНЕНО: крупнее */
        height: 40px; /* ИЗМЕНЕНО: крупнее */
        font-size: 24px; /* ИЗМЕНЕНО: крупнее */
        flex-shrink: 0;
        display: flex; /* Показываем кнопку "добавить" всегда */
        align-self: center; /* ИЗМЕНЕНО: центрируем кнопку */
    }
    .goals:hover .add-goal-btn {
        display: flex;
        transform: none; /* Убираем hover-эффект */
    }
    .add-goal-btn:hover {
        background-color: var(--accent-color); 
        transform: scale(1.05); /* Оставляем hover на самой кнопке */
    }
    /* --- КОНЕЦ СТИЛЕЙ ДЛЯ ЦЕЛЕЙ --- */


    /* .right - это контейнер для "Календаря" */
    .right {
        padding: 10px;
        gap: 10px;
    }

    /* --- Стили для .calendar-wrapper внутри .right --- */
    .right .calendar-wrapper {
        width: 100%;
        margin: 0;
        flex-grow: 1; /* Занимает все место */
    }
}


/* --- АДАПТИВНОСТЬ ДЛЯ МОБИЛЬНЫХ УСТРОЙСТВ --- */
@media (max-width: 768px) {
    body { 
        font-size: 14px; 
        padding-bottom: 80px; 
    }
    .main-container { flex-direction: column; padding: 0; overflow-x: hidden; } 
    
    .mobile-section {
        display: none; 
    }
    .mobile-section.active {
        display: block; 
    }
    .mobile-section.goals.active {
        display: flex;
    }

    /* --- ИЗМЕНЕНИЕ: .goals на мобильных --- */
    .goals { 
        width: 100%; 
        border-right: none; 
        border-left: none; 
        border-bottom: 1px solid var(--border-color); 
        padding: 15px; 
        height: auto; 
        max-height: none; 
        overflow-y: visible; 
        position: static; /* Стили по умолчанию для мобильной секции */
    }
    #goalsList {
        /* Стили по умолчанию (колонка) */
        display: flex;
        flex-direction: column;
        gap: 15px;
        max-height: none;
        overflow-y: visible;
    }
    /* Кнопка "Добавить" на мобильных */
    .add-goal-btn {
        position:absolute;
        left:50%;
        transform:translateX(-50%);
        bottom:15px;
        width:40px;height:40px;
        font-size:24px;
        display:none; /* Скрыта, пока не наведешь */
    }
    .goals:hover .add-goal-btn{display:flex}
    /* --- КОНЕЦ ИЗМЕНЕНИЙ .goals --- */


    .right { padding: 0; overflow-y: visible; } /* Убрали отступы для .right */

    /* --- ИЗМЕНЕНИЯ ПО ЗАПРОСУ --- */
    .mobile-bottom-nav {
        display: flex;
    }
    
    /* --- ИЗМЕНЕНИЕ: Шапка на мобильных --- */
    .top-controls { 
        display: block; /* WAS: none. Показываем, т.к. .goals теперь тут */
        align-items: start; /* ИЗМЕНЕНО */
    }
    .top-controls-left,
    .top-controls-center {
        display: none; /* Скрываем левую колонку и лого на мобильных */
    }
    .top-controls-right {
        display: block; /* Показываем правую колонку (где .goals) */
    }
    /* --- КОНЕЦ ИЗМЕНЕНИЙ ШАПКИ --- */

    #aiButtonContainer {
        display: none; 
    }
    
    .save-all-btn, .account-control-btn { font-size: 12px; padding: 6px 10px; }
    .habit-controls { flex-direction: column; align-items: stretch; }
    
    /* --- Стили календаря на мобильных --- */
    .calendar-wrapper { width: 100%; margin: 0; border-radius: 0; border: none; padding: 10px; }
    .calendar-header { flex-direction: column; gap: 15px; }
    #current-month-display { font-size: 1.3em; }
    .calendar-grid { gap: 2px; min-height: 50vh; }
    .calendar-day { min-height: 80px; padding: 5px; gap: 3px; }
    .day-number { font-size: 0.8em; }
    .task-preview-item { font-size: 0.7em; padding: 1px 3px; }
    .weekday { font-size: 0.8em; padding: 5px 0; }
    
    .week-day-column { min-width: 290px; }
    
    .add-task-form-week input { padding: 6px 8px; font-size: 13px; }
    .add-task-form-week button { padding: 6px 8px; min-width: 36px; }
    .send-icon { width: 18px; height: 18px; }
    /* --- Конец стилей календаря --- */
    
    /* --- Стили модалок --- */
    .modal-content { width: 100%; height: 100%; max-height: 100vh; border-radius: 0; }
    .small-modal-content { max-width: 100%; margin: 0; border-radius: 0; }
    .advice-modal-drawer { width: 100%; max-width: 100%; }

    .mood-calendar { grid-template-columns: repeat(4, 1fr); }
    .mood-option { font-size: 30px; }
}
/* --- СТИЛИ ДЛЯ МОДАЛЬНОГО ОКНА НАСТРОЕНИЯ --- */

/* Стиль для кнопки "X" в шапке (как у других модалок) */
#close-mood-modal {
    cursor: pointer;
    font-size: 24px;
    color: var(--text-secondary);
    transition: color 0.2s;
}
#close-mood-modal:hover {
    color: var(--accent-color);
}

/* Добавляем подсветку и эффект для эмодзи */
#mood-modal-emoji {
    /* Та же подсветка, что и у выбранного смайлика */
    text-shadow: 0 0 15px var(--warning-color);
    transition: transform 0.2s ease;
}
#mood-modal-emoji:hover {
    transform: scale(1.1); /* Маленький эффект при наведении */
}

/* Улучшаем textarea для комментария */
#mood-modal-comment {
    font-family: inherit; /* Чтобы шрифт был как у всего сайта */
    resize: vertical;     /* Разрешаем менять размер по вертикали */
    min-height: 120px;    /* Делаем поле чуть побольше */
    transition: border-color 0.2s, box-shadow 0.2s;
}

/* Эффект :focus для textarea, как у других полей */
#mood-modal-comment:focus {
    outline: none;
    border-color: var(--accent-color);
    box-shadow: 0 0 8px rgba(0, 123, 255, 0.4);
}

/* Добавляем отступ между кнопками "Отмена" и "Сохранить" */
#mood-comment-modal .modal-footer div {
    display: flex;
    gap: 10px;
}

/* Улучшаем кнопку "Удалить" */
#mood-modal-delete-btn {
    color: #fff; /* Убедимся, что текст белый */
    transition: background-color 0.2s, transform 0.2s, box-shadow 0.2s;
}
#mood-modal-delete-btn:hover {
    background-color: #c32727; /* Тот же hover, что у .btn-delete */
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(229, 57, 53, 0.3);
}
/* --- СТАТИСТИКА В ПРОФИЛЕ --- */
.profile-stats {
    display: flex;
    justify-content: space-around;
    gap: 15px;
    padding: 10px;
    background: var(--bg-tertiary);
    border-radius: 6px;
}
.profile-stats div {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 5px;
}
.profile-stats span {
    font-size: 14px;
    color: var(--text-secondary);
}
.profile-stats strong {
    font-size: 20px;
    font-weight: 600;
    color: var(--accent-color);
}


/* --- МОБИЛЬНАЯ НАВИГАЦИЯ (РЕДИЗАЙН) --- */
@media (max-width: 768px) {
    .mobile-bottom-nav {
        display: flex;
        justify-content: space-between;
        align-items: flex-end; 
        height: 75px; 
        padding: 0 10px;
        padding-bottom: 8px; 
    }
    .mobile-bottom-nav .mobile-nav-btn {
        flex: 1;
        max-width: 60px; 
        align-items: center;
        justify-content: center;
        padding-top: 6px; 
        height: 60px; 
        align-self: center; 
    }

    .mobile-nav-center-btn-container {
        flex: 0 0 70px; 
        position: relative;
        display: flex;
        justify-content: center;
        height: 100%;
        align-items: flex-start; 
    }

    .mobile-nav-center-btn {
        position: absolute;
        top: -20px; 
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: var(--accent-color);
        border: 4px solid var(--bg-main);
        box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.4);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: transform 0.2s ease, background-color 0.2s;
    }
    .mobile-nav-center-btn:hover {
        transform: scale(1.1);
        background-color: var(--accent-hover);
    }
    .mobile-nav-center-btn:active {
        transform: scale(0.95);
    }

    .hamburger-icon {
        display: flex;
        flex-direction: column;
        gap: 4px;
        width: 22px;
    }
    .hamburger-icon span {
        width: 100%;
        height: 3px;
        background-color: #fff;
        border-radius: 2px;
        transition: transform 0.3s ease, opacity 0.3s ease;
    }

    /* Анимация гамбургера в крестик (при открытии меню) */
    .mobile-nav-center-btn.is-open .hamburger-icon span:nth-child(1) {
        transform: translateY(7px) rotate(45deg);
    }
    .mobile-nav-center-btn.is-open .hamburger-icon span:nth-child(2) {
        opacity: 0;
    }
    .mobile-nav-center-btn.is-open .hamburger-icon span:nth-child(3) {
        transform: translateY(-7px) rotate(-45deg);
    }
}

/* --- ВСПЛЫВАЮЩЕЕ МОБИЛЬНОЕ МЕНЮ (РЕДИЗАЙН) --- */
.mobile-menu-overlay {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(5px);
    z-index: 10002;
    display: flex;
    flex-direction: column;
    justify-content: flex-end; 
    align-items: center;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s ease, visibility 0.3s ease;
    padding-bottom: 95px; 
}
.mobile-menu-overlay.visible {
    opacity: 1;
    visibility: visible;
}

.mobile-menu-content {
    display: flex;
    flex-direction: column;
    gap: 10px; 
    
    padding: 15px;
    width: 90%;
    max-width: 320px; 
    
    background: var(--bg-tertiary);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    box-shadow: 0 -4px 15px rgba(0,0,0,0.3);

    transform-origin: bottom center;
    transform: translateY(10px) scale(0.9);
    opacity: 0;
    transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.2s ease-out;
}
.mobile-menu-overlay.visible .mobile-menu-content {
    transform: translateY(0) scale(1);
    opacity: 1;
}

.mobile-menu-btn {
    background: var(--bg-hover); 
    border: 1px solid var(--border-color);
    color: var(--text-primary);
    border-radius: 10px; 
    padding: 12px 15px;
    
    display: flex;
    flex-direction: row; 
    align-items: center;
    justify-content: flex-start; 
    gap: 15px; 
    
    font-size: 16px; 
    font-weight: 500; 
    cursor: pointer;
    transition: transform 0.2s ease, background-color 0.2s ease;
}
.mobile-menu-btn .icon {
    font-size: 24px; 
    flex-shrink: 0;
    width: 30px; 
    text-align: center;
}
.mobile-menu-btn .label {
    font-size: 15px; 
    font-weight: 500;
}
.mobile-menu-btn:hover {
    background-color: var(--accent-color); 
    transform: translateY(-2px);
    color: #fff;
}
.mobile-menu-btn:active {
    transform: scale(0.98);
}

.mobile-menu-close-btn {
    display: none; 
}
</style>
</head>

<body>

<div id="notification-container"></div>

<div class="top-controls">
    <div class="top-controls-left">
        <div id="accountControl" class="account-control-btn">
            <img src="pictures/account.png" width="16" height="16" alt="Profile">
            <span id="usernameDisplay">Профиль</span>
        </div>
        <button id="saveAllBtn" class="save-all-btn">
            <img src="pictures/save.png" width="16" height="16" alt="Save">
            <span id="saveAllBtnText">Сохранить все</span>
        </button>
        <a href="meds.html" class="header-btn">
            <span class="icon">💊️</span>
            <span>Лекарства</span>
        </a>
        
        <a href="knowledge_base.html" class="btn knowledge-base-btn">
            🧠 Перейти в Базу Знаний
        </a>
        <a href="lists.html" class="btn knowledge-base-btn">
            📝 Перейти в Списки
        </a>
    </div>

    <div class="top-controls-center">
        <img src="pictures/favicon.png" alt="Logo">
        <span>Time Owner</span>
    </div>
    
    <div class="top-controls-right">
        <aside class="goals mobile-section" id="mobileSectionGoals">
            <h2>Годовые цели</h2>
            <div id="goalsList"></div>
            <div id="addGoalBtn" class="add-goal-btn">＋</div>
        </aside>
    </div>
</div>

<div class="banner">
  <img id="bannerImg" src="pictures/banner.jpg" alt="Баннер">
</div>

<div class="main-container">
  
  <main class="right mobile-section" id="mobileSectionWeeks">
    
    <main class="calendar-wrapper">
        <div class="calendar-header">
            <div class="view-toggle">
                <button class="btn active" id="month-view-btn">Месяц</button>
                <button class="btn" id="week-view-btn">Неделя</button>
            </div>
            
            <div class="calendar-nav">
                <button class="btn nav-btn" id="prev-btn">‹</button>
                <h2 id="current-month-display"></h2>
                <button class="btn nav-btn" id="next-btn">›</button>
            </div>
            
            <button class="btn" id="today-btn">Сегодня</button>
        </div>

        <div id="month-view" style="display: block;">
            <div class="calendar-weekdays">
                <div class="weekday">Пн</div>
                <div class="weekday">Вт</div>
                <div class="weekday">Ср</div>
                <div class="weekday">Чт</div>
                <div class="weekday">Пт</div>
                <div class="weekday">Сб</div>
                <div class="weekday">Вс</div>
            </div>
            <div class="calendar-grid" id="calendar-grid">
                </div>
        </div>

        <div id="week-view" style="display: none;">
            <div class="week-view-container" id="week-view-container">
                </div>
        </div>
    </main>
    
  </main>
</div> 

<section class="habit-tracker mobile-section" id="mobileSectionHabits">
    <h2>✅ Трекер Привычек</h2>
    <div class="habit-controls">
        <input type="text" id="newHabitInput" placeholder="Введите новую привычку">
        <button id="addHabitBtn" class="btn">Добавить привычку</button>
        <button id="newDayBtn" class="btn create-week">Новый день</button>
    </div>
    <div class="habit-table-container" id="habitTableContainer">
        <div class="habit-table-wrapper">
            <table class="habit-table">
                <thead>
                    <tr id="habitHeaderRow">
                        <th>Дата</th>
                        <th class="progress-col">Прогресс дня</th>
                    </tr>
                </thead>
                <tbody id="habitBody">
                </tbody >
            </table>
        </div>
    </div>
    <button class="toggle-history-btn" id="toggleHabitHistoryBtn" style="display:none;">
        Показать всю историю
    </button>
</section>

<section class="mood-tracker mobile-section" id="mobileSectionMood">
    <h2>✨ Трекер Настроения</h2>
    <p style="text-align:center;">Как твой день?</p>
    <div class="mood-selection">
        <span class="mood-option" data-mood="bad" title="Плохо">😔</span>
        <span class="mood-option" data-mood="normal" title="Нормально">😐</span>
        <span class="mood-option" data-mood="great" title="Отлично">😄</span>
    </div>
    <div style="padding: 0 20px 15px 20px; display: flex; flex-direction: column; gap: 8px;">
        <label for="moodCommentInput" style="color: var(--text-secondary); font-weight: 600; font-size: 0.9em;">Комментарий к дню (сохраняется автоматом):</label>
        <textarea id="moodCommentInput" rows="3" placeholder="Хочешь добавить комментарий к этому дню?" style="width: 100%; background: var(--bg-tertiary); border: 1px solid var(--border-color); color: var(--text-primary); padding: 10px 12px; border-radius: 6px; font-size: 15px; font-family: inherit; resize: vertical;"></textarea>
    </div>

    <h3>История настроения</h3>
    <div class="mood-history-controls">
        <select id="moodMonthSelect" class="current-month-select"></select>
    </div>
    <div id="moodCalendar" class="mood-calendar">
        </div>
</section>

<div class="modal" id="profileModal">
    <div class="modal-content small-modal-content">
        <h2>Личный кабинет</h2>

        <div class="profile-section">
            <h3>Статистика задач</h3>
            <div class="profile-stats">
                <div>
                    <span>Выполнено:</span>
                    <strong id="completedTasksCount">0</strong>
                </div>
                <div>
                    <span>Осталось:</span>
                    <strong id="uncompletedTasksCount">0</strong>
                </div>
            </div>
        </div>

        <div class="profile-section">
            <h3>Имя пользователя (Ник)</h3>
            <div class="profile-input-group">
                <input type="text" id="nickInput" placeholder="Введите новый ник">
                <button id="saveNickBtn" class="btn btn-save-nick">Сохранить</button>
            </div>
        </div>
        <div class="profile-section">
            <h3>Ваша подписка</h3>
            <div class="subscription-container">
                <div id="subscriptionBadge" class="subscription-badge">
                    <span class="sub-icon">🌟</span>
                    <span id="subName">Free</span>
                </div>
                <a href="/tarifs" class="btn btn-tariffs">
                    💎 Посмотреть тарифы
                </a>
            </div>
        </div>
        <div class="profile-section">
            <h3>Управление аккаунтом</h3>
            <button id="deleteProfileBtn" class="btn btn-delete">
                <img src="pictures/trash.png" width="16" alt="Удалить">
                Удалить профиль и все данные
            </button>
            <button id="logoutBtn" class="btn btn-logout">
                <img src="pictures/logout.png" width="16" alt="Выход"> 
                Выйти из аккаунта
            </button>
        </div>

        <button class="btn" onclick="closeProfileModal()">Закрыть</button>
    </div>
</div>
<div class="modal" id="mood-comment-modal">
    <div class="modal-content small-modal-content">
        <div class="modal-header">
            <h2 id="mood-modal-date-display">Комментарий к дню</h2>
            <span id="close-mood-modal" class="close-mood-modal">×</span>
        </div>
        <div class="modal-body">
            <div style="text-align: center; font-size: 40px; margin-bottom: 15px;" id="mood-modal-emoji"></div>
            <div class="form-group">
                <label for="mood-modal-comment">Ваш комментарий:</label>
                <textarea id="mood-modal-comment" rows="5" class="form-control" placeholder="Здесь ваш комментарий..."></textarea>
            </div>
        </div>
        <div class="modal-footer" style="display: flex; justify-content: space-between;">
            <button type="button" class="btn" id="mood-modal-delete-btn" style="background: var(--danger-color); border-color: var(--danger-color);">Удалить комментарий</button>
            <div>
                <button type="button" class="btn close-mood-modal">Отмена</button>
                <button type="button" class="btn btn-primary" id="mood-modal-save-btn">Сохранить</button>
            </div>
        </div>
    </div>
</div>
<div class="modal" id="day-modal">
    <div class="modal-content" style="max-width: 600px;"> <div class="modal-header">
            <h2 id="modal-date-display"></h2>
            <span id="close-modal">×</span>
        </div>
        <div class="modal-body">
            <div id="modal-task-list">
                </div>
        </div>
        <div class="modal-footer">
            <form id="add-task-form-modal" action="javascript:void(0);">
                <input type="time" id="new-task-time" required>
                <input type="text" id="new-task-text" placeholder="Новая задача..." required>
                <button type="submit" class="btn btn-primary" id="add-task-btn" title="Добавить задачу">
                    <svg class="send-icon" viewBox="0 0 24 24">
                        <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path>
                    </svg>
                </button>
            </form>
        </div>
    </div>
</div>

<div class="modal" id="recur-modal">
    <div class="modal-content" style="max-width: 600px;"> <div class="modal-header">
            <h2>Настроить повторение задачи</h2>
            <span class="close-recur-modal">×</span>
        </div>
        <div class="modal-body">
            <form id="recur-form">
                <div class="form-group">
                    <label for="recur-type">Повторять:</label>
                    <select id="recur-type" class="form-control">
                        <option value="weekly">Раз в неделю</option>
                        <option value="monthly">Раз в месяц</option>
                        <option value="yearly">Раз в год</option>
                        <option value="custom">Свой вариант (дни)</option>
                    </select>
                </div>
                
                <div id="recur-weekly-options" class="recur-options">
                    <p>Выберите дни недели:</p>
                    <div class="weekday-picker" id="recur-weekly-days">
                        <label><input type="checkbox" value="1"> Пн</label>
                        <label><input type="checkbox" value="2"> Вт</label>
                        <label><input type="checkbox" value="3"> Ср</label>
                        <label><input type="checkbox" value="4"> Чт</label>
                        <label><input type="checkbox" value="5"> Пт</label>
                        <label><input type="checkbox" value="6"> Сб</label>
                        <label><input type="checkbox" value="0"> Вс</label>
                    </div>
                </div>

                <div id="recur-custom-options" class="recur-options" style="display: none;">
                    <label for="recur-custom-days">Повторять каждые (дней):</label>
                    <input type="number" id="recur-custom-days" class="form-control" value="2" min="1" max="30">
                </div>
                
                <div class="form-group" style="margin-top: 15px;">
                     <label for="recur-end-date">Дата окончания (необязательно):</label>
                     <input type="date" id="recur-end-date" class="form-control">
                </div>

            </form>
        </div>
        <div class="modal-footer">
             <button type="button" class="btn close-recur-modal">Отмена</button>
             <button type="button" class="btn btn-primary" id="save-recur-btn">Сохранить</button>
        </div>
    </div>
</div>
<div id="loadingOverlay">
    <div class="spinner"></div>
    <div>Пожалуйста, подождите...</div>
</div>

<div id="aiAdviceModalOverlay" class="advice-modal-overlay">
    <div id="aiAdviceModal" class="advice-modal-drawer">
        <div class="advice-drawer-header">
            <h2>🤖 AI Совет</h2>
            <button class="advice-drawer-close" onclick="closeAiAdviceModal()">&times;</button>
        </div>
        <div class="advice-drawer-content">
            <p id="aiAdviceText"></p>
        </div>
    </div>
</div>

<div id="aiButtonContainer">
    <button id="getAISuggestionBtn" class="btn">
        🤖 Получить AI совет
    </button>
</div>

<footer id="main-footer">
    <div id="particles-js"></div> 

    <div class="footer-content">
        <p>Time Owner: Станьте настоящим Владельцем своего времени, а не его заложником. <br>Платформа для организации, контроля и управления самым ценным ресурсом — вашей жизнью. <br>Достигайте целей, управляйте задачами и максимизируйте продуктивность с полным осознанием и контролем.</p>
    </div>
</footer>

<nav class="mobile-bottom-nav">
    <button class="mobile-nav-btn" id="mobileNavWeeks">
        <span class="icon">🗓️</span>
        <span class="label">Календарь</span> </button>
    <button class="mobile-nav-btn" id="mobileNavHabits">
        <span class="icon">✅</span>
        <span class="label">Привычки</span>
    </button>
    
    <div class="mobile-nav-center-btn-container">
        <button class="mobile-nav-center-btn" id="mobileNavMenuBtn">
            <div class="hamburger-icon">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </button>
    </div>
    
    <button class="mobile-nav-btn" id="mobileNavSave">
        <span class="icon">💾</span>
        <span class="label">Сохранить</span>
    </button>
    <button class="mobile-nav-btn" id="mobileNavProfile">
        <span class="icon">👤</span>
        <span class="label">Профиль</span>
    </button>
</nav>

<div class="mobile-menu-overlay" id="mobileMenuOverlay">
    <div class="mobile-menu-content">
        <button class="mobile-menu-btn" id="mobileMenuGoals">
            <span class="icon">🎯</span>
            <span class="label">Цели</span>
        </button>
        <button class="mobile-menu-btn" id="mobileMenuMood">
            <span class="icon">✨</span>
            <span class="label">Настроение</span>
        </button>
        <button class="mobile-menu-btn" id="mobileMenuKB">
            <span class="icon">🧠</span>
            <span class="label">База</span>
        </button>
        <button class="mobile-menu-btn" id="mobileMenuAI">
            <span class="icon">🤖</span>
            <span class="label">AI</span>
        </button>
        <button class="mobile-menu-btn" id="mobileMenuMedics">
            <span class="icon">💊</span>
            <span class="label">Лекарства</span>
        </button>
        <button class="mobile-menu-btn" id="mobileMenuLists">
            <span class="icon">📝</span>
            <span class="label">Списки</span>
        </button>
        <button class="mobile-menu-btn" id="mobileMenuScanner">
            <span class="icon">📸</span>
            <span class="label">Сканнер</span>
        </button>
    </div>
    </div>


<script>
// =================================================================
// 1. КОНСТАНТЫ И ПЕРЕМЕННЫЕ (Обновленные для Supabase)
// =================================================================

// --- КОНСТАНТЫ SUPABASE ---
const SUPABASE_URL = 'https://dgkozfxuhauemxrbjvno.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRna296Znh1aGF1ZW14cmJqdm5vIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAzOTgzMTcsImV4cCI6MjA3NTk3NDMxN30.kkRJs8IO1cQBnAZe-yBjQs2rXzR34ZV1emQqTG6UqVs';
let supabase = null; 
let currentUserId = null; // ДОБАВЛЕНО ДЛЯ КАЛЕНДАРЯ

// --- ОБЩИЕ КОНСТАНТЫ ---
const STORAGE_KEY_AUTH = 'plannerAuthDataKey'; 
const STORAGE_KEY_USERNAME = 'plannerUsername';
const STORAGE_KEY_LOCAL = 'plannerData_v9_local';
const STORAGE_KEY_UNSAVED = 'plannerUnsavedChanges';
// STORAGE_KEY_CONFIRM_DELETE удален

const MOOD_EMOJIS = { bad: '😔', normal: '😐', great: '😄' };

let notificationTimers = {}; 
let data = null; // Это для Goals, Habits, Mood
let pendingTaskChanges = []; // Очередь изменений задач для отправки на сервер
// dragId, dragTitle, dragOrigin, currentDayDrag удалены
let isUnsavedNotifShowing = false; // Флаг, что уведомление о сохранении уже показано
let currentUnsavedNotif = null;    // Ссылка на DOM-элемент этого уведомления

const saveAllBtn = document.getElementById('saveAllBtn');
const saveAllBtnText = document.getElementById('saveAllBtnText');
const accountControlBtn = document.getElementById('accountControl');
accountControlBtn.onclick = handleAccountControlClick;

const getAISuggestionBtn = document.getElementById('getAISuggestionBtn');
const aiAdviceModalOverlay = document.getElementById('aiAdviceModalOverlay');
const aiAdviceText = document.getElementById('aiAdviceText');

// --- Ссылки на корзину и модалку подтверждения удалены ---

const loadingOverlay = document.getElementById('loadingOverlay');
function showLoading() {
    loadingOverlay.style.display = 'flex';
    setTimeout(() => { loadingOverlay.style.opacity = '1'; }, 10);
}
function hideLoading() {
    loadingOverlay.style.opacity = '0';
    setTimeout(() => { loadingOverlay.style.display = 'none'; }, 300);
}

/* --- НОВАЯ ФУНКЦИЯ: Кастомные Уведомления --- */
function showNotification(message, type = 'warning', duration = 5000) {
    const container = document.getElementById('notification-container');
    if (!container) return;

    const notif = document.createElement('div');
    notif.className = `custom-notification ${type}`; // type: 'warning', 'success', 'error'
    
    const messageP = document.createElement('p');
    messageP.textContent = message;
    
    const closeBtn = document.createElement('button');
    closeBtn.className = 'close-btn';
    closeBtn.innerHTML = '&times;';
    
    notif.appendChild(messageP);
    notif.appendChild(closeBtn);
    container.appendChild(notif);

    setTimeout(() => {
        notif.classList.add('show');
    }, 10); 

    let timer = null;

    const removeNotif = () => {
        if (timer) clearTimeout(timer);
        notif.classList.remove('show');
        setTimeout(() => {
            if (notif.parentElement) {
                notif.parentElement.removeChild(notif);
            }
        }, 500); 
    };
    
    closeBtn.onclick = removeNotif;

    if (duration) {
        timer = setTimeout(removeNotif, duration);
    }
}
/* --- НОВАЯ ФУНКЦИЯ: Уведомление о Несохраненных Данных --- */
function showUnsavedDataNotification(message, type = 'warning') {
    // 1. Не показывать, если уже показано
    if (isUnsavedNotifShowing) return; 
    
    const container = document.getElementById('notification-container');
    if (!container) return;

    isUnsavedNotifShowing = true; // Устанавливаем флаг

    const notif = document.createElement('div');
    notif.className = `custom-notification ${type}`;
    
    // 2. Функция закрытия
    const removeNotif = () => {
        notif.classList.remove('show');
        setTimeout(() => {
            if (notif.parentElement) {
                notif.parentElement.removeChild(notif);
            }
            isUnsavedNotifShowing = false; // Сбрасываем флаг
            currentUnsavedNotif = null; // Очищаем ссылку
        }, 500); 
    };

    // 3. Создаем контент (сообщение + кнопка "Сохранить")
    const contentWrapper = document.createElement('div');
    // Стили, чтобы кнопка была под текстом
    contentWrapper.style.display = 'flex';
    contentWrapper.style.flexDirection = 'column';
    contentWrapper.style.gap = '10px';
    contentWrapper.style.alignItems = 'flex-start';
    contentWrapper.style.marginRight = '15px'; // Отступ от крестика

    const messageP = document.createElement('p');
    messageP.textContent = message;
    
    const saveBtn = document.createElement('button');
    saveBtn.className = 'btn btn-primary'; // Используем твои стили
    saveBtn.textContent = 'Сохранить';
    saveBtn.style.padding = '5px 10px'; // Делаем кнопку чуть компактнее
    saveBtn.style.fontSize = '14px';

    contentWrapper.appendChild(messageP);
    contentWrapper.appendChild(saveBtn);

    // 4. Создаем кнопку "Закрыть" (крестик)
    const closeBtn = document.createElement('button');
    closeBtn.className = 'close-btn';
    closeBtn.innerHTML = '&times;';
    
    // 5. Собираем уведомление
    notif.appendChild(contentWrapper);
    notif.appendChild(closeBtn);
    container.appendChild(notif);

    // 6. Сохраняем ссылку на уведомление
    currentUnsavedNotif = notif;

    // 7. Анимация появления
    setTimeout(() => {
        notif.classList.add('show');
    }, 10); 

    // 8. Назначаем действия кнопкам
    closeBtn.onclick = removeNotif; // Крестик просто закрывает

    saveBtn.onclick = async () => {
        saveBtn.textContent = 'Сохранение...';
        saveBtn.disabled = true;
        
        // Вызываем твою главную функцию сохранения
        const result = await saveDataToSupabase(); 
        
        // Если сохранение *не* удалось, восстанавливаем кнопку.
        // Если удалось, то `saveDataToSupabase` вызовет `setUnsaved(false)`,
        // и это уведомление закроется автоматически (см. Шаг 3).
        if (result.status !== 'success') {
            saveBtn.textContent = 'Сохранить';
            saveBtn.disabled = false;
        }
    };
    
    // 9. Таймер авто-закрытия (timer) здесь не создается,
    // поэтому уведомление не исчезнет само.
}

/* --- ФУНКЦИИ УПРАВЛЕНИЯ СОХРАНЕНИЕМ (Goals, Habits, Mood) --- */
function setUnsaved(isUnsaved) {
    const mobileSaveBtn = document.getElementById('mobileNavSave'); 

    if (isUnsaved) {
        localStorage.setItem(STORAGE_KEY_UNSAVED, 'true');
        saveAllBtn.classList.add('unsaved');
        document.getElementById('saveAllBtnText').textContent = 'Сохранить все (!)'; 
        if (mobileSaveBtn) mobileSaveBtn.classList.add('unsaved');
        
        // --- ДОБАВЛЕНО: Показываем наше новое уведомление ---
        showUnsavedDataNotification(
            'У вас есть несохраненные изменения', 
            'warning'
        );
        
    } else {
        localStorage.removeItem(STORAGE_KEY_UNSAVED);
        saveAllBtn.classList.remove('unsaved');
        document.getElementById('saveAllBtnText').textContent = 'Сохранить все';
        if (mobileSaveBtn) mobileSaveBtn.classList.remove('unsaved');
        
        // --- ДОБАВЛЕНО: Закрываем уведомление, если оно есть ---
        if (isUnsavedNotifShowing && currentUnsavedNotif) {
            currentUnsavedNotif.classList.remove('show');
            setTimeout(() => {
                if (currentUnsavedNotif && currentUnsavedNotif.parentElement) {
                    currentUnsavedNotif.parentElement.removeChild(currentUnsavedNotif);
                }
                isUnsavedNotifShowing = false;
                currentUnsavedNotif = null;
            }, 500);
        }
    }
}
function save() {
    if (!data) return;
    localStorage.setItem(STORAGE_KEY_LOCAL, JSON.stringify(data));
    setUnsaved(true);
}

// =================================================================
// 2. ФУНКЦИИ ВЗАИМОДЕЙСТВИЯ С SUPABASE (Goals, Habits, Mood)
// =================================================================
async function loadDataFromSupabase() {
    if (!supabase) { console.error("Supabase client not initialized."); return null; }
    const dataKey = localStorage.getItem(STORAGE_KEY_AUTH);
    if (!dataKey) { 
        window.location.href = 'login.html'; 
        return null; 
    }
    
    // --- ИЗМЕНЕНО: Добавлена очистка pendingTaskChanges при отмене ---
    if (localStorage.getItem(STORAGE_KEY_UNSAVED) === 'true') {
        if (!confirm("У вас есть несохраненные изменения (включая Задачи, Цели, Привычки). Загрузить данные с сервера и потерять локальные изменения? (Отмена - продолжить работу с локальными данными)")) {
            setUnsaved(true);
            try { return JSON.parse(localStorage.getItem(STORAGE_KEY_LOCAL)); } catch (e) { console.error("Ошибка парсинга локальных данных."); }
        } else {
            // Очищаем очередь, так как пользователь согласился потерять изменения
            pendingTaskChanges = []; 
        }
    }
    // --- Конец изменений ---
    
    showLoading();
    const { data: result, error } = await supabase
        .from('user_data')
        .select('data_json, subscription') // <--- ДОБАВИЛИ КОЛОНКУ
        .eq('data_key', dataKey)
        .single();
    hideLoading();
    if (error && error.code !== 'PGRST116') { 
        console.error("Ошибка Supabase при загрузке:", error);
        showNotification(`Ошибка загрузки: ${error.message}. Будут загружены пустые данные.`, 'error', 8000);
    }

    const loadedData = (result && result.data_json) 
        ? result.data_json 
        : {goals:[],habits:[],habitRecords:[], moodRecords:{}}; 

    // --- НОВЫЙ КОД: Сохраняем подписку в глобальный объект data ---
    // Данные приходят в формате jsonb: subscription: { "subscription": "free" }
    // Либо null, если поле пустое
    let userSub = 'free';
    if (result && result.subscription && result.subscription.subscription) {
        userSub = result.subscription.subscription;
    }
    loadedData.currentSubscription = userSub; // Сохраняем в память
    // ---------------------------------------------------------------

    if (!loadedData.goals) loadedData.goals = [];
    // ... дальше без изменений ...
    if (!loadedData.habits) loadedData.habits = [];
    if (!loadedData.habitRecords) loadedData.habitRecords = [];
    if (!loadedData.moodRecords) loadedData.moodRecords = {};

    setUnsaved(false);
    localStorage.setItem(STORAGE_KEY_LOCAL, JSON.stringify(loadedData));
    return loadedData;
}

async function saveDataToSupabase() {
    if (!supabase) { 
        console.error("Supabase client not initialized."); 
        return { status: "error", message: "Клиент не инициализирован." }; 
    }
    
    const dataKey = localStorage.getItem(STORAGE_KEY_AUTH);
    if (!dataKey) {
        showNotification("Ошибка авторизации. Пожалуйста, войдите в систему снова.", 'error');
        window.location.href = 'login.html';
        return { status: "error", message: "Нет ключа авторизации." };
    }
    
    showLoading();
    
    let goalsHabitsMoodError = null;
    let tasksError = null;
    
    // --- ЭТАП 1: Сохранение Целей, Привычек, Настроения (объект 'data') ---
    // (Только если 'data' вообще существует)
    if (data) {
        localStorage.setItem(STORAGE_KEY_LOCAL, JSON.stringify(data));
        
        const payload = {
            data_key: dataKey, 
            data_json: data, 
            created_at: new Date().toISOString() 
        };
        
        const { error } = await supabase
            .from('user_data')
            .upsert(payload, { onConflict: 'data_key' });
        
        goalsHabitsMoodError = error;
    }

    // --- ЭТАП 2: Сохранение Задач (очередь 'pendingTaskChanges') ---
    if (!goalsHabitsMoodError && pendingTaskChanges.length > 0) {
        // Мы будем обрабатывать очередь и очищать ее по мере выполнения
        // Копируем очередь, чтобы безопасно с ней работать
        const changesToProcess = [...pendingTaskChanges];

        try {
            // --- Сначала ОБЯЗАТЕЛЬНО обрабатываем ДОБАВЛЕНИЯ ('add') ---
            // чтобы получить настоящие ID для 'update'
            const addActions = changesToProcess.filter(c => c.action === 'add');
            if (addActions.length > 0) {
                
                const tasksToAdd = addActions.map(action => action.payload);
                const { data: addedTasks, error: addError } = await supabase
                    .from('daily_tasks')
                    .insert(tasksToAdd)
                    .select(); // Важно получить ответ
                    
                if (addError) {
                    throw new Error(`Ошибка добавления задач: ${addError.message}`);
                }
                
                // --- Синхронизация ID ---
                // Теперь нам нужно обновить наш локальный state.tasks
                // и очередь 'changesToProcess' новыми ID
                addedTasks.forEach((savedTask, index) => {
                    const tempId = addActions[index].tempId;
                    
                    // 1. Обновляем state.tasks
                    const localTask = state.tasks[savedTask.task_date].find(t => t.id === tempId);
                    if (localTask) {
                        localTask.id = savedTask.id; // <--- Главная замена ID
                        // Также можно обновить другие поля, если они отличаются
                        Object.assign(localTask, savedTask);
                    }
                    
                    // 2. Обновляем ID в оставшейся части очереди (для 'update')
                    changesToProcess.forEach(change => {
                        if (change.taskId === tempId) {
                            change.taskId = savedTask.id;
                        }
                    });
                });
            }

            // --- Затем обрабатываем ОБНОВЛЕНИЯ ('update') ---
            const updateActions = changesToProcess.filter(c => c.action === 'update');
            if (updateActions.length > 0) {
                // Мы должны отправить N запросов, т.к. 'upsert' может быть сложным
                for (const action of updateActions) {
                    // Убедимся, что ID не временный (на всякий случай)
                    if (action.taskId.toString().startsWith('temp-')) {
                         console.warn("Пропуск 'update', ID остался временным:", action.taskId);
                         continue;
                    }
                    
                    const { error: updateError } = await supabase
                        .from('daily_tasks')
                        .update(action.payload)
                        .eq('id', action.taskId);
                        
                    if (updateError) {
                         throw new Error(`Ошибка обновления задачи ${action.taskId}: ${updateError.message}`);
                    }
                }
            }
            
            // --- В конце обрабатываем УДАЛЕНИЯ ('delete') ---
            const deleteActions = changesToProcess.filter(c => c.action === 'delete');
            if (deleteActions.length > 0) {
                 const idsToDelete = deleteActions.map(action => {
                     // Убедимся, что ID не временный
                     if (!action.taskId.toString().startsWith('temp-')) {
                         return action.taskId;
                     }
                     return null;
                 }).filter(id => id !== null);

                 if(idsToDelete.length > 0) {
                    const { error: deleteError } = await supabase
                        .from('daily_tasks')
                        .delete()
                        .in('id', idsToDelete);
                        
                    if (deleteError) {
                         throw new Error(`Ошибка удаления задач: ${deleteError.message}`);
                    }
                 }
            }
            
            // Если все прошло успешно, очищаем ОРИГИНАЛЬНУЮ очередь
            pendingTaskChanges = [];

        } catch (error) {
            console.error("Ошибка при пакетном сохранении задач:", error);
            tasksError = error;
            // В случае ошибки мы НЕ очищаем pendingTaskChanges
            // Пользователь сможет попробовать "Сохранить" еще раз
        }
    }

    hideLoading();

    // --- ЭТАП 3: Результат ---
    if (goalsHabitsMoodError || tasksError) {
        const ghmErrorMsg = goalsHabitsMoodError ? `Цели/Привычки: ${goalsHabitsMoodError.message}. ` : '';
        const taskErrorMsg = tasksError ? `Задачи: ${tasksError.message}. ` : '';
        
        showNotification(`Ошибка сохранения. ${ghmErrorMsg}${taskErrorMsg}Данные сохранены локально. Попробуйте еще раз.`, 'error', 8000);
        return { status: "error", message: `${ghmErrorMsg}${taskErrorMsg}` };
// ... (код обработки ошибок) ...
    } else {
        setUnsaved(false); // <--- Снимаем флаг "не сохранено"
        showNotification('Все данные (Задачи, Цели, Привычки) успешно сохранены на сервер!', 'success', 5000);
        
        // --- ФИКС УДАЛЕНИЯ/ДУБЛИРОВАНИЯ ---
        
        // 1. Обновляем фон (календарь)
        render(); 
        
        // 2. Проверяем, открыта ли модалка дня
        if (dayModal.classList.contains('visible') && state.currentModalDate) {
            // Да, открыта. Нам НУЖНО принудительно перерисовать ее содержимое
            // новыми данными (с настоящими ID)
            const date = state.currentModalDate;
            modalTaskList.innerHTML = ''; // Очищаем
            
            const tasks = state.tasks[date] || [];
            if (tasks.length === 0) {
                modalTaskList.innerHTML = '<p class="no-tasks">Задач на этот день нет.</p>';
            } else {
                tasks.forEach(task => {
                    modalTaskList.appendChild(createTaskItemElement(task));
                });
            }
        }
        // --- КОНЕЦ ФИКСА ---
        
        return { status: "success" };
    }
}
saveAllBtn.onclick = saveDataToSupabase;

async function changeUsername(newNick) {
    localStorage.setItem(STORAGE_KEY_USERNAME, newNick);
    updateAuthButton();
    showNotification(`Имя пользователя успешно изменено на: ${newNick} (сохранено только локально)`, 'success');
    closeProfileModal();
    return { status: "success", newUsername: newNick };
}

async function deleteProfileAndData() {
    if (!supabase || !currentUserId) { 
        console.error("Supabase client or User ID not initialized."); 
        showNotification("Ошибка: Клиент не инициализирован.", 'error');
        return; 
    }
    
    const dataKey = localStorage.getItem(STORAGE_KEY_AUTH); // Ключ для user_data
    const currentUsername = localStorage.getItem(STORAGE_KEY_USERNAME);
    
    if (!dataKey) { 
        alert("Ошибка: нет ключа авторизации."); 
        return; 
    }
    
    if (!confirm("ВНИМАНИЕ! Вы уверены, что хотите УДАЛИТЬ ВСЕ данные и профиль? Это действие необратимо!")) { 
        return; 
    }
    
    const confirmText = prompt(`Для подтверждения удаления введите свой ник: ${currentUsername}`);
    if (confirmText !== currentUsername) { 
        alert("Введенный ник не совпадает. Удаление отменено."); 
        return; 
    }

    showLoading();

    // 1. Удаляем данные о целях/привычках (из user_data)
    const { error: dataError } = await supabase
        .from('user_data')
        .delete()
        .eq('data_key', dataKey); 

    // 2. Удаляем ВСЕ задачи календаря (из daily_tasks)
    const { error: tasksError } = await supabase
        .from('daily_tasks')
        .delete()
        .eq('user_id', currentUserId); // Используем ID пользователя

    hideLoading();

    if (dataError || tasksError) {
        console.error("Ошибка при удалении данных:", dataError || tasksError);
        showNotification(`Ошибка при удалении данных: ${ (dataError || tasksError).message}. Попробуйте еще раз.`, 'error', 8000);
        return; // Не выходим из системы, если данные не удалились
    }

    // 3. Выходим из системы (завершаем сессию Supabase)
    await supabase.auth.signOut();

    // 4. Очищаем ВЕСЬ localStorage (включая лекарства и т.д.)
    localStorage.removeItem(STORAGE_KEY_AUTH);
    localStorage.removeItem(STORAGE_KEY_USERNAME);
    localStorage.removeItem(STORAGE_KEY_LOCAL);
    localStorage.removeItem(STORAGE_KEY_UNSAVED);
    localStorage.removeItem('plannerMeds_v1_local');
    // (Если есть еще ключи, типа plannerLists, добавь их сюда)

    // 5. Сообщаем и перенаправляем
    alert("Ваш профиль и все связанные данные (цели, привычки, задачи) были успешно удалены.");
    window.location.href = 'login.html';
}


// =================================================================
// 3. ФУНКЦИИ ЛИЧНОГО КАБИНЕТА
// =================================================================

const usernameDisplay = document.getElementById('usernameDisplay');
const profileModal = document.getElementById('profileModal');
const nickInput = document.getElementById('nickInput');

function calculateTaskStats() {
    let completed = 0;
    let uncompleted = 0;

    // state.tasks - это глобальный объект, где лежат все задачи
    if (!state || !state.tasks) {
        console.warn("calculateTaskStats: state.tasks не найден.");
        return { completed: 0, uncompleted: 0 };
    }

    // Перебираем все ключи (даты) в объекте state.tasks
    for (const date in state.tasks) {
        
        // Проверяем, что по этому ключу действительно массив
        if (Array.isArray(state.tasks[date])) {
            
            // Перебираем каждую задачу в массиве
            state.tasks[date].forEach(task => {
                if (task.is_done) {
                    completed++;
                } else {
                    uncompleted++;
                }
            });
        }
    }
    
    return { completed, uncompleted };
}

function updateAuthButton() {
    const username = localStorage.getItem(STORAGE_KEY_USERNAME);
    usernameDisplay.textContent = username || 'Профиль';
}
function handleAccountControlClick() { openProfileModal(); }

function openProfileModal() {
    nickInput.value = localStorage.getItem(STORAGE_KEY_USERNAME) || '';
    
    // Считаем и отображаем статистику
    const stats = calculateTaskStats();
    const completedEl = document.getElementById('completedTasksCount');
    const uncompletedEl = document.getElementById('uncompletedTasksCount');
    
    if (completedEl) completedEl.textContent = stats.completed;
    if (uncompletedEl) uncompletedEl.textContent = stats.uncompleted;

    // --- НОВЫЙ КОД: ОТОБРАЖЕНИЕ ПОДПИСКИ ---
    const subBadge = document.getElementById('subscriptionBadge');
    const subName = document.getElementById('subName');
    
    // Получаем статус из loadedData (который мы сохранили в пункте А)
    // Если вдруг данных нет, считаем что 'free'
    const currentSub = (data && data.currentSubscription) ? data.currentSubscription : 'free';
    
    // Сбрасываем старые классы (оставляем только базовый)
    subBadge.className = 'subscription-badge';
    
    // Настраиваем вид в зависимости от тарифа
    if (currentSub === 'premium') {
        subBadge.classList.add('premium');
        subName.textContent = 'Premium';
    } else if (currentSub === 'premium_plus') {
        subBadge.classList.add('premium_plus');
        subName.textContent = 'Premium+';
    } else {
        // По умолчанию Free
        subBadge.classList.add('free');
        subName.textContent = 'Free Plan';
    }
    // ----------------------------------------
    
    profileModal.style.display='flex';
    setTimeout(()=>profileModal.classList.add('visible'), 10);
}

function closeProfileModal() {
    profileModal.classList.remove('visible');
    setTimeout(() => { profileModal.style.display='none'; }, 300);
}

// archiveAllMonths() удалена

document.getElementById('saveNickBtn').onclick = async () => {
    const newNick = nickInput.value.trim();
    if (!newNick) { 
        showNotification("Имя пользователя не может быть пустым.", 'warning'); 
        return; 
    }
    if (newNick === localStorage.getItem(STORAGE_KEY_USERNAME)) { closeProfileModal(); return; }
    await changeUsername(newNick); 
};
document.getElementById('logoutBtn').onclick = async () => {
    // --- ИЗМЕНЕНО: Обновлен текст confirm ---
    if (localStorage.getItem(STORAGE_KEY_UNSAVED) === 'true') {
        if (!confirm("У вас есть несохраненные изменения (Задачи, Цели, Привычки), которые не были отправлены на сервер. Вы уверены, что хотите выйти и потерять их?")) {
            return; 
        }
    }
    showLoading(); 
    
    if (supabase) {
        const { error } = await supabase.auth.signOut();
        if (error) {
            console.error("Ошибка при выходе из Supabase:", error);
            showNotification("Произошла ошибка при выходе. Пожалуйста, попробуйте еще раз.", 'error');
            hideLoading(); 
            return; 
        }
    }
    
    // --- ДОБАВЛЕНО: Очищаем локальную очередь при выходе ---
    pendingTaskChanges = []; 
    
    // Очищаем ВСЕ локальные ключи
    localStorage.removeItem(STORAGE_KEY_AUTH); 
    localStorage.removeItem(STORAGE_KEY_USERNAME); 
    localStorage.removeItem(STORAGE_KEY_LOCAL); 
    localStorage.removeItem(STORAGE_KEY_UNSAVED); 
    localStorage.removeItem('plannerMeds_v1_local'); 
    
    window.location.href = 'login.html';
};
document.getElementById('deleteProfileBtn').onclick = deleteProfileAndData;


// --- Функции корзины и старых недель удалены ---

/* --- ЦЕЛИ (Goal Styles) --- */
const goalsList=document.getElementById('goalsList');
function renderGoals(){
    goalsList.innerHTML='';
    data.goals.forEach((t,i)=>{
        const div=document.createElement('div'); div.className='goal'; div.contentEditable=true; div.innerText=t;
        div.addEventListener('input',()=> { data.goals[i] = div.innerText.replace(/×/g, '').trim(); save(); });
        const rm=document.createElement('span'); rm.className='goal-remove'; rm.innerText='×';
        rm.onclick=()=>{data.goals.splice(i,1); save(); renderGoals(); };
        div.appendChild(rm);
        goalsList.appendChild(div);
    });
}
document.getElementById('addGoalBtn').onclick=()=>{
    if (data.goals.length >= 3) {
        showNotification('Максимум 3 годовые цели.', 'warning', 5000);
        return; 
    }
    data.goals.push('Новая цель');
    save();
    renderGoals();
};

// --- Функции нераспределенных, месяцев, архива, модалки недели УДАЛЕНЫ ---


// =================================================================
// 4. НОВЫЙ БЛОК: ЛОГИКА КАЛЕНДАРЯ
// =================================================================

// --- ЭЛЕМЕНТЫ DOM КАЛЕНДАРЯ ---
const currentMonthDisplay = document.getElementById('current-month-display');
const calendarGrid = document.getElementById('calendar-grid');
const weekViewContainer = document.getElementById('week-view-container');
const prevBtn = document.getElementById('prev-btn');
const nextBtn = document.getElementById('next-btn');
const todayBtn = document.getElementById('today-btn');
const monthViewBtn = document.getElementById('month-view-btn');
const weekViewBtn = document.getElementById('week-view-btn');
const monthView = document.getElementById('month-view');
const weekView = document.getElementById('week-view');

const dayModal = document.getElementById('day-modal');
const closeModalBtn = document.getElementById('close-modal');
const modalDateDisplay = document.getElementById('modal-date-display');
const modalTaskList = document.getElementById('modal-task-list');
const addTaskFormModal = document.getElementById('add-task-form-modal');
const newTaskTimeInput = document.getElementById('new-task-time');
const newTaskTextInput = document.getElementById('new-task-text');

// --- ГЛОБАЛЬНОЕ СОСТОЯНИЕ КАЛЕНДАРЯ ---
let state = {
    tasks: {}, // { 'YYYY-MM-DD': [task1, task2] }
    currentDate: new Date(),
    currentView: 'month', // 'month' or 'week'
    currentModalDate: null, // 'YYYY-MM-DD'
    currentRecurTask: null
};
const monthNames = ['Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь', 'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'];
const dayNames = ['Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб', 'Вс'];

// --- ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ КАЛЕНДАРЯ ---

function getISODate(date) {
    const year = date.getFullYear();
    const month = (date.getMonth() + 1).toString().padStart(2, '0');
    const day = date.getDate().toString().padStart(2, '0');
    return `${year}-${month}-${day}`;
}

function getMonthDays(year, month) {
    const days = [];
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    
    let dayOfWeek = firstDay.getDay();
    if (dayOfWeek === 0) dayOfWeek = 7;
    
    const prevMonthLastDay = new Date(year, month, 0).getDate();
    for (let i = dayOfWeek - 1; i > 0; i--) {
        const date = new Date(year, month - 1, prevMonthLastDay - i + 1);
        days.push({ date: date, isCurrentMonth: false });
    }
    
    for (let i = 1; i <= lastDay.getDate(); i++) {
        const date = new Date(year, month, i);
        days.push({ date: date, isCurrentMonth: true });
    }
    
    const nextDays = 42 - days.length;
    for (let i = 1; i <= nextDays; i++) {
        const date = new Date(year, month + 1, i);
        days.push({ date: date, isCurrentMonth: false });
    }
    
    return days;
}

function getWeekDays(date) {
    const days = [];
    let dayOfWeek = date.getDay();
    if (dayOfWeek === 0) dayOfWeek = 7; // Вс = 7
    
    const monday = new Date(date);
    monday.setDate(date.getDate() - (dayOfWeek - 1));
    
    for (let i = 0; i < 7; i++) {
        const weekDay = new Date(monday);
        weekDay.setDate(monday.getDate() + i);
        days.push(weekDay);
    }
    return days;
}

// --- ЛОГИКА SUPABASE КАЛЕНДАРЯ ---

async function fetchTasks() {
    if (!supabase || !currentUserId) return;
    
    showLoading();
    const { data, error } = await supabase
        .from('daily_tasks')
        .select('*')
        .eq('user_id', currentUserId);
        
    hideLoading();
    
    if (error) {
        console.error("Ошибка загрузки задач:", error);
        return;
    }
    
    state.tasks = data.reduce((acc, task) => {
        const date = task.task_date;
        if (!acc[date]) {
            acc[date] = [];
        }
        acc[date].push(task);
        return acc;
    }, {});
    
    for (const date in state.tasks) {
        state.tasks[date].sort((a, b) => (a.time || '').localeCompare(b.time || ''));
    }
}
/* --- НОВАЯ ФУНКЦИЯ: Обработчик удаления задачи (UI) --- */
async function handleDeleteTask(taskId) {
    // 1. Просим подтверждение
    if (!confirm("Вы уверены, что хотите удалить эту задачу?")) {
        return; 
    }
    
    // 2. Находим текущую дату (предполагаем, что модалка открыта)
    const date = state.currentModalDate; 
    
    // 3. Вызываем core функцию, которая удаляет локально и добавляет в очередь
    const success = await deleteTask(taskId);
    
    if (success) {
        // 4. Удаляем элемент задачи из модального окна (UI)
        const taskItem = document.querySelector(`.task-item[data-id="${taskId}"]`);
        if (taskItem) {
            taskItem.remove();
        }

        // 5. Проверяем, остались ли задачи, и если нет, добавляем "Задач нет"
        if (date && state.tasks[date] && state.tasks[date].length === 0) {
             modalTaskList.innerHTML = '<p class="no-tasks">Задач на этот день нет.</p>';
        }
        
        // 6. Обновляем фон календаря (удаляем/обновляем цветную точку)
        render(); 
        
        // 7. Скрываем меню
        document.querySelectorAll('.task-item-menu.visible').forEach(m => m.classList.remove('visible'));
    } else {
         // Это сработает, если deleteTask вернул false
         console.error("Не удалось удалить задачу:", taskId);
         showNotification("Ошибка при локальном удалении задачи.", 'error');
    }
}
async function addTask(date, time, text) {
    if (!currentUserId) return null; // Проверка на всякий случай

    // 1. Создаем локальный объект задачи
    const tempId = `temp-${Date.now()}-${Math.random()}`;
    const localTask = {
        id: tempId, // Временный ID
        user_id: currentUserId,
        task_date: date,
        time: time,
        text: text,
        is_done: false,
        created_at: new Date().toISOString() // Добавляем, т.к. Supabase бы это сделал
    };

    // 2. Добавляем задачу в локальное состояние
    if (!state.tasks[date]) {
        state.tasks[date] = [];
    }
    state.tasks[date].push(localTask);
    state.tasks[date].sort((a, b) => (a.time || '').localeCompare(b.time || ''));

    // 3. Добавляем в очередь на "добавление"
    // Мы передаем 'localTask', чтобы сохранить все поля
    pendingTaskChanges.push({ 
        action: 'add', 
        tempId: tempId, // Сохраняем временный ID
        payload: { // Отправляем только то, что нужно Supabase
            user_id: currentUserId,
            task_date: date,
            time: time,
            text: text,
            is_done: false
        }
    });

    // 4. Помечаем, что есть несохраненные изменения
    setUnsaved(true);
    
    // 5. Возвращаем локальную задачу, чтобы UI мог ее отрисовать
    return localTask;
}

async function updateTaskStatus(taskId, isDone) {
    // 1. Находим задачу в локальном состоянии и обновляем ее
    let localTask = null;
    for (const date in state.tasks) {
        localTask = state.tasks[date].find(t => t.id === taskId);
        if (localTask) {
            localTask.is_done = isDone;
            break;
        }
    }

    if (!localTask) {
        console.error("Не удалось найти задачу для обновления в state.tasks:", taskId);
        return;
    }

    // 2. Добавляем в очередь на "обновление"
    
    // Сценарий 1: Это НОВАЯ, еще не сохраненная задача (ID временный)
    if (taskId.toString().startsWith('temp-')) {
        const addAction = pendingTaskChanges.find(c => c.action === 'add' && c.tempId === taskId);
        if (addAction) {
            // Просто обновляем 'is_done' в объекте, который будет добавлен
            addAction.payload.is_done = isDone;
        } else {
            console.error("Не найдено 'add' действие для временной задачи:", taskId);
        }
    } 
    // Сценарий 2: Это СТАРАЯ, уже существующая задача (ID настоящий)
    else {
        const existingChange = pendingTaskChanges.find(c => c.action === 'update' && c.taskId === taskId);
        if (existingChange) {
            // Если уже есть 'update' для этой задачи, обновляем его
            existingChange.payload.is_done = isDone;
        } else {
            // Если нет, добавляем новое 'update' действие
            pendingTaskChanges.push({
                action: 'update',
                taskId: taskId,
                payload: { is_done: isDone }
            });
        }
    }

    // 3. Помечаем, что есть несохраненные изменения
    setUnsaved(true);
}

async function deleteTask(taskId) {
    // 1. Удаляем задачу из локального состояния
    let taskFoundAndRemoved = false;
    for (const date in state.tasks) {
        const index = state.tasks[date].findIndex(t => t.id === taskId);
        if (index > -1) {
            state.tasks[date].splice(index, 1);
            taskFoundAndRemoved = true;
            break;
        }
    }

    if (!taskFoundAndRemoved) {
        console.error("Не удалось найти задачу для удаления в state.tasks:", taskId);
        return false; // Возвращаем false, как в оригинале
    }

    // 2. Добавляем в очередь на "удаление"

    // Сценарий 1: Это НОВАЯ, еще не сохраненная задача (ID временный)
    if (taskId.toString().startsWith('temp-')) {
        // Нам нужно просто удалить 'add' действие из очереди
        const index = pendingTaskChanges.findIndex(c => c.action === 'add' && c.tempId === taskId);
        if (index > -1) {
            pendingTaskChanges.splice(index, 1);
        }
        // Также удаляем любые 'update', связанные с ней (хотя их быть не должно)
        const updateIndex = pendingTaskChanges.findIndex(c => c.action === 'update' && c.taskId === taskId);
         if (updateIndex > -1) {
            pendingTaskChanges.splice(updateIndex, 1);
        }
    }
    // Сценарий 2: Это СТАРАЯ, уже существующая задача (ID настоящий)
    else {
        // Добавляем 'delete' действие
        // Убедимся, что нет дубликатов
        if (!pendingTaskChanges.some(c => c.action === 'delete' && c.taskId === taskId)) {
            pendingTaskChanges.push({
                action: 'delete',
                taskId: taskId
            });
        }
        // Если в очереди были 'update' для этой задачи, они больше не нужны
        pendingTaskChanges = pendingTaskChanges.filter(c => !(c.action === 'update' && c.taskId === taskId));
    }
    
    // 3. Помечаем, что есть несохраненные изменения
    setUnsaved(true);
    
    // 4. Возвращаем true, как в оригинале
    return true;
}

// --- ЛОГИКА РЕНДЕРИНГА КАЛЕНДАРЯ ---

function render() {
    const year = state.currentDate.getFullYear();
    const month = state.currentDate.getMonth();
    
    currentMonthDisplay.textContent = `${monthNames[month]} ${year}`;
    
    if (state.currentView === 'month') {
        renderMonthView(year, month);
        monthView.style.display = 'block';
        weekView.style.display = 'none';
        monthViewBtn.classList.add('active');
        weekViewBtn.classList.remove('active');
    } else {
        renderWeekView(state.currentDate);
        monthView.style.display = 'none';
        weekView.style.display = 'block';
        monthViewBtn.classList.remove('active');
        weekViewBtn.classList.add('active');
    }
}

function renderMonthView(year, month) {
    calendarGrid.innerHTML = '';
    const days = getMonthDays(year, month);
    const todayISO = getISODate(new Date());
    
    days.forEach(dayObj => {
        const dayEl = document.createElement('div');
        dayEl.className = 'calendar-day';
        const dateISO = getISODate(dayObj.date);
        
        if (!dayObj.isCurrentMonth) {
            dayEl.classList.add('other-month');
        }
        
        if (dateISO === todayISO) {
            dayEl.classList.add('today');
        }
        
        const dayNumber = document.createElement('div');
        dayNumber.className = 'day-number';
        dayNumber.textContent = dayObj.date.getDate();
        dayEl.appendChild(dayNumber);
        
        const tasks = state.tasks[dateISO] || [];
        if (tasks.length > 0) {
            const tasksPreview = document.createElement('div');
            tasksPreview.className = 'tasks-preview';
            
            tasks.slice(0, 5).forEach(task => { 
                const taskPill = document.createElement('div');
                taskPill.className = 'task-preview-item';
                if (task.is_done) {
                    taskPill.classList.add('done');
                }
                
                if (task.time) {
                    taskPill.innerHTML = `<span class="task-preview-time">${task.time.slice(0, 5)}</span>`;
                } else {
                    taskPill.innerHTML = `<span class="task-preview-time">•</span>`;
                }
                tasksPreview.appendChild(taskPill);
            });
            
            if (tasks.length > 5) {
                 const morePill = document.createElement('div');
                 morePill.className = 'task-preview-item';
                 morePill.textContent = `...`;
                 tasksPreview.appendChild(morePill);
            }
            
            dayEl.appendChild(tasksPreview);
        }
        
        if (dayObj.isCurrentMonth) {
            dayEl.onclick = () => openDayModal(dateISO);
        }
        
        calendarGrid.appendChild(dayEl);
    });
}

function renderWeekView(date) {
    weekViewContainer.innerHTML = '';
    const days = getWeekDays(date);
    const todayISO = getISODate(new Date());
    
    days.forEach((day, index) => {
        const dateISO = getISODate(day);
        const dayCol = document.createElement('div');
        dayCol.className = 'week-day-column';
        if (dateISO === todayISO) {
            dayCol.classList.add('today');
        }
        
        const dayHeader = document.createElement('div');
        dayHeader.className = 'week-day-header';
        dayHeader.innerHTML = `
            <h3>${dayNames[index]}</h3>
            <div class="date-display">${day.toLocaleDateString('ru-RU', { day: '2-digit', month: 'long' })}</div>
        `;
        dayCol.appendChild(dayHeader);
        
        const taskList = document.createElement('div');
        taskList.className = 'task-list-week';
        dayCol.appendChild(taskList);
        
        const tasks = state.tasks[dateISO] || [];
        if (tasks.length === 0) {
            taskList.innerHTML = '<p class="no-tasks">Задач нет.</p>';
        } else {
            tasks.forEach(task => {
                taskList.appendChild(createTaskItemElement(task));
            });
        }
        
        const addForm = document.createElement('form');
        addForm.className = 'add-task-form-week';
        addForm.action = "javascript:void(0);";
        addForm.innerHTML = `
            <div class="form-inputs-week">
                <input type="text" class="week-task-text" placeholder="Новая задача..." required>
                <input type="time" class="week-task-time" required>
            </div>
            <button type="submit" class="btn btn-primary" title="Добавить задачу">
                <svg class="send-icon" viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path></svg>
            </button>
        `;
        
        addForm.onsubmit = async (e) => {
            const timeInput = e.target.querySelector('.week-task-time');
            const textInput = e.target.querySelector('.week-task-text');
            
            const newTask = await addTask(dateISO, timeInput.value, textInput.value);
            if (newTask) {
                if (!state.tasks[dateISO]) state.tasks[dateISO] = [];
                state.tasks[dateISO].push(newTask);
                state.tasks[dateISO].sort((a, b) => (a.time || '').localeCompare(b.time || ''));
                
                timeInput.value = '';
                textInput.value = '';
                render(); 
            }
        };
        
        dayCol.appendChild(addForm);
        weekViewContainer.appendChild(dayCol);
    });
}

// --- ЛОГИКА МОДАЛЬНОГО ОКНА КАЛЕНДАРЯ ---

async function handleModalAddTask() {
    const time = newTaskTimeInput.value;
    const text = newTaskTextInput.value.trim();
    const date = state.currentModalDate;
    
    if (!text || !date) return;
    
    // 1. Добавляем задачу в локальное состояние (state.tasks)
    // Она добавляется и сразу сортируется внутри addTask
    const newTask = await addTask(date, time, text);
    
    if (newTask) {
        // 2. Очищаем поля ввода
        newTaskTimeInput.value = '';
        newTaskTextInput.value = '';
        
        // --- ФИНАЛЬНЫЙ ФИКС ДУБЛИРОВАНИЯ И СОРТИРОВКИ ---
        
        // 3. Полностью очищаем DOM-элемент списка задач в модалке
        // Это самый надежный способ избежать дублирования
        modalTaskList.innerHTML = ''; 
        
        // 4. Получаем актуальный (и отсортированный) список задач
        const tasks = state.tasks[date] || [];

        if (tasks.length === 0) {
            modalTaskList.innerHTML = '<p class="no-tasks">Задач на этот день нет.</p>';
        } else {
            // 5. Пересоздаем и добавляем ВСЕ элементы заново
            // Если в state.tasks всего 1 задача, она создастся только 1 раз.
            tasks.forEach(task => {
                modalTaskList.appendChild(createTaskItemElement(task));
            });
        }
        
        // 6. Обновляем фон (календарь) - это нужно только для цветной точки
        render(); 
        
        // --- КОНЕЦ ФИКСА ---
    }
}

function handleDownloadTask(task) {
    const content = `Задача: ${task.text}\nДата: ${task.task_date}\nВремя: ${task.time || 'Весь день'}\nСтатус: ${task.is_done ? 'Выполнено' : 'Не выполнено'}`;
    const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    const safeFileName = task.text.replace(/[^a-z0-9а-я\s]/gi, '_').substring(0, 30);
    a.download = `Задача_${safeFileName}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

function openRecurModal(task) {
    const modal = document.getElementById('recur-modal');
    state.currentRecurTask = task; 
    
    document.getElementById('recur-type').value = 'weekly';
    document.getElementById('recur-weekly-days').querySelectorAll('input').forEach(cb => cb.checked = false);
    document.getElementById('recur-custom-days').value = '2';
    document.getElementById('recur-end-date').value = '';

    document.getElementById('recur-weekly-options').style.display = 'block';
    document.getElementById('recur-custom-options').style.display = 'none';

    modal.style.display = 'flex';
    setTimeout(() => modal.classList.add('visible'), 10);
}


function createTaskItemElement(task) {
    const taskEl = document.createElement('div');
    taskEl.className = 'task-item';
    // Использование dataset.taskId - Правильно!
    taskEl.dataset.taskId = task.id; 
    if (task.is_done) {
        taskEl.classList.add('done');
    }
    
    const checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.className = 'task-item-checkbox';
    checkbox.checked = task.is_done;
    checkbox.onchange = async () => {
        const newStatus = checkbox.checked;
        await updateTaskStatus(task.id, newStatus);
        
        task.is_done = newStatus;
        taskEl.classList.toggle('done', newStatus);
        render(); // Обновляем индикацию на фоне
    };
    
    const timeEl = document.createElement('span');
    timeEl.className = 'task-item-time';
    timeEl.textContent = task.time ? task.time.slice(0, 5) : 'Весь день';
    
    const textEl = document.createElement('span');
    textEl.className = 'task-item-text';
    textEl.textContent = task.text;
    
    const moreBtn = document.createElement('button');
    moreBtn.className = 'task-item-more';
    moreBtn.innerHTML = '⋮'; 
    moreBtn.title = 'Опции';

    const menu = document.createElement('div');
    menu.className = 'task-item-menu';
    menu.innerHTML = `
        <div class="task-menu-item" data-action="delete">Удалить задачу</div>
        <div class="task-menu-item" data-action="download">Скачать (.txt)</div>
        <div class="task-menu-item" data-action="recur">Сделать регулярной</div>
    `;
    
    moreBtn.onclick = (e) => {
        e.stopPropagation();
        document.querySelectorAll('.task-item-menu.visible').forEach(m => {
            if (m !== menu) m.classList.remove('visible');
        });
        menu.classList.toggle('visible');
    };
    
    menu.onclick = (e) => {
        e.stopPropagation();
        const target = e.target.closest('.task-menu-item');
        if (!target) return;
        
        const action = target.dataset.action;
        
        if (action === 'delete') {
            // --- ИСПРАВЛЕНИЕ: Передаем ТОЛЬКО ID задачи ---
            handleDeleteTask(task.id); 
        }
        if (action === 'download') {
            handleDownloadTask(task);
        }
        if (action === 'recur') {
            openRecurModal(task);
        }
        
        menu.classList.remove('visible'); 
    };

    taskEl.appendChild(checkbox);
    taskEl.appendChild(timeEl);
    taskEl.appendChild(textEl);
    taskEl.appendChild(moreBtn); 
    taskEl.appendChild(menu); 
    
    return taskEl;
}

function openDayModal(dateISO) {
    state.currentModalDate = dateISO;
    const date = new Date(dateISO + 'T12:00:00'); 
    modalDateDisplay.textContent = date.toLocaleDateString('ru-RU', { day: '2-digit', month: 'long', year: 'numeric' });
    
    modalTaskList.innerHTML = '';
    const tasks = state.tasks[dateISO] || [];
    
    if (tasks.length === 0) {
        modalTaskList.innerHTML = '<p class="no-tasks">Задач на этот день нет.</p>';
    } else {
        tasks.forEach(task => {
            modalTaskList.appendChild(createTaskItemElement(task));
        });
    }
    
    dayModal.style.display = 'flex';
    setTimeout(() => dayModal.classList.add('visible'), 10);
}

function closeModal() {
    dayModal.classList.remove('visible');
    setTimeout(() => { dayModal.style.display = 'none'; }, 300);
    state.currentModalDate = null;
    newTaskTimeInput.value = '';
    newTaskTextInput.value = '';
}

async function handleModalAddTask() {
    const time = newTaskTimeInput.value;
    const text = newTaskTextInput.value.trim();
    const date = state.currentModalDate;
    
    if (!text || !date) return;
    
    const newTask = await addTask(date, time, text);
    
    if (newTask) {
        if (!state.tasks[date]) state.tasks[date] = [];
        state.tasks[date].push(newTask);
        state.tasks[date].sort((a, b) => (a.time || '').localeCompare(b.time || ''));
        
        newTaskTimeInput.value = '';
        newTaskTextInput.value = '';
        
        openDayModal(date);
        render();
    }
}
// =================================================================
// КОНЕЦ БЛОКА КАЛЕНДАРЯ
// =================================================================


/* --- ТРЕКЕР ПРИВЫЧЕК --- */
const newHabitInput = document.getElementById('newHabitInput');
const habitTableContainer = document.getElementById('habitTableContainer');
const toggleHabitHistoryBtn = document.getElementById('toggleHabitHistoryBtn');
let isHabitHistoryCollapsed = true;
function renderHabitTracker() {
    habitTableContainer.innerHTML = `<div class="habit-table-wrapper"><table class="habit-table"><thead><tr id="habitHeaderRow"><th>Дата</th></tr></thead><tbody id="habitBody"></tbody></table></div>`;
    const headerRow = document.getElementById('habitHeaderRow');
    const body = document.getElementById('habitBody');
    data.habits.forEach((habit, index) => {
        const th = document.createElement('th');
        const contentDiv = document.createElement('div');
        contentDiv.className = 'habit-header-content';
        const textSpan = document.createElement('span');
        textSpan.contentEditable = true;
        textSpan.innerText = habit;
        textSpan.addEventListener('blur', () => { data.habits[index] = textSpan.innerText.trim(); save(); });
        const removeBtn = document.createElement('span');
        removeBtn.innerText = '×';
        removeBtn.className = 'remove-habit';
        removeBtn.title = 'Удалить привычку';
        removeBtn.onclick = (e) => {
            e.stopPropagation();
            if (confirm(`Удалить привычку "${habit}"? Это действие необратимо.`)) {
                data.habits.splice(index, 1);
                data.habitRecords.forEach(record => {
                    if (record.tasks && record.tasks.hasOwnProperty(habit)) {
                        delete record.tasks[habit];
                    }
                });
                save();
                renderHabitTracker();
            }
        };
        contentDiv.appendChild(textSpan);
        contentDiv.appendChild(removeBtn);
        th.appendChild(contentDiv);
        headerRow.appendChild(th);
    });
    const progressTh = document.createElement('th');
    progressTh.className = 'progress-col';
    progressTh.innerText = 'Прогресс';
    headerRow.appendChild(progressTh);
    body.innerHTML = '';
    const recordsToShow = isHabitHistoryCollapsed ? data.habitRecords.slice(0, 7) : data.habitRecords;
    recordsToShow.forEach(record => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${new Date(record.date).toLocaleDateString('ru-RU', {day:'2-digit', month:'2-digit'})}</td>`;
        let completed = 0;
        data.habits.forEach(habit => {
            const td = document.createElement('td');
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.checked = !!(record.tasks && record.tasks[habit]);
            if(checkbox.checked) completed++;
            checkbox.onchange = () => {
                if(!record.tasks) record.tasks = {};
                record.tasks[habit] = checkbox.checked;
                save();
                renderHabitTracker();
            };
            td.appendChild(checkbox);
            tr.appendChild(td);
        });
        const percentage = data.habits.length > 0 ? (completed / data.habits.length) * 100 : 0;
        const progressTd = document.createElement('td');
        progressTd.innerHTML = `<div class="progress-bar-container"><div class="progress-bar" style="width: ${percentage}%;"></div><span class="progress-bar-text">${percentage.toFixed(0)}%</span></div>`;
        tr.appendChild(progressTd);
        body.appendChild(tr);
    });
    toggleHabitHistoryBtn.style.display = data.habitRecords.length > 7 ? 'block' : 'none';
    toggleHabitHistoryBtn.textContent = isHabitHistoryCollapsed ? 'Показать всю историю' : 'Свернуть историю';
    habitTableContainer.classList.toggle('collapsed', isHabitHistoryCollapsed && data.habitRecords.length > 7);
}
toggleHabitHistoryBtn.onclick = () => { isHabitHistoryCollapsed = !isHabitHistoryCollapsed; renderHabitTracker(); };
document.getElementById('addHabitBtn').onclick=()=>{
    const text=newHabitInput.value.trim();
    if(text && !data.habits.includes(text)){
        data.habits.push(text);
        newHabitInput.value='';
        save(); renderHabitTracker();
    }
};
document.getElementById('newDayBtn').onclick=()=>{
    const today=new Date().setHours(0,0,0,0);
    if(data.habitRecords.some(r=>new Date(r.date).setHours(0,0,0,0)===today)){
        showNotification('Запись за сегодня уже существует.', 'warning'); 
        return;
    }
    const newRecord={ date: new Date().toISOString(), tasks: {} };
    data.habits.forEach(h=>{newRecord.tasks[h]=false;});
    data.habitRecords.unshift(newRecord);
    save(); renderHabitTracker();
};

/* --- ТРЕКЕР НАСТРОЕНИЯ --- */
const moodMonthSelect = document.getElementById('moodMonthSelect');
const moodCalendar = document.getElementById('moodCalendar');
function getDayKey(date) { return `${date.getFullYear()}-${date.getMonth() + 1}-${date.getDate()}`; }
function updateMoodSelect() {
    const now = new Date();
    moodMonthSelect.innerHTML = '';
    const monthsLocale = ['Январь','Февраль','Март','Апрель','Май','Июнь','Июль','Август','Сентябрь','Октябрь','Ноябрь','Декабрь'];
    for (let i = 0; i < 12; i++) {
        const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
        const option = document.createElement('option');
        option.value = `${date.getFullYear()}-${date.getMonth()}`;
        option.textContent = `${monthsLocale[date.getMonth()]} ${date.getFullYear()}`;
        moodMonthSelect.appendChild(option);
    }
    moodMonthSelect.value = `${now.getFullYear()}-${now.getMonth()}`;
    moodMonthSelect.onchange = renderMoodCalendar;
}
function renderMoodCalendar() {
    moodCalendar.innerHTML = ''; // Очищаем старый календарь
    
    // Добавляем заголовки дней недели
    ['Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб', 'Вс'].forEach(day => { 
        const dayHeader = document.createElement('div');
        dayHeader.className = 'mood-calendar-day';
        dayHeader.textContent = day;
        moodCalendar.appendChild(dayHeader);
    });

    const [year, month] = moodMonthSelect.value.split('-').map(Number);
    const date = new Date(year, month, 1);
    
    // Добавляем пустые ячейки для дней до начала месяца
    let firstDay = date.getDay();
    if (firstDay === 0) firstDay = 7; // 0 (Вс) -> 7
    for (let i = 1; i < firstDay; i++) { 
        const emptyCell = document.createElement('div');
        emptyCell.className = 'mood-calendar-cell empty';
        moodCalendar.appendChild(emptyCell);
    }

    // Заполняем дни месяца
    while (date.getMonth() === month) {
        const dayKey = getDayKey(date);
        const record = data.moodRecords[dayKey];
        
        const cell = document.createElement('div');
        cell.className = 'mood-calendar-cell';
        
        const dayNumber = document.createElement('span');
        dayNumber.className = 'day-number';
        dayNumber.textContent = date.getDate();
        cell.appendChild(dayNumber);
        
        const dayMood = document.createElement('span');
        dayMood.className = 'day-mood';
        
        let moodEmoji = '';
        if (record?.mood) {
            moodEmoji = MOOD_EMOJIS[record.mood] || '';
        }
        if (record?.comment) {
            moodEmoji += ' 💬'; // Добавляем иконку, если есть коммент
        }
        dayMood.textContent = moodEmoji;
        cell.appendChild(dayMood);

        // Если для дня есть запись (настроение или коммент), делаем его кликабельным
        if (record) {
            cell.classList.add('has-data'); // Для CSS (cursor: pointer)
            cell.onclick = () => openMoodCommentModal(dayKey, record);
        }
        
        moodCalendar.appendChild(cell);
        date.setDate(date.getDate() + 1);
    }
}

// --- НОВЫЕ ФУНКЦИИ ДЛЯ МОДАЛКИ НАСТРОЕНИЯ ---

let currentMoodModalKey = null; // Для отслеживания, какой день открыт

function openMoodCommentModal(dayKey, record) {
    currentMoodModalKey = dayKey; // Сохраняем ключ дня
    
    const modal = document.getElementById('mood-comment-modal');
    if (!modal || !record) return;

    // Находим элементы
    const dateDisplay = document.getElementById('mood-modal-date-display');
    const emojiDisplay = document.getElementById('mood-modal-emoji');
    const commentTextarea = document.getElementById('mood-modal-comment');
    const saveBtn = document.getElementById('mood-modal-save-btn');
    const deleteBtn = document.getElementById('mood-modal-delete-btn');

    // 1. Заполняем данными
    // Преобразуем 'YYYY-MM-DD' в дату
    const dateParts = dayKey.split('-');
    const date = new Date(dateParts[0], dateParts[1] - 1, dateParts[2]);
    dateDisplay.textContent = date.toLocaleDateString('ru-RU', { day: '2-digit', month: 'long', year: 'numeric' });
    
    emojiDisplay.textContent = record.mood ? MOOD_EMOJIS[record.mood] : '😐'; // Показываем смайлик (или дефолтный)
    commentTextarea.value = record.comment || '';

    // 2. Назначаем действия кнопкам (сначала удаляем старые, чтобы не было дублей)
    saveBtn.onclick = null;
    saveBtn.onclick = () => {
        const newComment = commentTextarea.value.trim();
        const currentRecord = data.moodRecords[currentMoodModalKey]; // Получаем запись
        
        if (newComment) {
            currentRecord.comment = newComment;
        } else {
            currentRecord.comment = undefined; // Удаляем коммент, если поле пустое
        }
        
        // Проверяем, нужно ли удалить всю запись
        if (!currentRecord.mood && !currentRecord.comment) {
            delete data.moodRecords[currentMoodModalKey];
        }
        
        save();
        renderMoodCalendar();
        closeMoodCommentModal();
    };
    
    deleteBtn.onclick = null;
    deleteBtn.onclick = () => {
        const currentRecord = data.moodRecords[currentMoodModalKey];
        if(currentRecord) { // Проверяем, что запись еще существует
            currentRecord.comment = undefined; // Удаляем только коммент
        
            // Проверяем, нужно ли удалить всю запись
            if (!currentRecord.mood) {
                delete data.moodRecords[currentMoodModalKey];
            }
        }

        save();
        renderMoodCalendar();
        closeMoodCommentModal();
    };

    // 3. Показываем модалку
    modal.style.display = 'flex';
    setTimeout(() => modal.classList.add('visible'), 10);
}

function closeMoodCommentModal() {
    const modal = document.getElementById('mood-comment-modal');
    if (!modal) return;
    
    modal.classList.remove('visible');
    setTimeout(() => { modal.style.display = 'none'; }, 300);
    currentMoodModalKey = null; // Сбрасываем ключ
}

// --- КОНЕЦ НОВЫХ ФУНКЦИЙ ---

function updateMoodSelection() {
    const todayKey = getDayKey(new Date());
    const record = data.moodRecords[todayKey];
    const savedMood = record?.mood;
    const commentInput = document.getElementById('moodCommentInput');

    // 1. Обновляем смайлики (Фикс багов 1 и 2)
    document.querySelectorAll('.mood-option').forEach(el => {
        // Четко устанавливаем класс 'selected' только если data-mood совпадает
        if (savedMood === el.dataset.mood) {
            el.classList.add('selected');
        } else {
            el.classList.remove('selected');
        }

        // Переназначаем 'onclick', чтобы использовать новую логику
        el.onclick = () => {
            const clickedMood = el.dataset.mood;
            let currentRecord = data.moodRecords[todayKey] || {};

            // Если кликнули по уже выбранному смайлику
            if (currentRecord.mood === clickedMood) {
                currentRecord.mood = undefined; // Снимаем выбор
            } else { // Выбрали новый смайлик
                currentRecord.mood = clickedMood;
            }

            // Проверяем, остались ли в записи данные. Если нет - удаляем запись.
            if (!currentRecord.mood && !currentRecord.comment) {
                delete data.moodRecords[todayKey];
            } else {
                data.moodRecords[todayKey] = currentRecord;
            }

            save();
            updateMoodSelection(); // Повторно вызываем, чтобы обновить классы
            renderMoodCalendar(); // Обновляем календарь
        };
    });

    // 2. Обновляем поле комментария
    if (commentInput) {
        commentInput.value = record?.comment || '';
        
        // Удаляем старый листенер, чтобы не было дублей
        commentInput.oninput = null; 
        
        // Добавляем сохранение комментария при вводе
        commentInput.oninput = () => {
            let currentRecord = data.moodRecords[todayKey] || {};
            let commentText = commentInput.value.trim();
            
            if (commentText) {
                currentRecord.comment = commentText;
            } else {
                currentRecord.comment = undefined;
            }

            // Проверяем, остались ли в записи данные.
            if (!currentRecord.mood && !currentRecord.comment) {
                delete data.moodRecords[todayKey];
            } else {
                data.moodRecords[todayKey] = currentRecord;
            }
            
            save(); // Сохраняем при каждом вводе
        };
        
        // Дополнительно обновляем календарь (для иконки 💬) при потере фокуса
        commentInput.onblur = () => {
             renderMoodCalendar(); 
        };
    }
}

// =================================================================
// 5. AI ФУНКЦИОНАЛ
// =================================================================

function closeAiAdviceModal() {
    aiAdviceModalOverlay.classList.remove('visible');
    setTimeout(() => { aiAdviceModalOverlay.style.display = 'none'; }, 300);
}
aiAdviceModalOverlay.addEventListener('click', (e) => {
    if (e.target === aiAdviceModalOverlay) {
        closeAiAdviceModal();
    }
});
function openAiAdviceModal(suggestion) {
    let htmlSuggestion = suggestion;
    // ... (код форматирования Markdown) ...
    aiAdviceText.innerHTML = htmlSuggestion;
    aiAdviceModalOverlay.style.display = 'block';
    setTimeout(() => { aiAdviceModalOverlay.classList.add('visible'); }, 10);
}
function generateAIPrompt() {
    let prompt = "";
    // ... (код генерации промпта) ...
    return prompt;
}
async function callGeminiAPI(prompt) {
    showNotification("Для использования AI-совета требуется серверный прокси. Функционал временно недоступен.", 'warning', 7000);
    return { status: "error", message: "AI функционал требует серверного прокси." };
}
getAISuggestionBtn.onclick = async () => {
    const promptText = generateAIPrompt();
    const result = await callGeminiAPI(promptText);
    if (result.status === 'success' && result.suggestion) {
        openAiAdviceModal(result.suggestion);
    }
};

// =================================================================
// 6. ФУНКЦИИ УВЕДОМЛЕНИЙ (Notification API)
// =================================================================

// Функции уведомлений для старых недель удалены

function requestNotificationPermission() {
    if (!("Notification" in window)) {
        console.warn("Этот браузер не поддерживает Desktop Notifications.");
        return;
    }
    if (Notification.permission !== "granted" && Notification.permission !== "denied") {
        Notification.requestPermission().then(permission => {
            console.log("Разрешение на уведомления:", permission);
        });
    }
}

// =================================================================
// 7. ИНИЦИАЛИЗАЦИЯ
// =================================================================

function renderAll(){
    renderGoals();
    // renderUnassigned, renderMonths, renderArchive УДАЛЕНЫ
    renderHabitTracker();
    updateMoodSelect();
    renderMoodCalendar();
    updateMoodSelection(); 
}

function setupMobileNav() {
    // --- Секции ---
    const sectionGoals = document.getElementById('mobileSectionGoals');
    const sectionWeeks = document.getElementById('mobileSectionWeeks'); // Теперь это Календарь
    const sectionHabits = document.getElementById('mobileSectionHabits');
    const sectionMood = document.getElementById('mobileSectionMood');
    const allSections = [sectionGoals, sectionWeeks, sectionHabits, sectionMood];

    // --- Кнопки основной панели ---
    const mobileNavWeeks = document.getElementById('mobileNavWeeks');
    const mobileNavHabits = document.getElementById('mobileNavHabits');
    const mobileNavMenuBtn = document.getElementById('mobileNavMenuBtn');
    const mobileNavSave = document.getElementById('mobileNavSave');
    const mobileNavProfile = document.getElementById('mobileNavProfile');
    
    const allTabButtons = [mobileNavWeeks, mobileNavHabits]; 

    // --- Всплывающее меню ---
    const mobileMenuOverlay = document.getElementById('mobileMenuOverlay');
    const mobileMenuGoals = document.getElementById('mobileMenuGoals');
    const mobileMenuMood = document.getElementById('mobileMenuMood');
    const mobileMenuKB = document.getElementById('mobileMenuKB');
    const mobileMenuAI = document.getElementById('mobileMenuAI');
    const mobileMenuMedics = document.getElementById('mobileMenuMedics'); 

    // --- Функция показа секции ---
    const showMobileSection = (sectionToShow, buttonToActivate) => {
        allSections.forEach(sec => sec.classList.remove('active'));
        allTabButtons.forEach(btn => {
            if(btn) btn.classList.remove('active');
        });
        if (sectionToShow) sectionToShow.classList.add('active');
        if (buttonToActivate) buttonToActivate.classList.add('active');
    };

    // --- Функции всплывающего меню ---
    const openMobileMenuOverlay = () => {
        if (mobileMenuOverlay) mobileMenuOverlay.classList.add('visible');
        if (mobileNavMenuBtn) mobileNavMenuBtn.classList.add('is-open');
    };
    const closeMobileMenuOverlay = () => {
        if (mobileMenuOverlay) mobileMenuOverlay.classList.remove('visible');
        if (mobileNavMenuBtn) mobileNavMenuBtn.classList.remove('is-open');
    };

    // --- Назначение кликов для ОСНОВНОЙ ПАНЕЛИ ---
    if (mobileNavWeeks) mobileNavWeeks.onclick = () => showMobileSection(sectionWeeks, mobileNavWeeks);
    if (mobileNavHabits) mobileNavHabits.onclick = () => showMobileSection(sectionHabits, mobileNavHabits);
    
    if (mobileNavSave && saveAllBtn) mobileNavSave.onclick = () => saveAllBtn.click();
    if (mobileNavProfile && accountControlBtn) mobileNavProfile.onclick = () => accountControlBtn.click();

    if (mobileNavMenuBtn) mobileNavMenuBtn.onclick = () => {
        if (mobileMenuOverlay.classList.contains('visible')) {
            closeMobileMenuOverlay();
        } else {
            openMobileMenuOverlay();
        }
    };
    
    if (mobileMenuOverlay) mobileMenuOverlay.onclick = (e) => {
        if (e.target === mobileMenuOverlay) {
            closeMobileMenuOverlay();
        }
    };

    // --- Назначение кликов для ВСПЛЫВАЮЩЕГО МЕНЮ ---
    if (mobileMenuGoals) mobileMenuGoals.onclick = () => {
        showMobileSection(sectionGoals, null); 
        closeMobileMenuOverlay();
    };
    if (mobileMenuMood) mobileMenuMood.onclick = () => {
        showMobileSection(sectionMood, null); 
        closeMobileMenuOverlay();
    };
    if (mobileMenuKB) mobileMenuKB.onclick = () => {
        window.location.href = 'knowledge_base.html';
        closeMobileMenuOverlay();
    };mobileMenuAI
    if (mobileMenuAI) mobileMenuAI.onclick = () => {
        window.location.href = 'ai-chat.html';
        closeMobileMenuOverlay();
    };
    if (mobileMenuMedics) mobileMenuMedics.onclick = () => {
        window.location.href = 'meds.html';
        closeMobileMenuOverlay();
    };
    if (mobileMenuLists) mobileMenuLists.onclick = () => {
        window.location.href = 'lists.html';
        closeMobileMenuOverlay();
    };
    if (mobileMenuScanner) mobileMenuScanner.onclick = () => {
        window.location.href = 'scanner.html';
        closeMobileMenuOverlay();
    };

    // --- Показываем секцию по умолчанию при загрузке ---
    showMobileSection(sectionWeeks, mobileNavWeeks); // Календарь по умолчанию
}

async function init() {
    if (window.supabase) {
        supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    } else {
        console.error("Supabase library not found on window. Did the script load correctly?");
        document.body.innerHTML = '<h2 style="color: red; text-align: center; margin-top: 50px;">Ошибка: Не удалось загрузить библиотеку Supabase.</h2>';
        return;
    }

    const authKey = localStorage.getItem(STORAGE_KEY_AUTH);
    if (!authKey) { 
        window.location.href = 'login.html'; 
        return; 
    }

    // ОБНОВЛЕНО: Получаем ID пользователя при инициализации
    const { data: { user }, error: userError } = await supabase.auth.getUser();
    if (userError || !user) {
        console.error("Ошибка авторизации или пользователь не найден:", userError);
        window.location.href = 'login.html'; 
        return;
    }
    currentUserId = user.id; // Устанавливаем глобальную переменную

    updateAuthButton();
    
    // 1. Загружаем данные для Целей, Привычек, Настроения
    data = await loadDataFromSupabase();  
    if (data) {
        renderAll(); // Рендерим Цели, Привычки, Настроение
        requestNotificationPermission(); 
    } else {
        document.body.innerHTML = '<h2 style="color: red; text-align: center; margin-top: 50px;">Не удалось загрузить данные (Цели/Привычки). Попробуйте обновить страницу.</h2>';
        return; // Не продолжаем, если основные данные не загружены
    }
    
    // 2. Загружаем и рендерим Календарь
    await fetchTasks(); 
    render(); // Рендерим Календарь
    
    // 3. Устанавливаем слушатели Календаря
    prevBtn.onclick = () => {
        if (state.currentView === 'month') {
            state.currentDate.setMonth(state.currentDate.getMonth() - 1);
        } else {
            state.currentDate.setDate(state.currentDate.getDate() - 7);
        }
        render();
    };
    
    nextBtn.onclick = () => {
        if (state.currentView === 'month') {
            state.currentDate.setMonth(state.currentDate.getMonth() + 1);
        } else {
            state.currentDate.setDate(state.currentDate.getDate() + 7);
        }
        render();
    };
    
    todayBtn.onclick = () => {
        state.currentDate = new Date();
        render();
    };
    
    monthViewBtn.onclick = () => {
        state.currentView = 'month';
        render();
    };
    weekViewBtn.onclick = () => {
        state.currentView = 'week';
        render();
        
        // --- ДОБАВЛЕНО: Плавная прокрутка к сегодняшнему дню ---
        // Используем небольшую задержку, чтобы DOM 100% успел отрисоваться
        setTimeout(() => {
            const todayColumn = document.querySelector('.week-day-column.today');
            if (todayColumn) {
                // Плавная прокрутка, чтобы колонка оказалась по центру
                todayColumn.scrollIntoView({ 
                    behavior: 'smooth', 
                    inline: 'center', 
                    block: 'nearest' 
                });
            }
        }, 100); 
    };
    
    closeModalBtn.onclick = closeModal;
    dayModal.onclick = (e) => {
        if (e.target === dayModal) closeModal();
    };
    addTaskFormModal.onsubmit = handleModalAddTask;

    const recurModal = document.getElementById('recur-modal');
    const recurTypeSelect = document.getElementById('recur-type');
    const weeklyOptions = document.getElementById('recur-weekly-options');
    const customOptions = document.getElementById('recur-custom-options');
    
    recurTypeSelect.onchange = () => {
        const type = recurTypeSelect.value;
        weeklyOptions.style.display = (type === 'weekly') ? 'block' : 'none';
        customOptions.style.display = (type === 'custom') ? 'block' : 'none';
    };
    
    document.querySelectorAll('.close-recur-modal').forEach(btn => {
        btn.onclick = () => {
            recurModal.classList.remove('visible');
            setTimeout(() => { recurModal.style.display = 'none'; }, 300);
            state.currentRecurTask = null;
        };
    });
    
    document.getElementById('save-recur-btn').onclick = () => {
        if (!state.currentRecurTask) return;
        alert('Логика сохранения регулярной задачи еще не реализована.\nВыбранная задача: ' + state.currentRecurTask.text);
        document.querySelector('.close-recur-modal').click();
    };

    document.addEventListener('click', (e) => {
        if (!e.target.closest('.task-item-more') && !e.target.closest('.task-item-menu')) {
             document.querySelectorAll('.task-item-menu.visible').forEach(m => m.classList.remove('visible'));
        }
    });
    // --- ВСТАВИТЬ ВНУТРИ ФУНКЦИИ async function init() {} на index.html ---

    // -----------------------------------------------------------
    // ⬇️ НАЧАЛО: Код для импорта задач из AI-чата
    // -----------------------------------------------------------
    
    const CALENDAR_DATA_KEY = 'aiCalendarImport';
    const aiTasksToImportRaw = localStorage.getItem(CALENDAR_DATA_KEY);
    
    if (aiTasksToImportRaw) {
        let aiTasks = [];
        try {
            aiTasks = JSON.parse(aiTasksToImportRaw);
        } catch (e) {
            console.error("Ошибка парсинга AI-задач:", e);
            localStorage.removeItem(CALENDAR_DATA_KEY);
        }

        if (Array.isArray(aiTasks) && aiTasks.length > 0) {
            
            if (confirm(`🤖 AI-Чат предлагает добавить ${aiTasks.length} новых задач. \n\nХотите добавить их в календарь?`)) {
                
                showLoading(); // Предполагается, что у тебя есть эта функция
                let addedCount = 0;
                
                // Используем addTask с правильными ключами из JSON
                const addPromises = aiTasks.map(task => {
                    if (task.task_date && task.text) { // Используем task_date
                        addedCount++;
                        // addTask(date, time, text)
                        return addTask(task.task_date, task.time || '', task.text);
                    }
                    return Promise.resolve();
                });

                await Promise.all(addPromises);
                
                hideLoading(); // Предполагается, что у тебя есть эта функция
                
                render(); // Перерисовываем календарь
                
                showNotification(`Успешно добавлено ${addedCount} задач от AI.`, 'success', 7000); // Уведомление
                
                setUnsaved(true); // Указываем, что есть несохраненные изменения (если твоя функция addTask это не делает)

            } else {
                showNotification("Импорт задач от AI отменен.", 'warning');
            }
            
            // Очищаем ключ в любом случае
            localStorage.removeItem(CALENDAR_DATA_KEY);
        }
    }
}

document.addEventListener('DOMContentLoaded', () => {
    init();
    // --- Листенеры для НОВОЙ модалки настроения ---
    const moodModal = document.getElementById('mood-comment-modal');
    if (moodModal) {
        // Закрытие по клику на фон
        moodModal.onclick = (e) => {
            if (e.target === moodModal) {
                closeMoodCommentModal();
            }
        };
        // Закрытие по кнопкам "X" и "Отмена"
        moodModal.querySelectorAll('.close-mood-modal').forEach(btn => {
            btn.onclick = closeMoodCommentModal;
        });
    }
    setupMobileNav(); // Вызываем настройку навигации
});
</script>
<script src="js/footer.js"></script>

</body>
</html>
